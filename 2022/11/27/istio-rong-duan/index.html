<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="Istio 熔断, PHP,Java,Go,MySQL,Linux,Docker等"><meta name="description" content="PHP Java Go MySQL 后端开发"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>Istio 熔断 | 一代键客</title><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico"><link rel="stylesheet" href="/libs/awesome/css/all.css"><link rel="stylesheet" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" href="/libs/aos/aos.css"><link rel="stylesheet" href="/libs/animate/animate.min.css"><link rel="stylesheet" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="/css/matery.css"><link rel="stylesheet" href="/css/my.css"><script src="/libs/jquery/jquery.min.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><meta name="generator" content="Hexo 5.4.2"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/atom.xml" title="一代键客" type="application/atom+xml"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><div><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="/medias/log.png" class="logo-img" alt="LOGO"> <span class="logo-span">一代键客</span></div></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="/medias/log.png" class="logo-img circle responsive-img"><div class="logo-name">一代键客</div><div class="logo-desc">PHP Java Go MySQL 后端开发</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/dendi875" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i> Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/dendi875" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/featureimages/1.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">Istio 熔断</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/Istio/"><span class="chip bg-color">Istio</span></a> <a href="/tags/Kubernetes/"><span class="chip bg-color">Kubernetes</span></a> <a href="/tags/Service-Mesh/"><span class="chip bg-color">Service Mesh</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Istio/" class="post-category">Istio</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2022-11-27</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i> 更新日期:&nbsp;&nbsp; 2023-02-15</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 3.5k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i> 阅读时长:&nbsp;&nbsp; 17 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i> 阅读次数:&nbsp;&nbsp;<span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><link rel="stylesheet" href="/libs/prism/prism.css"><div class="card-content article-card-content"><div id="articleContent"><h2 id="熔断失败也是一种选择"><a class="markdownIt-Anchor" href="#熔断失败也是一种选择"></a> 熔断：失败也是一种选择</h2><p>在微服务架构中，服务用不同的语言编写，部署在多个节点或集群上，并且具有不同的响应时间或故障率。 通常，如果服务成功（并且及时）响应请求，则它的性能令人满意。 然而，情况往往并非如此，需要保护下游客户端免受上游服务过度缓慢的影响。 反过来，上游服务必须受到保护，以免因请求积压而过载。 对于多个客户端，这会变得更加复杂，并且可能导致整个基础架构出现一系列级联故障。 这个问题的解决方案是久经考验的断路器模式。</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/isitio-circuit-breaking-1.png" alt=""></p><p>断路器可以有三种状态：关闭、打开和半打开，默认情况下处于关闭状态。在关闭状态下，你请求服务一般情况下会返回成功或失败(低于阈值失败)。而当你的失败次数逐渐增多的时候，当次数达到阈值时（它有一个失败记数器来记录具体的失败次数），断路器打开。当调用处于打开状态的服务时，断路器会触发请求，这意味着它会返回错误（即快速失败）而不会把请求发送到被调用的服务方。这样，通过在客户端触发下游请求，可以防止生产系统中的级联故障。在这个状态时它会设置一个超时的时钟（Timeout），这个超时时钟主要目的就是设置一个时钟周期，超时这个周期的时候就会把状态切换为半打开状态，尝试的会去再调用一下服务，如果这时发现服务可以正常调用了，那么就直接返回成功，同时断路器将关闭允许服务再次处理请求。如果这个时候服务还有故障，那么就重新再返回到打开状态，请求继续快速失败。</p><p>总结：什么是熔断（Circuit Breaking）？</p><ul><li>一种过载保护的手段</li><li>目的：避免服务的级联失败</li><li>关键点：三个状态、失败计数器（阈值）、超时时钟</li></ul><h2 id="istio-中的熔断"><a class="markdownIt-Anchor" href="#istio-中的熔断"></a> Istio 中的熔断</h2><p>Istio 中的 <a target="_blank" rel="noopener" href="https://istio.io/latest/docs/tasks/traffic-management/circuit-breaking/">熔断</a> 可以在 <code>Destination Rule</code> Istio <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">自定义资源</a> 中的 <a target="_blank" rel="noopener" href="https://istio.io/docs/reference/config/networking/v1alpha3/destination-rule/#TrafficPolicy">TrafficPolicy</a> 字段中进行配置。 <code>TrafficPolicy</code>下有两个与熔路相关的字段：<a target="_blank" rel="noopener" href="https://istio.io/docs/reference/config/networking/v1alpha3/destination-rule/#ConnectionPoolSettings">ConnectionPoolSettings</a>and <a target="_blank" rel="noopener" href="https://istio.io/docs/reference/config/networking/v1alpha3/destination-rule/#OutlierDetection">OutlierDetection</a>。</p><p>在 <code>ConnectionPoolSettings</code> 中，可以为服务配置连接量。 <code>OutlierDetection</code> 用于控制从负载平衡池中驱逐不健康的服务。</p><p>例如：<code>ConnectionPoolSettings</code> 控制请求、挂起请求、重试或超时的最大数量，而 <code>OutlierDetection</code> 控制服务从连接池中弹出之前的错误数，并且可以设置最小弹出持续时间和最大弹出百分比。 有关字段的完整列表，请查看<a target="_blank" rel="noopener" href="https://istio.io/latest/docs/reference/config/networking/destination-rule/#TrafficPolicy">文档</a>。</p><h3 id="演示"><a class="markdownIt-Anchor" href="#演示"></a> 演示</h3><p>同样在 Istio 中也是原生就支持熔断功能的，下面我们来演示一下。</p><h4 id="开始之前"><a class="markdownIt-Anchor" href="#开始之前"></a> 开始之前</h4><ul><li><p>跟随<a target="_blank" rel="noopener" href="https://istio.io/latest/zh/docs/setup/">安装指南</a>安装 Istio。</p></li><li><p>启动 <a target="_blank" rel="noopener" href="https://github.com/istio/istio/tree/release-1.16/samples/httpbin">Httpbin</a> 样例程序。</p><p>如果您启用了 <a target="_blank" rel="noopener" href="https://istio.io/latest/zh/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection">Sidecar 自动注入</a>，通过以下命令部署 <code>httpbin</code> 服务：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl apply -f samples/httpbin/httpbin.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>否则，您必须在部署 <code>httpbin</code> 应用程序前进行手动注入，部署命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl apply -f <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject -f samples/httpbin/httpbin.yaml<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p>应用程序 <code>httpbin</code> 作为此任务的后端服务。</p><h4 id="配置熔断器"><a class="markdownIt-Anchor" href="#配置熔断器"></a> 配置熔断器</h4><ol><li><p>创建一个<a target="_blank" rel="noopener" href="https://istio.io/latest/zh/docs/reference/config/networking/destination-rule/">目标规则</a>，在调用 <code>httpbin</code> 服务时应用熔断设置：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl apply -f - <span class="token operator">&lt;&lt;</span><span class="token string">EOF
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: httpbin
spec:
  host: httpbin
  trafficPolicy:
    connectionPool: # 连接池
      tcp:
        maxConnections: 1 # 最大连接数
      http:
        http1MaxPendingRequests: 1  # 最大被阻挡的请求数
        maxRequestsPerConnection: 1 # 每个连接的最大请求数，每个连接同时只能有一个请求
    outlierDetection: # 失败探测配置
      consecutive5xxErrors: 1  # 失败次数，即断路器里的失败计数器，该配置表达只要有一次失败就触发熔断
      interval: 1s # 熔断的时间间隔
      baseEjectionTime: 3m # 最小驱逐时间, 驱逐时间会根据它乘上一个被驱逐的次数（熔断被触发次数），通过该方式实现一个指数级的退避策略
      maxEjectionPercent: 100 # 最大可被驱逐的比例， 也就是多少个服务实例可以被熔断驱逐出去
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>验证目标规则是否已创建：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># zhangquan @ MacBook-Pro-2 in ~/Downloads/devops/istio-1.5.1 [18:36:52] </span>
$  kubectl describe dr httpbin
Name:         httpbin
Namespace:    default
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  API Version:  networking.istio.io/v1beta1
Kind:         DestinationRule
Metadata:
  Creation Timestamp:  <span class="token number">2022</span>-11-27T10:36:46Z
  Generation:          <span class="token number">1</span>
  Resource Version:    <span class="token number">3505</span>
  Self Link:           /apis/networking.istio.io/v1beta1/namespaces/default/destinationrules/httpbin
  <span class="token environment constant">UID</span><span class="token builtin class-name">:</span>                 50d4f157-0085-423a-85f9-68cf85f33f7d
Spec:
  Host:  httpbin
  Traffic Policy:
    Connection Pool:
      Http:
        http1MaxPendingRequests:      <span class="token number">1</span>
        Max Requests Per Connection:  <span class="token number">1</span>
      Tcp:
        Max Connections:  <span class="token number">1</span>
    Outlier Detection:
      Base Ejection Time:    3m
      consecutive5xxErrors:  <span class="token number">1</span>
      Interval:              1s
      Max Ejection Percent:  <span class="token number">100</span>
Events:                      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h4 id="增加一个客户端"><a class="markdownIt-Anchor" href="#增加一个客户端"></a> 增加一个客户端</h4><p>创建客户端程序以发送流量到 <code>httpbin</code> 服务。这是一个名为 <a target="_blank" rel="noopener" href="https://github.com/istio/fortio">Fortio</a> 的负载测试客户端，它可以控制连接数、并发数及发送 HTTP 请求的延迟。通过 Fortio 能够有效的触发前面在 <code>DestinationRule</code> 中设置的熔断策略。</p><ol><li><p>向客户端注入 Istio Sidecar 代理，以便 Istio 对其网络交互进行管理：</p><p>如果你启用了<a target="_blank" rel="noopener" href="https://istio.io/latest/zh/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection">自动注入 Sidecar</a>，可以直接部署 <code>fortio</code> 应用：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl apply -f samples/httpbin/sample-client/fortio-deploy.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>否则，你需要在部署 <code>fortio</code> 应用前手动注入 Sidecar：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl apply -f <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject -f samples/httpbin/sample-client/fortio-deploy.yaml<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>验证部署成功：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get pods -l <span class="token assign-left variable">app</span><span class="token operator">=</span>fortio 
NAME                             READY   STATUS    RESTARTS   AGE
fortio-deploy-7cb865f87f-lk6jx   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          71s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>登入客户端 Pod 并使用 Fortio 工具调用 <code>httpbin</code> 服务。<code>-curl</code> 参数表明发送一次调用：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">FORTIO_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token operator">|</span> <span class="token function">grep</span> fortio <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{ print $1 }'</span><span class="token variable">)</span></span>

$ kubectl <span class="token builtin class-name">exec</span> -it <span class="token variable">$FORTIO_POD</span>  -c fortio -- /usr/bin/fortio load -curl  http://httpbin:8000/get
HTTP/1.1 <span class="token number">200</span> OK
server: envoy
date: Sun, <span class="token number">27</span> Nov <span class="token number">2022</span> <span class="token number">10</span>:15:51 GMT
content-type: application/json
content-length: <span class="token number">587</span>
access-control-allow-origin: *
access-control-allow-credentials: <span class="token boolean">true</span>
x-envoy-upstream-service-time: <span class="token number">7</span>

<span class="token punctuation">{</span>
  <span class="token string">"args"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>, 
  <span class="token string">"headers"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"Content-Length"</span><span class="token builtin class-name">:</span> <span class="token string">"0"</span>, 
    <span class="token string">"Host"</span><span class="token builtin class-name">:</span> <span class="token string">"httpbin:8000"</span>, 
    <span class="token string">"User-Agent"</span><span class="token builtin class-name">:</span> <span class="token string">"fortio.org/fortio-1.38.4"</span>, 
    <span class="token string">"X-B3-Parentspanid"</span><span class="token builtin class-name">:</span> <span class="token string">"f2d1740a0a9c85bb"</span>, 
    <span class="token string">"X-B3-Sampled"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span>, 
    <span class="token string">"X-B3-Spanid"</span><span class="token builtin class-name">:</span> <span class="token string">"d7dc042b175b9aeb"</span>, 
    <span class="token string">"X-B3-Traceid"</span><span class="token builtin class-name">:</span> <span class="token string">"58f24d400a95f78af2d1740a0a9c85bb"</span>, 
    <span class="token string">"X-Forwarded-Client-Cert"</span><span class="token builtin class-name">:</span> <span class="token string">"By=spiffe://cluster.local/ns/default/sa/httpbin;Hash=cab6dab828729dfc6921a588ee86cf324d8a991ccfce5c49a7e3a6cf05e73fe4;Subject=<span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\&quot;">\"</span>;URI=spiffe://cluster.local/ns/default/sa/default"</span>
  <span class="token punctuation">}</span>, 
  <span class="token string">"origin"</span><span class="token builtin class-name">:</span> <span class="token string">"127.0.0.1"</span>, 
  <span class="token string">"url"</span><span class="token builtin class-name">:</span> <span class="token string">"http://httpbin:8000/get"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到调用后端服务的请求已经成功！接下来，可以测试熔断。</p></li></ol><h4 id="触发熔断器"><a class="markdownIt-Anchor" href="#触发熔断器"></a> 触发熔断器</h4><p>在 <code>DestinationRule</code> 配置中，您定义了 <code>maxConnections: 1</code> 和 <code>http1MaxPendingRequests: 1</code>。这些规则意味着，如果并发的连接和请求数超过一个，在 <code>istio-proxy</code> 进行进一步的请求和连接时，后续请求或连接将被阻止。</p><ol><li><p>发送并发数为 2 的连接（<code>-c 2</code>），请求 20 次（<code>-n 20</code>）：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c fortio -- /usr/bin/fortio load -c <span class="token number">2</span> -qps <span class="token number">0</span> -n <span class="token number">20</span> -loglevel Warning http://httpbin:8000/get
<span class="token number">10</span>:42:13 I logger.go:13<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.38</span>.4 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">20</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">2</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">20</span> calls <span class="token punctuation">(</span><span class="token number">10</span> per thread + <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:13 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:13 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:13 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:13 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:13 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:13 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:13 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:13 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:13 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">40</span>.737598ms <span class="token builtin class-name">:</span> <span class="token number">20</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">490.95</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0037673228</span> +/- <span class="token number">0.003672</span> min <span class="token number">0.000209002</span> max <span class="token number">0.014810201</span> <span class="token function">sum</span> <span class="token number">0.075346455</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000209002</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000604501</span> , <span class="token number">35.00</span>, <span class="token number">7</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">40.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">55.00</span>, <span class="token number">3</span>
<span class="token operator">&gt;</span> <span class="token number">0.004</span> <span class="token operator">&lt;=</span> <span class="token number">0.005</span> , <span class="token number">0.0045</span> , <span class="token number">60.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.005</span> <span class="token operator">&lt;=</span> <span class="token number">0.006</span> , <span class="token number">0.0055</span> , <span class="token number">85.00</span>, <span class="token number">5</span>
<span class="token operator">&gt;</span> <span class="token number">0.006</span> <span class="token operator">&lt;=</span> <span class="token number">0.007</span> , <span class="token number">0.0065</span> , <span class="token number">90.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.009</span> <span class="token operator">&lt;=</span> <span class="token number">0.01</span> , <span class="token number">0.0095</span> , <span class="token number">95.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.014</span> <span class="token operator">&lt;=</span> <span class="token number">0.0148102</span> , <span class="token number">0.0144051</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.00266667</span>
<span class="token comment"># target 75% 0.0056</span>
<span class="token comment"># target 90% 0.007</span>
<span class="token comment"># target 99% 0.0146482</span>
<span class="token comment"># target 99.9% 0.014794</span>
Error cases <span class="token builtin class-name">:</span> count <span class="token number">9</span> avg <span class="token number">0.001515652</span> +/- <span class="token number">0.002773</span> min <span class="token number">0.000209002</span> max <span class="token number">0.009301589</span> <span class="token function">sum</span> <span class="token number">0.013640868</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000209002</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000604501</span> , <span class="token number">77.78</span>, <span class="token number">7</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">88.89</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.009</span> <span class="token operator">&lt;=</span> <span class="token number">0.00930159</span> , <span class="token number">0.00915079</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.000670418</span>
<span class="token comment"># target 75% 0.000967042</span>
<span class="token comment"># target 90% 0.00903016</span>
<span class="token comment"># target 99% 0.00927445</span>
<span class="token comment"># target 99.9% 0.00929887</span>
<span class="token comment"># Socket and IP used for each connection:</span>
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>   <span class="token number">7</span> socket used, resolved to <span class="token punctuation">[</span><span class="token number">10.108</span>.210.189:8000<span class="token punctuation">]</span> connection timing <span class="token builtin class-name">:</span> count <span class="token number">7</span> avg <span class="token number">0.00014323714</span> +/- <span class="token number">8</span>.516e-05 min <span class="token number">9</span>.1977e-05 max <span class="token number">0.000348143</span> <span class="token function">sum</span> <span class="token number">0.00100266</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>   <span class="token number">4</span> socket used, resolved to <span class="token punctuation">[</span><span class="token number">10.108</span>.210.189:8000<span class="token punctuation">]</span> connection timing <span class="token builtin class-name">:</span> count <span class="token number">4</span> avg <span class="token number">0.00018754275</span> +/- <span class="token number">4</span>.061e-05 min <span class="token number">0.000135404</span> max <span class="token number">0.00024686</span> <span class="token function">sum</span> <span class="token number">0.000750171</span>
Connection <span class="token function">time</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> count <span class="token number">11</span> avg <span class="token number">0.00015934827</span> +/- <span class="token number">7</span>.529e-05 min <span class="token number">9</span>.1977e-05 max <span class="token number">0.000348143</span> <span class="token function">sum</span> <span class="token number">0.001752831</span>
Sockets used: <span class="token number">11</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">2</span><span class="token punctuation">)</span>
Uniform: false, Jitter: <span class="token boolean">false</span>
IP addresses distribution:
<span class="token number">10.108</span>.210.189:8000: <span class="token number">11</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">11</span> <span class="token punctuation">(</span><span class="token number">55.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">9</span> <span class="token punctuation">(</span><span class="token number">45.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">126.55</span> +/- <span class="token number">114.5</span> min <span class="token number">0</span> max <span class="token number">231</span> <span class="token function">sum</span> <span class="token number">2531</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">557.85</span> +/- <span class="token number">286.6</span> min <span class="token number">241</span> max <span class="token number">818</span> <span class="token function">sum</span> <span class="token number">11157</span>
All <span class="token keyword">done</span> <span class="token number">20</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">3.767</span> ms avg, <span class="token number">490.9</span> qps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有可以看到大部分请求还是都完成了，但是并不是一半的请求失败，这是因为 <code>istio-proxy</code> 并不是100%准确的：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">11</span> <span class="token punctuation">(</span><span class="token number">55.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">9</span> <span class="token punctuation">(</span><span class="token number">45.0</span> %<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>将并发连接数提高到 3 个（3个并发执行30次）：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c fortio -- /usr/bin/fortio load -c <span class="token number">3</span> -qps <span class="token number">0</span> -n <span class="token number">30</span> -loglevel Warning http://httpbin:8000/get
<span class="token number">10</span>:42:34 I logger.go:13<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.38</span>.4 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">30</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">3</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">30</span> calls <span class="token punctuation">(</span><span class="token number">10</span> per thread + <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">10</span>:42:34 W http_client.go:93<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">35</span>.232481ms <span class="token builtin class-name">:</span> <span class="token number">30</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">851.49</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">30</span> avg <span class="token number">0.0030330515</span> +/- <span class="token number">0.003172</span> min <span class="token number">0.000291779</span> max <span class="token number">0.013781087</span> <span class="token function">sum</span> <span class="token number">0.090991546</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000291779</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.00064589</span> , <span class="token number">23.33</span>, <span class="token number">7</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">56.67</span>, <span class="token number">10</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">73.33</span>, <span class="token number">5</span>
<span class="token operator">&gt;</span> <span class="token number">0.003</span> <span class="token operator">&lt;=</span> <span class="token number">0.004</span> , <span class="token number">0.0035</span> , <span class="token number">76.67</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.004</span> <span class="token operator">&lt;=</span> <span class="token number">0.005</span> , <span class="token number">0.0045</span> , <span class="token number">80.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.005</span> <span class="token operator">&lt;=</span> <span class="token number">0.006</span> , <span class="token number">0.0055</span> , <span class="token number">90.00</span>, <span class="token number">3</span>
<span class="token operator">&gt;</span> <span class="token number">0.009</span> <span class="token operator">&lt;=</span> <span class="token number">0.01</span> , <span class="token number">0.0095</span> , <span class="token number">93.33</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.011</span> <span class="token operator">&lt;=</span> <span class="token number">0.012</span> , <span class="token number">0.0115</span> , <span class="token number">96.67</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.012</span> <span class="token operator">&lt;=</span> <span class="token number">0.0137811</span> , <span class="token number">0.0128905</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.0018</span>
<span class="token comment"># target 75% 0.0035</span>
<span class="token comment"># target 90% 0.006</span>
<span class="token comment"># target 99% 0.0132468</span>
<span class="token comment"># target 99.9% 0.0137277</span>
Error cases <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0014622678</span> +/- <span class="token number">0.0009196</span> min <span class="token number">0.000291779</span> max <span class="token number">0.004242896</span> <span class="token function">sum</span> <span class="token number">0.029245356</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000291779</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.00064589</span> , <span class="token number">35.00</span>, <span class="token number">7</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">85.00</span>, <span class="token number">10</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">95.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.004</span> <span class="token operator">&lt;=</span> <span class="token number">0.0042429</span> , <span class="token number">0.00412145</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.0013</span>
<span class="token comment"># target 75% 0.0018</span>
<span class="token comment"># target 90% 0.0025</span>
<span class="token comment"># target 99% 0.00419432</span>
<span class="token comment"># target 99.9% 0.00423804</span>
<span class="token comment"># Socket and IP used for each connection:</span>
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>   <span class="token number">8</span> socket used, resolved to <span class="token punctuation">[</span><span class="token number">10.108</span>.210.189:8000<span class="token punctuation">]</span> connection timing <span class="token builtin class-name">:</span> count <span class="token number">8</span> avg <span class="token number">0.00027488975</span> +/- <span class="token number">0.0003185</span> min <span class="token number">6</span>.8636e-05 max <span class="token number">0.001052815</span> <span class="token function">sum</span> <span class="token number">0.002199118</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>   <span class="token number">6</span> socket used, resolved to <span class="token punctuation">[</span><span class="token number">10.108</span>.210.189:8000<span class="token punctuation">]</span> connection timing <span class="token builtin class-name">:</span> count <span class="token number">6</span> avg <span class="token number">0.0002166175</span> +/- <span class="token number">0.0001668</span> min <span class="token number">7</span>.2906e-05 max <span class="token number">0.00056839</span> <span class="token function">sum</span> <span class="token number">0.001299705</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>   <span class="token number">9</span> socket used, resolved to <span class="token punctuation">[</span><span class="token number">10.108</span>.210.189:8000<span class="token punctuation">]</span> connection timing <span class="token builtin class-name">:</span> count <span class="token number">9</span> avg <span class="token number">0.00028147689</span> +/- <span class="token number">0.000415</span> min <span class="token number">5</span>.8022e-05 max <span class="token number">0.001432828</span> <span class="token function">sum</span> <span class="token number">0.002533292</span>
Connection <span class="token function">time</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> count <span class="token number">23</span> avg <span class="token number">0.00026226587</span> +/- <span class="token number">0.0003327</span> min <span class="token number">5</span>.8022e-05 max <span class="token number">0.001432828</span> <span class="token function">sum</span> <span class="token number">0.006032115</span>
Sockets used: <span class="token number">23</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">3</span><span class="token punctuation">)</span>
Uniform: false, Jitter: <span class="token boolean">false</span>
IP addresses distribution:
<span class="token number">10.108</span>.210.189:8000: <span class="token number">23</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">10</span> <span class="token punctuation">(</span><span class="token number">33.3</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">20</span> <span class="token punctuation">(</span><span class="token number">66.7</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">30</span> avg <span class="token number">76.666667</span> +/- <span class="token number">108.4</span> min <span class="token number">0</span> max <span class="token number">230</span> <span class="token function">sum</span> <span class="token number">2300</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">30</span> avg <span class="token number">433</span> +/- <span class="token number">271.5</span> min <span class="token number">241</span> max <span class="token number">817</span> <span class="token function">sum</span> <span class="token number">12990</span>
All <span class="token keyword">done</span> <span class="token number">30</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">3.033</span> ms avg, <span class="token number">851.5</span> qps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们可以看到大部分的请求都被熔断器拦截：</p><pre class="line-numbers language-none"><code class="language-none">Code 200 : 10 (33.3 %)
Code 503 : 20 (66.7 %)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>查询 <code>istio-proxy</code> 状态以了解更多熔断详情:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c istio-proxy -- pilot-agent request GET stats <span class="token operator">|</span> <span class="token function">grep</span> httpbin <span class="token operator">|</span> <span class="token function">grep</span> pending
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.default.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.high.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_active: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_failure_eject: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_overflow: <span class="token number">29</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_total: <span class="token number">28</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到 <code>upstream_rq_pending_overflow</code> 值 <code>29</code>，这意味着，目前为止已有 29 个调用被标记为熔断。</p></li></ol><h2 id="清理"><a class="markdownIt-Anchor" href="#清理"></a> 清理</h2><ol><li><p>清理规则:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl delete destinationrule httpbin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>下线 <a target="_blank" rel="noopener" href="https://github.com/istio/istio/tree/release-1.16/samples/httpbin">httpbin</a> 服务和客户端：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl delete -f samples/httpbin/sample-client/fortio-deploy.yaml
kubectl delete -f samples/httpbin/httpbin.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2><ul><li><a target="_blank" rel="noopener" href="https://istio.io/latest/zh/docs/tasks/traffic-management/circuit-breaking/">https://istio.io/latest/zh/docs/tasks/traffic-management/circuit-breaking/</a></li><li><a target="_blank" rel="noopener" href="https://banzaicloud.com/blog/istio-circuit-breaking/">https://banzaicloud.com/blog/istio-circuit-breaking/</a></li><li><a target="_blank" rel="noopener" href="https://istio.io/latest/docs/reference/config/networking/destination-rule/#TrafficPolicy">https://istio.io/latest/docs/reference/config/networking/destination-rule/#TrafficPolicy</a></li><li><a target="_blank" rel="noopener" href="https://istio.io/latest/zh/docs/ops/common-problems/network-issues/#service-unavailable-errors-after-setting-destination-rule">https://istio.io/latest/zh/docs/ops/common-problems/network-issues/#service-unavailable-errors-after-setting-destination-rule</a></li></ul></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">张权</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://www.zhangquan.me/2022/11/27/istio-rong-duan/">https://www.zhangquan.me/2022/11/27/istio-rong-duan/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">张权</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/Istio/"><span class="chip bg-color">Istio</span></a> <a href="/tags/Kubernetes/"><span class="chip bg-color">Kubernetes</span></a> <a href="/tags/Service-Mesh/"><span class="chip bg-color">Service Mesh</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/comment_bg.png) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="/libs/valine/av-min.js"></script><script src="https://unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"s8QEmTF1Slf32CctOSsFuvXe-gzGzoHsz",appKey:"sDkuaBSVzI8HdhP09aPoMjYV",notify:!1,verify:!1,visitor:!0,avatar:"monsterid",pageSize:"10",lang:"zh-cn",placeholder:"昵称填写qq可以显示qq头像和昵称哦~ ",enableQQ:!0,emojiCDN:"//i0.hdslb.com/bfs/emote/",emojiMaps:{tv_doge:"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_亲亲":"a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv_偷笑":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_再见":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_冷漠":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_发怒":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_发财":"34db290afd2963723c6eb3c4560667db7253a21a.png","tv_可爱":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_吐血":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_呆":"fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv_呕吐":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_困":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_坏笑":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_大佬":"093c1e2c490161aca397afc45573c877cdead616.png","tv_大哭":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_委屈":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_害羞":"a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv_尴尬":"7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv_微笑":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_思考":"90cf159733e558137ed20aa04d09964436f618a1.png","tv_惊吓":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png","tv_打脸":"56ab10b624063e966bfcb76ea5dc4794d87dfd47.png","tv_抓狂":"fe31c08edad661d63762b04e17b8d5ae3c71a757.png","tv_抠鼻":"c666f55e88d471e51bbd9fab9bb308110824a6eb.png","tv_斜眼笑":"911f987aa8bc1bee12d52aafe62bc41ef4474e6c.png","tv_无奈":"ea8ed89ee9878f2fece2dda0ea8a5dbfe21b5751.png","tv_晕":"5443c22b4d07fb1907ccc610c8e6db254f2461b7.png","tv_流汗":"cead1c351ab8d79e9f369605beb90148db0fbed3.png","tv_流泪":"7e71cde7858f0cd50d74b0264aa26db612a8a167.png","tv_流鼻血":"c32d39db2737f89b904ca32700d140a9241b0767.png","tv_点赞":"f85c354995bd99e28fc76c869bfe42ba6438eff4.png","tv_生气":"26702dcafdab5e8225b43ffd23c94ac1ff932654.png","tv_生病":"8b0ec90e6b86771092a498c54f09fc94621c1900.png","tv_疑问":"0793d949b18d7be716078349c202c15ff166f314.png","tv_白眼":"c1d59f439e379ee50eef488bcb5e5378e5044ea4.png","tv_皱眉":"72ccad6679fea0d14cce648b4d818e09b8ffea2d.png","tv_目瞪口呆":"0b8cb81a68de5d5365212c99375e7ace3e7891b7.png","tv_睡着":"8b196675b53af58264f383c50ad0945048290b33.png","tv_笑哭":"1abc628f6d4f4caf9d0e7800878f4697abbc8273.png","tv_腼腆":"89712c0d4af73e67f89e35cbc518420380a7f6f4.png","tv_色":"61822c7e9aae5da76475e7892534545336b23a6f.png","tv_调侃":"4bc022533ef31544ca0d72c12c808cf4a1cce3e3.png","tv_调皮":"b9c41de8e82dd7a8515ae5e3cb63e898bf245186.png","tv_鄙视":"6e72339f346a692a495b123174b49e4e8e781303.png","tv_闭嘴":"c9e990da7f6e93975e25fd8b70e2e290aa4086ef.png","tv_难过":"87f46748d3f142ebc6586ff58860d0e2fc8263ba.png","tv_馋":"fc7e829b845c43c623c8b490ee3602b7f0e76a31.png","tv_鬼脸":"0ffbbddf8a94d124ca2f54b360bbc04feb6bbfea.png","tv_黑人问号":"45821a01f51bc867da9edbaa2e070410819a95b2.png","tv_鼓掌":"1d21793f96ef4e6f48b23e53e3b9e42da833a0f6.png"},requiredFields:["nick","mail"]})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i> &nbsp;上一篇</div><div class="card"><a href="/2022/12/11/istio-gu-zhang-zhu-ru/"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/featureimages/20.jpg" class="responsive-img" alt="Istio 故障注入"> <span class="card-title">Istio 故障注入</span></div></a><div class="card-content article-content"><div class="summary block-with-text">Istio 故障注入</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2022-12-11</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Istio/" class="post-category">Istio</a></span></div></div><div class="card-action article-tags"><a href="/tags/Istio/"><span class="chip bg-color">Istio</span></a> <a href="/tags/Kubernetes/"><span class="chip bg-color">Kubernetes</span></a> <a href="/tags/Service-Mesh/"><span class="chip bg-color">Service Mesh</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/2022/11/20/istio-chao-shi-chong-shi-ti-sheng-xi-tong-de-jian-zhuang-xing-he-ke-yong-xing/"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/featureimages/10.jpg" class="responsive-img" alt="Istio 超时重试—提升系统的健壮性和可用性"> <span class="card-title">Istio 超时重试—提升系统的健壮性和可用性</span></div></a><div class="card-content article-content"><div class="summary block-with-text">Istio 超时重试—提升系统的健壮性和可用性</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2022-11-20</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Istio/" class="post-category">Istio</a></span></div></div><div class="card-action article-tags"><a href="/tags/Istio/"><span class="chip bg-color">Istio</span></a> <a href="/tags/Kubernetes/"><span class="chip bg-color">Kubernetes</span></a> <a href="/tags/Service-Mesh/"><span class="chip bg-color">Service Mesh</span></a></div></div></div></div></article></div><script src="/libs/codeBlock/codeBlockFuction.js"></script><script src="/libs/codeBlock/codeLang.js"></script><script src="/libs/codeBlock/codeCopy.js"></script><script src="/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["(",")"]]}})</script><footer class="page-footer bg-color"><link rel="stylesheet" href="/libs/aplayer/APlayer.min.css"><style>.aplayer .aplayer-lrc p{display:none;font-size:12px;font-weight:700;line-height:16px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{display:none;font-size:15px;color:#42b983}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div><div class="row"><meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="netease" type="playlist" id="503838841" fixed="true" autoplay theme="#42b983" loop order="random" preload="auto" volume="0.7" list-folded="true"></meting-js></div></div><script src="/libs/aplayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2021-2023</span> <a href="/about" target="_blank">张权</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">213.7k</span> <span id="busuanzi_container_site_pv">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span></span> <span id="busuanzi_container_site_uv">&nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span></span><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=new Date,t="2021",n=e.getFullYear(),i=e.getMonth()+1,a=e.getDate(),r=e.getHours(),m=e.getMinutes(),o=e.getSeconds(),g=Date.UTC(t,"6","28","0","0","0"),l=Date.UTC(n,i,a,r,m,o)-g,c=Math.floor(l/31536e6),d=Math.floor(l/864e5-365*c);if(t===String(n)){document.getElementById("year").innerHTML=n;var u;u="本站已运行 "+d+" 天",document.getElementById("sitetime").innerHTML=u}else{document.getElementById("year").innerHTML=t+" - "+n;var M;M="本站已运行 "+c+" 年 "+d+" 天",document.getElementById("sitetime").innerHTML=M}};calcSiteTime()</script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/dendi875" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i></a><a href="mailto:dendi875@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i></a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=943299849" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 943299849" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><script language="javascript">function siteTime(){window.setTimeout("siteTime()",1e3);var e=36e5,t=24*e,o=new Date,i=o.getFullYear(),a=o.getMonth()+1,n=o.getDate(),r=o.getHours(),l=o.getMinutes(),s=o.getSeconds(),M=Date.UTC(2021,11,9,0,0,0),g=Date.UTC(i,a,n,r,l,s)-M,m=Math.floor(g/31536e6),T=Math.floor(g/t-365*m),f=Math.floor((g-(365*m+T)*t)/e),h=Math.floor((g-(365*m+T)*t-f*e)/6e4),u=Math.floor((g-(365*m+T)*t-f*e-6e4*h)/1e3);document.getElementById("sitetime").innerHTML="本站已运行 "+m+" 年 "+T+" 天 "+f+" 小时 "+h+" 分钟 "+u+" 秒"}siteTime()</script><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script>$(function(){!function(t,e,r){"use strict";$.ajax({url:"/search.xml",dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),r=document.getElementById("searchInput"),n=document.getElementById("searchResult");r.addEventListener("input",function(){var f='<ul class="search-result-list">',m=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var r=!0,n=t.title.trim().toLowerCase(),a=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),e=t.url;e=0===e.indexOf("/")?t.url:"/"+e;var s=-1,i=-1,l=-1;if(""!==n&&""!==a&&m.forEach(function(t,e){s=n.indexOf(t),i=a.indexOf(t),s<0&&i<0?r=!1:(i<0&&(i=0),0===e&&(l=i))}),r){f+="<li><a href='"+e+"' class='search-result-title'>"+n+"</a>";var c=t.content.trim().replace(/<[^>]+>/g,"");if(0<=l){var u=l-20,o=l+80;u<0&&(u=0),0===u&&(o=100),o>c.length&&(o=c.length);var h=c.substr(u,o);m.forEach(function(t){var e=new RegExp(t,"gi");h=h.replace(e,'<em class="search-keyword">'+t+"</em>")}),f+='<p class="search-result">'+h+"...</p>"}f+="</li>"}}),f+="</ul>",n.innerHTML=f)})}})}()})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/libs/others/clicklove.js" async></script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script><script>var st,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="Σ(っ °Д °;)っ喔哟，崩溃啦！",clearTimeout(st)):(document.title="φ(゜▽゜*)♪咦，又好了！",st=setTimeout(function(){document.title=OriginTitile},3e3))})</script><style>[bg-lazy]{background-image:none!important;background-color:#eee!important}</style><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,c=(r.imageLazyLoadSetting.preloadRatio,n());function n(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=n());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e()},t.src!==a&&(n.src=a))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),r.addEventListener("resize",a),r.addEventListener("orientationchange",a)}(this)</script></body></html>