<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="Spring Boot 外部化配置 - 下篇, PHP,Java,Go,Python,Linux,Docker,Kubernetes等"><meta name="description" content="PHP Java Go Python 后端开发"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>Spring Boot 外部化配置 - 下篇 | 一代键客</title><link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico"><link rel="stylesheet" href="/libs/awesome/css/all.css"><link rel="stylesheet" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" href="/libs/aos/aos.css"><link rel="stylesheet" href="/libs/animate/animate.min.css"><link rel="stylesheet" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="/css/matery.css"><link rel="stylesheet" href="/css/my.css"><script src="/libs/jquery/jquery.min.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="一代键客" type="application/atom+xml"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><div><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="/medias/log.png" class="logo-img" alt="LOGO"> <span class="logo-span">一代键客</span></div></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="/medias/log.png" class="logo-img circle responsive-img"><div class="logo-name">一代键客</div><div class="logo-desc">PHP Java Go Python 后端开发</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/dendi875" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i> Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/dendi875" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/featureimages/21.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">Spring Boot 外部化配置 - 下篇</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/Java/"><span class="chip bg-color">Java</span></a> <a href="/tags/Spring-Boot/"><span class="chip bg-color">Spring Boot</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Spring-Boot/" class="post-category">Spring Boot</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2024-07-19</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i> 更新日期:&nbsp;&nbsp; 2024-07-19</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 4k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i> 阅读时长:&nbsp;&nbsp; 19 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i> 阅读次数:&nbsp;&nbsp;<span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><link rel="stylesheet" href="/libs/prism/prism.css"><div class="card-content article-card-content"><div id="articleContent"><h2 id="文章说明"><a href="#文章说明" class="headerlink" title="文章说明"></a>文章说明</h2><p>本系列会完整的介绍 Spring Boot 中外部化配置相关应用以及部分源码分析</p><ul><li>上篇 - 什么是外部化配置，外部化配置有哪些应用，顺序覆盖性</li><li>中篇 - 外部化配置 @Value 注入、Environment 抽象、@ConfigurationProperties、@ConditionalOnProperty 应用场景</li><li>下篇 - 如何扩展外部化配置，代码演示覆盖顺序</li></ul><blockquote><p>项目环境</p></blockquote><ul><li>jdk 1.8</li><li>Spring Boot 2.0.2.RELEASE</li><li>github 地址：<a target="_blank" rel="noopener" href="https://github.com/dendi875/spring-boot-study">https://github.com/dendi875/spring-boot-study</a><ul><li>本章模块：externalized-configuration</li></ul></li></ul><h2 id="1-扩展外部化配置"><a href="#1-扩展外部化配置" class="headerlink" title="1.扩展外部化配置"></a>1.扩展外部化配置</h2><ul><li>基于 SpringApplicationRunListener#environmentPrepared 扩展</li><li>基于 ApplicationEnvironmentPreparedEvent 扩展</li><li><p>基于 EnvironmentPostProcessor 扩展</p></li><li><p>基于 ApplicationContextInitializer 扩展</p></li><li>基于 SpringApplicationRunListener#contextPrepared 扩展</li><li>基于 SpringApplicationRunListener#contextLoaded扩展</li><li>基于 ApplicationPreparedEvent 扩展</li></ul><h2 id="2-如何扩展，在哪里扩展？"><a href="#2-如何扩展，在哪里扩展？" class="headerlink" title="2.如何扩展，在哪里扩展？"></a>2.如何扩展，在哪里扩展？</h2><h3 id="2-1-理解-Spring-Boot-Environment-生命周期"><a href="#2-1-理解-Spring-Boot-Environment-生命周期" class="headerlink" title="2.1 理解 Spring Boot  Environment 生命周期"></a>2.1 理解 Spring Boot Environment 生命周期</h3><blockquote><p>了解生命周期，可以知道 Environment 什么时候被创建，什么时候被使用，在创建和使用之间，正是我们扩展区间。</p></blockquote><p>一切从 <code>SpringApplication#run()</code> 方法开始</p><p>Environment 对象准备阶段 <code>SpringApplication#prepareEnvironment</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java">	<span class="token keyword">private</span> <span class="token class-name">ConfigurableEnvironment</span> <span class="token function">prepareEnvironment</span><span class="token punctuation">(</span>
			<span class="token class-name">SpringApplicationRunListeners</span> listeners<span class="token punctuation">,</span>
			<span class="token class-name">ApplicationArguments</span> applicationArguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Create and configure the environment</span>
		<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> <span class="token function">getOrCreateEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">configureEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">.</span><span class="token function">getSourceArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		listeners<span class="token punctuation">.</span><span class="token function">environmentPrepared</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">bindToSpringApplication</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationType <span class="token operator">==</span> <span class="token class-name">WebApplicationType</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			environment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnvironmentConverter</span><span class="token punctuation">(</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">convertToStandardEnvironmentIfNecessary</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">ConfigurationPropertySources</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> environment<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>getOrCreateEnvironment 来创建 Environment 对象。</p><p><strong>题外话 web 场景中创建的 StandardServletEnvironment 对象</strong></p><p><code>org.springframework.web.context.support.StandardServletEnvironment</code> 对应外部化配置覆盖顺序的 6 和 7 。</p><p>Environment 对象创建完成之后，后面有个 environmentPrepared 方法如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">environmentPrepared</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SpringApplicationRunListener</span> listener <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	listener<span class="token punctuation">.</span><span class="token function">environmentPrepared</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>循环遍历获取 SpringApplicationRunListener 的实现，并通过 environmentPrepared 发送一个ApplicationEnvironmentPreparedEvent 事件</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">environmentPrepared</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>initialMulticaster<span class="token punctuation">.</span><span class="token function">multicastEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationEnvironmentPreparedEvent</span><span class="token punctuation">(</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>application<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">,</span> environment<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当 Environment 对象在 Spring Boot 中创建好之后，在 <code>prepareContext</code> 中通过 <code>context.setEnvironment(environment);</code>设置当前上下文的 Environment，然后继续执行 <code>refreshContext(context);</code> ，此方法调用 Spring Freamwork 中 <code>AbstractApplicationContext.refresh()</code> 方法启动应用上下文。</p><p>最终在 AbstractApplicationContext#prepareBeanFactory 方法中，getEnvironment() 获取到 Environment 对象，并注册到容器中<br></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Register default environment beans.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span>ENVIRONMENT_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>ENVIRONMENT_BEAN_NAME<span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p></p><p>在 refresh() 方法的后续方法中，都有可能调用 Environment 对象，所以如果要进行扩展必须是在 AbstractApplicationContext#prepareBeanFactory 方法之前。</p><p><strong>结论：</strong></p><p>Spring Framework 中尽量在 org.springframework.context.support.AbstractApplicationContext#prepareBeanFactory 方法之前初始化。</p><p>Spring Boot 中尽量在 org.springframework.boot.SpringApplication#refreshContext 方法之前初始化。</p><h3 id="2-2-理解-PropertySource-顺序"><a href="#2-2-理解-PropertySource-顺序" class="headerlink" title="2.2 理解 PropertySource 顺序"></a>2.2 理解 <code>PropertySource</code> 顺序</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/2.2.2.RELEASE/reference/htmlsingle/#boot-features-external-config">Spring Boot 官网 Externalized Configuration</a></p><p>这里提出了 17 种配置源方式，前面优先级会高于后面，即相同属性覆盖后面的值</p><p>我们先测试顺序 2.<code>@TestPropertySource</code></p><p>在 test 目录下新建一个测试用例</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TestPropertySource</span><span class="token punctuation">(</span>properties <span class="token operator">=</span> <span class="token string">"user.id = 9"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PropertySourceOrderTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${user.id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user.id: "</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行结果：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">java.lang.AssertionError: 
Expected :9
Actual   :10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>我们取到的结果是 9 ，因为 @TestPropertySource 的优先级高于默认的 application.properties 。</p><p>我们再加入排名第 3 的 @SpringBootTest</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TestPropertySource</span><span class="token punctuation">(</span>properties <span class="token operator">=</span> <span class="token string">"user.id = 9"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>
		properties <span class="token operator">=</span> <span class="token string">"user.id = 10"</span><span class="token punctuation">,</span>
		classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">PropertySourceOrderTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		webEnvironment <span class="token operator">=</span> <span class="token class-name">SpringBootTest<span class="token punctuation">.</span>WebEnvironment</span><span class="token punctuation">.</span>NONE
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PropertySourceOrderTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${user.id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user.id: "</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行结果：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">java.lang.AssertionError: 
Expected :9
Actual   :10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以看到结果还是 9，表示 @SpringBootTest 中的属性并没有覆盖掉 @TestPropertySource 中的属性，符合预期。</p><p>接着我们注释掉 @TestPropertySource#properties 属性，同时增加一个 locations 属性，@TestPropertySource#locations 支持读取文件，我们将路径配置为 <code>classpath:META-INF/default.properties</code></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TestPropertySource</span><span class="token punctuation">(</span>
		<span class="token comment">//properties = "user.id = 9",</span>
		locations <span class="token operator">=</span> <span class="token string">"classpath:META-INF/default.properties"</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>
		properties <span class="token operator">=</span> <span class="token string">"user.id = 10"</span><span class="token punctuation">,</span>
		classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">PropertySourceOrderTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		webEnvironment <span class="token operator">=</span> <span class="token class-name">SpringBootTest<span class="token punctuation">.</span>WebEnvironment</span><span class="token punctuation">.</span>NONE
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PropertySourceOrderTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${user.id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user.id: "</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>default.properties 文件如下</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">user.id</span> <span class="token punctuation">=</span> <span class="token attr-value">1</span>
<span class="token attr-name">user.name</span> <span class="token punctuation">=</span> <span class="token attr-value">张三-properties</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>执行结果：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">user.id: <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>1 并没有覆盖掉 10，所以由结果可知，@SpringBootTest#properties 的优先级大于 @TestPropertySource#locations</p><p>通过上面的例子，我们可以知道三者的顺序如下</p><ol><li><p>@TestPropertySource#properties</p></li><li><p>@SpringBootTest#properties</p></li><li><p>@TestPropertySource#locations</p></li></ol><p>官网中漏掉了 @TestPropertySource#locations 这种情况，所以准确来说应该是 18 种；通过上面的例子我们大致知道了，外部化配置的属性源是按照这 18 种顺序来进行覆盖的。</p><h3 id="2-3-什么是-Environment-抽象？"><a href="#2-3-什么是-Environment-抽象？" class="headerlink" title="2.3 什么是 Environment 抽象？"></a>2.3 什么是 <code>Environment</code> 抽象？</h3><p><code>Environment</code> 与 <code>PropertySources</code> 是一对一的关系， <code>PropertySources</code> 与 <code>PropertySource</code> 是一对多的关系。</p><p>通过 <code>ConfigurableEnvironment#getPropertySources</code> 可以获取到 PropertySources 集合对象，然后遍历集合，可以获取到这个 Environment 中所有的 PropertySource 对象。</p><p>我们修改之前的测试类，通过 @Autowired 的方式注入 ConfigurableEnvironment 对象，再通过迭代的方式看看里面到底关联了哪些 PropertySources 属性源对象。</p><p>我们修改之前的测试类，通过 @Autowired 的方式注入 ConfigurableEnvironment 对象，再通过迭代的方式看看里面到底关联了哪些 PropertySources 属性源对象。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TestPropertySource</span><span class="token punctuation">(</span>
		<span class="token comment">//properties = "user.id = 9",</span>
		locations <span class="token operator">=</span> <span class="token string">"classpath:META-INF/default.properties"</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>
		properties <span class="token operator">=</span> <span class="token string">"user.id = 10"</span><span class="token punctuation">,</span>
		classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">PropertySourceOrderTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		webEnvironment <span class="token operator">=</span> <span class="token class-name">SpringBootTest<span class="token punctuation">.</span>WebEnvironment</span><span class="token punctuation">.</span>NONE
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PropertySourceOrderTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${user.id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user.id: "</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span>PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource <span class="token operator">:</span> propertySources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	i<span class="token operator">++</span><span class="token punctuation">;</span>
          	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"顺序[%d]-名称[%s]:[%s]\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> propertySource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> propertySource<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行结果：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">顺序<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>configurationProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ConfigurationPropertySourcesPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'configurationProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>Inlined Test Properties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'Inlined Test Properties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>class path resource <span class="token punctuation">[</span>META-INF/default.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>ResourcePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'class path resource [META-INF/default.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemEnvironment<span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginAwareSystemEnvironmentPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemEnvironment'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>random<span class="token punctuation">]</span>:<span class="token punctuation">[</span>RandomValuePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>applicationConfig: <span class="token punctuation">[</span>classpath:/application.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginTrackedMapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'applicationConfig: [classpath:/application.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>顺序[3]-名称[class path resource [META-INF/default.properties]] 就是我们配置的</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@TestPropertySource</span><span class="token punctuation">(</span>locations <span class="token operator">=</span> <span class="token string">"classpath:META-INF/default.properties"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>顺序[7]-名称[applicationConfig: [classpath:/application.properties]] 是 Spring Boot 默认读取的配置文件。</p><p>我们继续测试 <code>16.@PropertySource</code> 顺序</p><p>在 test 目录下新建 resouces/META-INF/test.properties</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">user.id</span> <span class="token punctuation">=</span> <span class="token attr-value">11</span>
<span class="token attr-name">user.name</span> <span class="token punctuation">=</span> <span class="token attr-value">张三-test</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>修改示例 增加 @PropertySource 相关的配置源</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TestPropertySource</span><span class="token punctuation">(</span>
		<span class="token comment">//properties = "user.id = 9",</span>
		locations <span class="token operator">=</span> <span class="token string">"classpath:META-INF/default.properties"</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>
		properties <span class="token operator">=</span> <span class="token string">"user.id = 10"</span><span class="token punctuation">,</span>
		classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">PropertySourceOrderTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">PropertySourceOrderTest<span class="token punctuation">.</span>MyConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		webEnvironment <span class="token operator">=</span> <span class="token class-name">SpringBootTest<span class="token punctuation">.</span>WebEnvironment</span><span class="token punctuation">.</span>NONE
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PropertySourceOrderTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${user.id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ConfigurableApplicationContext</span> applicationContext<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Configuration</span>
    <span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"test-propertySource"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"classpath:/META-INF/test.properties"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyConfig</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"user.id: "</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span>PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource <span class="token operator">:</span> propertySources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"顺序[%d]-名称[%s]:[%s]\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> propertySource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> propertySource<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMyConfigBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">MyConfig</span> bean <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">MyConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行测试用例 testPropertySources</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">顺序<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>configurationProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ConfigurationPropertySourcesPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'configurationProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>Inlined Test Properties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'Inlined Test Properties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>class path resource <span class="token punctuation">[</span>META-INF/default.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>ResourcePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'class path resource [META-INF/default.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemEnvironment<span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginAwareSystemEnvironmentPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemEnvironment'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>random<span class="token punctuation">]</span>:<span class="token punctuation">[</span>RandomValuePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>applicationConfig: <span class="token punctuation">[</span>classpath:/application.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginTrackedMapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'applicationConfig: [classpath:/application.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>test-propertySource<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ResourcePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'test-propertySource'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>结论：</strong></p><p>并不是每次都会加载所有的 18 种配置源信息，根据对应的场景进行加载。</p><h3 id="2-4-如何理解-PropertySource？"><a href="#2-4-如何理解-PropertySource？" class="headerlink" title="2.4 如何理解 PropertySource？"></a>2.4 如何理解 <code>PropertySource</code>？</h3><p>带有名称的属性源，<code>properties</code>、<code>map</code>、<code>yaml</code>文件。</p><h2 id="3-扩展"><a href="#3-扩展" class="headerlink" title="3.扩展"></a>3.扩展</h2><h3 id="3-1-基于-SpringApplicationRunListener-environmentPrepared-扩展"><a href="#3-1-基于-SpringApplicationRunListener-environmentPrepared-扩展" class="headerlink" title="3.1 基于 SpringApplicationRunListener#environmentPrepared 扩展"></a>3.1 基于 SpringApplicationRunListener#environmentPrepared 扩展</h3><p>需要使用 Spring 的 SPI 机制进行实现</p><p>实现 SpringApplicationRunListener，Ordered 接口</p><p>这里 Ordered 我们可以去默认实现中的 Order - 1，表示优先级比原来的实现高 1 位</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtendPropertySourceRunListener</span> <span class="token keyword">implements</span> <span class="token class-name">SpringApplicationRunListener</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SpringApplication</span> application<span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">ExtendPropertySourceRunListener</span><span class="token punctuation">(</span><span class="token class-name">SpringApplication</span> application<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>application <span class="token operator">=</span> application<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">starting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">environmentPrepared</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MapPropertySource</span> propertySource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapPropertySource</span><span class="token punctuation">(</span><span class="token string">"from-environmentPrepared"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>

		propertySources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextPrepared</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoaded</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">started</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">running</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventPublishingRunListener</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>resources/META-INF 目录下新建 spring.factories 文件</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># Run Listeners</span>
<span class="token attr-name">org.springframework.boot.SpringApplicationRunListener</span><span class="token punctuation">=</span><span class="token attr-value">\
com.zq.externalized.configuration.run.ExtendPropertySourceRunListener</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>新建引导类，这里我们加上其他三种属性源用来进行顺序覆盖的演示</p><ul><li>16.@PropertySource</li></ul><ul><li>17.Default properties</li><li>4.Command line arguments</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableAutoConfiguration</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"from classpath:META-INF/default.properties"</span><span class="token punctuation">,</span>value<span class="token operator">=</span><span class="token string">"classpath:META-INF/default.properties"</span><span class="token punctuation">)</span><span class="token comment">//16.@PropertySource</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtendPropertySourceBootstrap</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token class-name">ConfigurableApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token class-name">ExtendPropertySourceBootstrap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">web</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationType</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">profiles</span><span class="token punctuation">(</span><span class="token string">"user.id=99"</span><span class="token punctuation">)</span>	<span class="token comment">// 17. Default properties</span>
				<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"--user.id=100"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 4. Command line arguments.</span>

		<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户id: "</span> <span class="token operator">+</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span>PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource <span class="token operator">:</span> propertySources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"顺序[%d]-名称[%s]:[%s]\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> propertySource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> propertySource<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 关闭 Spring 应用上下文</span>
		applicationContext<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> args<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行结果：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">用户id: <span class="token number">5</span>
顺序<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>configurationProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ConfigurationPropertySourcesPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'configurationProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-environmentPrepared<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-environmentPrepared'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>commandLineArgs<span class="token punctuation">]</span>:<span class="token punctuation">[</span>SimpleCommandLinePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'commandLineArgs'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemEnvironment<span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginAwareSystemEnvironmentPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemEnvironment'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>random<span class="token punctuation">]</span>:<span class="token punctuation">[</span>RandomValuePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>applicationConfig: <span class="token punctuation">[</span>classpath:/application.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginTrackedMapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'applicationConfig: [classpath:/application.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from classpath:META-INF/default.properties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ResourcePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from classpath:META-INF/default.properties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>顺序[2]-名称[from-environmentPrepared] 是我们 <code>SpringApplicationRunListener#environmentPrepared</code> 扩展的属性源。</p><h3 id="3-2-基于-ApplicationEnvironmentPreparedEvent-扩展"><a href="#3-2-基于-ApplicationEnvironmentPreparedEvent-扩展" class="headerlink" title="3.2 基于 ApplicationEnvironmentPreparedEvent 扩展"></a>3.2 基于 ApplicationEnvironmentPreparedEvent 扩展</h3><p>因为 SpringApplicationRunListener 通过 environmentPrepared 发送一个 ApplicationEnvironmentPreparedEvent 事件，所以我们新建 ExtendPropertySourceApplicationListener 来监听 ApplicationEnvironmentPreparedEvent 事件。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtendPropertySourceApplicationListener</span> <span class="token keyword">implements</span> <span class="token class-name">SmartApplicationListener</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supportsEventType</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">ApplicationEnvironmentPreparedEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span> <span class="token operator">||</span>
				<span class="token class-name">ApplicationPreparedEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supportsSourceType</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> sourceType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationEnvironmentPreparedEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">ApplicationEnvironmentPreparedEvent</span> preparedEvent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationEnvironmentPreparedEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">;</span>
			<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> preparedEvent<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">MapPropertySource</span> propertySource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapPropertySource</span><span class="token punctuation">(</span><span class="token string">"from-ApplicationEnvironmentPreparedEvent"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>

			propertySources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationPreparedEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>resources/META-INF/spring.factories 文件新增对应的配置</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># Application Listeners</span>
<span class="token attr-name">org.springframework.context.ApplicationListener</span><span class="token punctuation">=</span><span class="token attr-value">\
com.zq.externalized.configuration.listener.ExtendPropertySourceApplicationListener</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>执行结果：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">用户id: <span class="token number">6</span>
顺序<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>configurationProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ConfigurationPropertySourcesPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'configurationProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-ApplicationEnvironmentPreparedEvent<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-ApplicationEnvironmentPreparedEvent'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-environmentPrepared<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-environmentPrepared'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>commandLineArgs<span class="token punctuation">]</span>:<span class="token punctuation">[</span>SimpleCommandLinePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'commandLineArgs'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemEnvironment<span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginAwareSystemEnvironmentPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemEnvironment'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>random<span class="token punctuation">]</span>:<span class="token punctuation">[</span>RandomValuePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>applicationConfig: <span class="token punctuation">[</span>classpath:/application.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginTrackedMapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'applicationConfig: [classpath:/application.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from classpath:META-INF/default.properties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ResourcePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from classpath:META-INF/default.properties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>顺序[2]-名称[from-ApplicationEnvironmentPreparedEvent] 是我们新增的监听，由于顺序高于之前 SpringApplicationRunListener#environmentPrepared 的配置，所以覆盖了 user.id 属性。</p><h3 id="3-3-基于-EnvironmentPostProcessor-扩展"><a href="#3-3-基于-EnvironmentPostProcessor-扩展" class="headerlink" title="3.3 基于 EnvironmentPostProcessor 扩展"></a>3.3 基于 EnvironmentPostProcessor 扩展</h3><p>在 ApplicationListener 的内建实现 ConfigFileApplicationListener 中， 当 ConfigFileApplicationListener 监听到 ApplicationEnvironmentPreparedEvent 事件时触发调用。</p><p>ConfigFileApplicationListener#onApplicationEnvironmentPreparedEvent，遍历所有的 EnvironmentPostProcessor 并执行 postProcessEnvironment 方法</p><ul><li><p>postProcessors.add(this); 表示 ConfigFileApplicationListener 本身也是一个 EnvironmentPostProcessor 的实现</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onApplicationEnvironmentPreparedEvent</span><span class="token punctuation">(</span>
		<span class="token class-name">ApplicationEnvironmentPreparedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EnvironmentPostProcessor</span><span class="token punctuation">&gt;</span></span> postProcessors <span class="token operator">=</span> <span class="token function">loadPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	postProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>postProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">EnvironmentPostProcessor</span> postProcessor <span class="token operator">:</span> postProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		postProcessor<span class="token punctuation">.</span><span class="token function">postProcessEnvironment</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				event<span class="token punctuation">.</span><span class="token function">getSpringApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>自定义 ExtendPropertySourcesEnvironmentPostProcessor 实现 EnvironmentPostProcessor，Ordered 接口</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtendPropertySourceEnvironmentPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">EnvironmentPostProcessor</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessEnvironment</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">,</span> <span class="token class-name">SpringApplication</span> application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MapPropertySource</span> propertySource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapPropertySource</span><span class="token punctuation">(</span><span class="token string">"from-EnvironmentPostProcessor"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
		propertySources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">ConfigFileApplicationListener</span><span class="token punctuation">.</span>DEFAULT_ORDER <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>resources/META-INF/spring.factories 文件新增对应的配置</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># Environment Post Processors</span>
<span class="token attr-name">org.springframework.boot.env.EnvironmentPostProcessor</span><span class="token punctuation">=</span><span class="token attr-value">\
com.zq.externalized.configuration.processor.ExtendPropertySourceEnvironmentPostProcessor</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>执行结果:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">用户id: <span class="token number">6</span>
顺序<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>configurationProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ConfigurationPropertySourcesPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'configurationProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-ApplicationEnvironmentPreparedEvent<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-ApplicationEnvironmentPreparedEvent'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-EnvironmentPostProcessor<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-EnvironmentPostProcessor'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-environmentPrepared<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-environmentPrepared'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>commandLineArgs<span class="token punctuation">]</span>:<span class="token punctuation">[</span>SimpleCommandLinePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'commandLineArgs'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemEnvironment<span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginAwareSystemEnvironmentPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemEnvironment'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>random<span class="token punctuation">]</span>:<span class="token punctuation">[</span>RandomValuePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>applicationConfig: <span class="token punctuation">[</span>classpath:/application.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginTrackedMapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'applicationConfig: [classpath:/application.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到顺序[3]-名称[from-EnvironmentPostProcessor] 在 顺序[2]-名称[from-ApplicationEnvironmentPreparedEvent] 后面，结果符合预期；因为 EnvironmentPostProcessor 在 ApplicationEnvironmentPreparedEvent 事件监听到之后才会执行。</p><h3 id="3-4-基于-ApplicationContextInitializer-扩展"><a href="#3-4-基于-ApplicationContextInitializer-扩展" class="headerlink" title="3.4 基于 ApplicationContextInitializer 扩展"></a>3.4 基于 ApplicationContextInitializer 扩展</h3><p>在 SpringApplication#run 启动方法中</p><p>org.springframework.boot.SpringApplication#run(java.lang.String…)</p><ul><li><p>org.springframework.boot.SpringApplication#prepareContext</p><ul><li><p>org.springframework.boot.SpringApplication#applyInitializers</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">applyInitializers</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationContextInitializer</span> initializer <span class="token operator">:</span> <span class="token function">getInitializers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> requiredType <span class="token operator">=</span> <span class="token class-name">GenericTypeResolver</span><span class="token punctuation">.</span><span class="token function">resolveTypeArgument</span><span class="token punctuation">(</span>
				initializer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationContextInitializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token string">"Unable to call initializer."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		initializer<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><p>此方法在 <code>refreshContext(context);</code> 之前进行调用，也就是 Spring Fremawrok 应用上下文启动之前，在此时也可以对 Environment 进行操作。</p><p>同样我们实现 ApplicationContextInitializer</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtendPropertySourceApplicationContextInitializer</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextInitializer</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">MapPropertySource</span> propertySource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapPropertySource</span><span class="token punctuation">(</span><span class="token string">"from-ApplicationContextInitializer"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
		propertySources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>resources/META-INF/spring.factories 文件新增对应的配置</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># Application Context Initializers</span>
<span class="token attr-name">org.springframework.context.ApplicationContextInitializer</span><span class="token punctuation">=</span><span class="token attr-value">\
com.zq.externalized.configuration.initializer.ExtendPropertySourceApplicationContextInitializer</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>执行结果：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">用户id: <span class="token number">25</span>
顺序<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-ApplicationContextInitializer<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-ApplicationContextInitializer'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>configurationProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ConfigurationPropertySourcesPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'configurationProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-ApplicationEnvironmentPreparedEvent<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-ApplicationEnvironmentPreparedEvent'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-EnvironmentPostProcessor<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-EnvironmentPostProcessor'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-environmentPrepared<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-environmentPrepared'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>commandLineArgs<span class="token punctuation">]</span>:<span class="token punctuation">[</span>SimpleCommandLinePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'commandLineArgs'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemEnvironment<span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginAwareSystemEnvironmentPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemEnvironment'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>random<span class="token punctuation">]</span>:<span class="token punctuation">[</span>RandomValuePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>applicationConfig: <span class="token punctuation">[</span>classpath:/application.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginTrackedMapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'applicationConfig: [classpath:/application.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from classpath:META-INF/default.properties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ResourcePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from classpath:META-INF/default.properties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>顺序[1]-名称[from-ApplicationContextInitializer] 就是我们新加入的 ExtendPropertySourcesInitializer</p><h3 id="3-5-基于-SpringApplicationRunListener-contextPrepared-amp-contextLoaded-扩展"><a href="#3-5-基于-SpringApplicationRunListener-contextPrepared-amp-contextLoaded-扩展" class="headerlink" title="3.5 基于 SpringApplicationRunListener#contextPrepared &amp;contextLoaded 扩展"></a>3.5 基于 SpringApplicationRunListener#contextPrepared &amp;contextLoaded 扩展</h3><p>这两个方法都在 SpringApplicationRunListener 中，所以我们可以写在一起</p><p>修改 3.1 中的例子 ExtendPropertySourceRunListener 的这两个方法即可</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtendPropertySourceRunListener</span> <span class="token keyword">implements</span> <span class="token class-name">SpringApplicationRunListener</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SpringApplication</span> application<span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">ExtendPropertySourceRunListener</span><span class="token punctuation">(</span><span class="token class-name">SpringApplication</span> application<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>application <span class="token operator">=</span> application<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">starting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">environmentPrepared</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MapPropertySource</span> propertySource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapPropertySource</span><span class="token punctuation">(</span><span class="token string">"from-SpringApplicationRunListener#environmentPrepared"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>

		propertySources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextPrepared</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MapPropertySource</span> propertySource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapPropertySource</span><span class="token punctuation">(</span><span class="token string">"from-SpringApplicationRunListener#contextPrepared"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
		propertySources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoaded</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MapPropertySource</span> propertySource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapPropertySource</span><span class="token punctuation">(</span><span class="token string">"from-SpringApplicaitonRunListener#contextLoaded"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
		propertySources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">started</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">running</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventPublishingRunListener</span><span class="token punctuation">(</span>application<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行结果：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">用户id: <span class="token number">45</span>
顺序<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-SpringApplicaitonRunListener<span class="token comment">#contextLoaded]:[MapPropertySource {name='from-SpringApplicaitonRunListener#contextLoaded'}]</span>
顺序<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-SpringApplicationRunListener<span class="token comment">#contextPrepared]:[MapPropertySource {name='from-SpringApplicationRunListener#contextPrepared'}]</span>
顺序<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-ApplicationContextInitializer<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-ApplicationContextInitializer'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>configurationProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ConfigurationPropertySourcesPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'configurationProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-ApplicationEnvironmentPreparedEvent<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-ApplicationEnvironmentPreparedEvent'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-EnvironmentPostProcessor<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-EnvironmentPostProcessor'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-SpringApplicationRunListener<span class="token comment">#environmentPrepared]:[MapPropertySource {name='from-SpringApplicationRunListener#environmentPrepared'}]</span>
顺序<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>commandLineArgs<span class="token punctuation">]</span>:<span class="token punctuation">[</span>SimpleCommandLinePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'commandLineArgs'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemEnvironment<span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginAwareSystemEnvironmentPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemEnvironment'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>random<span class="token punctuation">]</span>:<span class="token punctuation">[</span>RandomValuePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>applicationConfig: <span class="token punctuation">[</span>classpath:/application.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginTrackedMapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'applicationConfig: [classpath:/application.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from classpath:META-INF/default.properties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ResourcePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from classpath:META-INF/default.properties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>顺序[1] 和 顺序[2] 就是我们加入的两个方法实现。</p><h3 id="3-6-基于-ApplicationPreparedEvent-扩展"><a href="#3-6-基于-ApplicationPreparedEvent-扩展" class="headerlink" title="3.6 基于 ApplicationPreparedEvent 扩展"></a>3.6 基于 ApplicationPreparedEvent 扩展</h3><p>org.springframework.boot.SpringApplication#run(java.lang.String…)</p><ul><li><p>org.springframework.boot.SpringApplication#prepareContext</p><ul><li><p>org.springframework.boot.context.event.EventPublishingRunListener#contextLoaded</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoaded</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> listener <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>application<span class="token punctuation">.</span><span class="token function">getListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContextAware</span><span class="token punctuation">)</span> listener<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setApplicationContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       context<span class="token punctuation">.</span><span class="token function">addApplicationListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>initialMulticaster<span class="token punctuation">.</span><span class="token function">multicastEvent</span><span class="token punctuation">(</span>
         <span class="token keyword">new</span> <span class="token class-name">ApplicationPreparedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>application<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 EventPublishingRunListener 这个内建的实现中，contextLoaded 方法中最后发送了 ApplicationPreparedEvent 事件，如果我们来监听这个事件，通过参数 application 获取到 Environment 也可以进行相应的操作。</p></li></ul></li></ul><p>我们新建 ExtendPropertySourceApplicationListener2 来监听 ApplicationPreparedEvent 事件。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">		<span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationPreparedEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationPreparedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">ConfigurableApplicationContext</span> context <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user.id"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MapPropertySource</span> propertySource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapPropertySource</span><span class="token punctuation">(</span><span class="token string">"from-ExtendPropertySourceApplicationListener2"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>

		propertySources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>resources/META-INF/spring.factories 文件新增对应的配置</p><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># Application Listeners</span>
<span class="token attr-name">org.springframework.context.ApplicationListener</span><span class="token punctuation">=</span><span class="token attr-value">\
com.zq.externalized.configuration.listener.ExtendPropertySourceApplicationListener,\
com.zq.externalized.configuration.listener.ExtendPropertySourceApplicationListener2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>执行结果:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">用户id: <span class="token number">100</span>
顺序<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-ExtendPropertySourceApplicationListener2<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-ExtendPropertySourceApplicationListener2'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-SpringApplicaitonRunListener<span class="token comment">#contextLoaded]:[MapPropertySource {name='from-SpringApplicaitonRunListener#contextLoaded'}]</span>
顺序<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-SpringApplicationRunListener<span class="token comment">#contextPrepared]:[MapPropertySource {name='from-SpringApplicationRunListener#contextPrepared'}]</span>
顺序<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-ApplicationContextInitializer<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-ApplicationContextInitializer'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>configurationProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ConfigurationPropertySourcesPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'configurationProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-ApplicationEnvironmentPreparedEvent<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-ApplicationEnvironmentPreparedEvent'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-EnvironmentPostProcessor<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from-EnvironmentPostProcessor'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from-SpringApplicationRunListener<span class="token comment">#environmentPrepared]:[MapPropertySource {name='from-SpringApplicationRunListener#environmentPrepared'}]</span>
顺序<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>commandLineArgs<span class="token punctuation">]</span>:<span class="token punctuation">[</span>SimpleCommandLinePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'commandLineArgs'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemProperties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>MapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemProperties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>systemEnvironment<span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginAwareSystemEnvironmentPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'systemEnvironment'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>random<span class="token punctuation">]</span>:<span class="token punctuation">[</span>RandomValuePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'random'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>applicationConfig: <span class="token punctuation">[</span>classpath:/application.properties<span class="token punctuation">]</span><span class="token punctuation">]</span>:<span class="token punctuation">[</span>OriginTrackedMapPropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'applicationConfig: [classpath:/application.properties]'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
顺序<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span>-名称<span class="token punctuation">[</span>from classpath:META-INF/default.properties<span class="token punctuation">]</span>:<span class="token punctuation">[</span>ResourcePropertySource <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">'from classpath:META-INF/default.properties'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>顺序顺序[1]-名称[from-ExtendPropertySourceApplicationListener2] 就是我们新加入的 ExtendPropertySourceApplicationListener2</p><h2 id="4-参考"><a href="#4-参考" class="headerlink" title="4.参考"></a>4.参考</h2><ul><li>慕课网-小马哥《Spring Boot2.0深度实践之核心技术篇》</li></ul></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">张权</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://www.zhangquan.me/2024/07/19/spring-boot-wai-bu-hua-pei-zhi-xia-pian/">https://www.zhangquan.me/2024/07/19/spring-boot-wai-bu-hua-pei-zhi-xia-pian/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">张权</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/Java/"><span class="chip bg-color">Java</span></a> <a href="/tags/Spring-Boot/"><span class="chip bg-color">Spring Boot</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/comment_bg.png) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="/libs/valine/av-min.js"></script><script src="https://unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"s8QEmTF1Slf32CctOSsFuvXe-gzGzoHsz",appKey:"sDkuaBSVzI8HdhP09aPoMjYV",notify:!1,verify:!1,visitor:!0,avatar:"monsterid",pageSize:"10",lang:"zh-cn",placeholder:"昵称填写qq可以显示qq头像和昵称哦~ ",enableQQ:!0,emojiCDN:"//i0.hdslb.com/bfs/emote/",emojiMaps:{tv_doge:"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_亲亲":"a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv_偷笑":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_再见":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_冷漠":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_发怒":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_发财":"34db290afd2963723c6eb3c4560667db7253a21a.png","tv_可爱":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_吐血":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_呆":"fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv_呕吐":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_困":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_坏笑":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_大佬":"093c1e2c490161aca397afc45573c877cdead616.png","tv_大哭":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_委屈":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_害羞":"a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv_尴尬":"7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv_微笑":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_思考":"90cf159733e558137ed20aa04d09964436f618a1.png","tv_惊吓":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png","tv_打脸":"56ab10b624063e966bfcb76ea5dc4794d87dfd47.png","tv_抓狂":"fe31c08edad661d63762b04e17b8d5ae3c71a757.png","tv_抠鼻":"c666f55e88d471e51bbd9fab9bb308110824a6eb.png","tv_斜眼笑":"911f987aa8bc1bee12d52aafe62bc41ef4474e6c.png","tv_无奈":"ea8ed89ee9878f2fece2dda0ea8a5dbfe21b5751.png","tv_晕":"5443c22b4d07fb1907ccc610c8e6db254f2461b7.png","tv_流汗":"cead1c351ab8d79e9f369605beb90148db0fbed3.png","tv_流泪":"7e71cde7858f0cd50d74b0264aa26db612a8a167.png","tv_流鼻血":"c32d39db2737f89b904ca32700d140a9241b0767.png","tv_点赞":"f85c354995bd99e28fc76c869bfe42ba6438eff4.png","tv_生气":"26702dcafdab5e8225b43ffd23c94ac1ff932654.png","tv_生病":"8b0ec90e6b86771092a498c54f09fc94621c1900.png","tv_疑问":"0793d949b18d7be716078349c202c15ff166f314.png","tv_白眼":"c1d59f439e379ee50eef488bcb5e5378e5044ea4.png","tv_皱眉":"72ccad6679fea0d14cce648b4d818e09b8ffea2d.png","tv_目瞪口呆":"0b8cb81a68de5d5365212c99375e7ace3e7891b7.png","tv_睡着":"8b196675b53af58264f383c50ad0945048290b33.png","tv_笑哭":"1abc628f6d4f4caf9d0e7800878f4697abbc8273.png","tv_腼腆":"89712c0d4af73e67f89e35cbc518420380a7f6f4.png","tv_色":"61822c7e9aae5da76475e7892534545336b23a6f.png","tv_调侃":"4bc022533ef31544ca0d72c12c808cf4a1cce3e3.png","tv_调皮":"b9c41de8e82dd7a8515ae5e3cb63e898bf245186.png","tv_鄙视":"6e72339f346a692a495b123174b49e4e8e781303.png","tv_闭嘴":"c9e990da7f6e93975e25fd8b70e2e290aa4086ef.png","tv_难过":"87f46748d3f142ebc6586ff58860d0e2fc8263ba.png","tv_馋":"fc7e829b845c43c623c8b490ee3602b7f0e76a31.png","tv_鬼脸":"0ffbbddf8a94d124ca2f54b360bbc04feb6bbfea.png","tv_黑人问号":"45821a01f51bc867da9edbaa2e070410819a95b2.png","tv_鼓掌":"1d21793f96ef4e6f48b23e53e3b9e42da833a0f6.png"},requiredFields:["nick","mail"]})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i> &nbsp;上一篇</div><div class="card"><a href="/2024/07/26/chong-gou-java-dai-ma-zhong-xiao-chu-if-else-yu-ju-yi-huo-de-geng-qing-xi-ke-kuo-zhan-de-luo-ji/"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/featureimages/23.jpg" class="responsive-img" alt="重构：Java 代码中消除 If-Else 语句以获得更清晰、可扩展的逻辑"> <span class="card-title">重构：Java 代码中消除 If-Else 语句以获得更清晰、可扩展的逻辑</span></div></a><div class="card-content article-content"><div class="summary block-with-text">重构：Java 代码中消除 If-Else 语句以获得更清晰、可扩展的逻辑</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2024-07-26</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E9%87%8D%E6%9E%84/" class="post-category">重构</a></span></div></div><div class="card-action article-tags"><a href="/tags/Java/"><span class="chip bg-color">Java</span></a> <a href="/tags/%E9%87%8D%E6%9E%84/"><span class="chip bg-color">重构</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/2024/07/19/spring-boot-wai-bu-hua-pei-zhi-zhong-pian/"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/loading.gif" data-original="https://cdn.jsdelivr.net/gh/dendi875/dendi875.github.io/medias/featureimages/19.jpg" class="responsive-img" alt="Spring Boot 外部化配置 - 中篇"> <span class="card-title">Spring Boot 外部化配置 - 中篇</span></div></a><div class="card-content article-content"><div class="summary block-with-text">Spring Boot 外部化配置 - 中篇</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2024-07-19</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Spring-Boot/" class="post-category">Spring Boot</a></span></div></div><div class="card-action article-tags"><a href="/tags/Java/"><span class="chip bg-color">Java</span></a> <a href="/tags/Spring-Boot/"><span class="chip bg-color">Spring Boot</span></a></div></div></div></div></article></div><script src="/libs/codeBlock/codeBlockFuction.js"></script><script src="/libs/codeBlock/codeLang.js"></script><script src="/libs/codeBlock/codeCopy.js"></script><script src="/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><link rel="stylesheet" href="/libs/aplayer/APlayer.min.css"><style>.aplayer .aplayer-lrc p{display:none;font-size:12px;font-weight:700;line-height:16px!important}.aplayer .aplayer-lrc p.aplayer-lrc-current{display:none;font-size:15px;color:#42b983}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div><div class="row"><meting-js class="col l8 offset-l2 m10 offset-m1 s12" server="netease" type="playlist" id="503838841" fixed="true" autoplay theme="#42b983" loop order="random" preload="auto" volume="0.7" list-folded="true"></meting-js></div></div><script src="/libs/aplayer/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2021-2024</span> <a href="/about" target="_blank">张权</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">408.5k</span> <span id="busuanzi_container_site_pv">&nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span></span> <span id="busuanzi_container_site_uv">&nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span></span><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=new Date,t="2021",n=e.getFullYear(),i=e.getMonth()+1,a=e.getDate(),r=e.getHours(),s=e.getMinutes(),o=e.getSeconds(),g=Date.UTC(t,"6","28","0","0","0"),d=Date.UTC(n,i,a,r,s,o)-g,m=Math.floor(d/31536e6),l=Math.floor(d/864e5-365*m);if(t===String(n)){document.getElementById("year").innerHTML=n;var c="This site has been running for "+l+" days";c="本站已运行 "+l+" 天",document.getElementById("sitetime").innerHTML=c}else{document.getElementById("year").innerHTML=t+" - "+n;var u="This site has been running for "+m+" years and "+l+" days";u="本站已运行 "+m+" 年 "+l+" 天",document.getElementById("sitetime").innerHTML=u}};calcSiteTime()</script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/dendi875" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i></a><a href="mailto:dendi875@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i></a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=943299849" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 943299849" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><script language="javascript">function siteTime(){window.setTimeout("siteTime()",1e3);var e=36e5,t=24*e,o=new Date,i=o.getFullYear(),a=o.getMonth()+1,n=o.getDate(),r=o.getHours(),l=o.getMinutes(),s=o.getSeconds(),M=Date.UTC(2021,11,9,0,0,0),g=Date.UTC(i,a,n,r,l,s)-M,m=Math.floor(g/31536e6),T=Math.floor(g/t-365*m),f=Math.floor((g-(365*m+T)*t)/e),h=Math.floor((g-(365*m+T)*t-f*e)/6e4),u=Math.floor((g-(365*m+T)*t-f*e-6e4*h)/1e3);document.getElementById("sitetime").innerHTML="本站已运行 "+m+" 年 "+T+" 天 "+f+" 小时 "+h+" 分钟 "+u+" 秒"}siteTime()</script><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script>$(function(){!function(t,a,s){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),r=document.getElementById(a),n=document.getElementById(s);r.addEventListener("input",function(){var f='<ul class="search-result-list">',m=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var r=!0,n=t.title.trim().toLowerCase(),a=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),e=t.url;e=0===e.indexOf("/")?t.url:"/"+e;var s=-1,i=-1,l=-1;if(""!==n&&""!==a&&m.forEach(function(t,e){s=n.indexOf(t),i=a.indexOf(t),s<0&&i<0?r=!1:(i<0&&(i=0),0===e&&(l=i))}),r){f+="<li><a href='"+e+"' class='search-result-title'>"+n+"</a>";var c=t.content.trim().replace(/<[^>]+>/g,"");if(0<=l){var u=l-20,o=l+80;u<0&&(u=0),0===u&&(o=100),o>c.length&&(o=c.length);var h=c.substr(u,o);m.forEach(function(t){var e=new RegExp(t,"gi");h=h.replace(e,'<em class="search-keyword">'+t+"</em>")}),f+='<p class="search-result">'+h+"...</p>"}f+="</li>"}}),f+="</ul>",n.innerHTML=f)})}})}("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/libs/others/clicklove.js" async></script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script><script>var st,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="Σ(っ °Д °;)っ喔哟，崩溃啦！",clearTimeout(st)):(document.title="φ(゜▽゜*)♪咦，又好了！",st=setTimeout(function(){document.title=OriginTitile},3e3))})</script><style>[bg-lazy]{background-image:none!important;background-color:#eee!important}</style><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,c=(r.imageLazyLoadSetting.preloadRatio,n());function n(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=n());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e()},t.src!==a&&(n.src=a))}()}function a(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",a),r.addEventListener("resize",a),r.addEventListener("orientationchange",a)}(this)</script></body></html>