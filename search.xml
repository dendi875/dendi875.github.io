<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>设计模式之-结构型模式-外观模式 (Facade Pattern)</title>
      <link href="/2021/07/09/she-ji-mo-shi-zhi-jie-gou-xing-mo-shi-wai-guan-mo-shi-facade-pattern/"/>
      <url>/2021/07/09/she-ji-mo-shi-zhi-jie-gou-xing-mo-shi-wai-guan-mo-shi-facade-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="外观模式-Facade-Pattern"><a href="#外观模式-Facade-Pattern" class="headerlink" title="外观模式 (Facade Pattern)"></a>外观模式 (Facade Pattern)</h1><hr><h3 id="0-外观模式概述"><a href="#0-外观模式概述" class="headerlink" title="0. 外观模式概述"></a>0. 外观模式概述</h3><p>不知道大家有没有比较过自己泡茶和去茶馆喝茶的区别，如果是自己泡茶需要自行准备茶叶、茶具和开水，如图(A)所示，而去茶馆喝茶，最简单的方式就是跟茶馆服务员说想要一杯什么样的茶，是铁观音、碧螺春还是西湖龙井？正因为茶馆有服务员，顾客无须直接和茶叶、茶具、开水等交互，整个泡茶过程由服务员来完成，顾客只需与服务员交互即可，整个过程非常简单省事，如图(B)所示。</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/tea.jpg" alt="tea"></p><p>在软件开发中，有时候为了完成一项较为复杂的功能，一个客户端类需要和多个业务类交互，而这些需要交互的业务类经常会作为一个整体出现，由于涉及到的类比较多，导致使用时代码较为复杂，此时，特别需要一个类似服务员一样的角色，由它来负责和多个业务类进行交互，而客户端类只需与该类交互。外观模式通过引入一个新的外观类(Facade)来实现该功能，外观类充当了软件系统中的“服务员”，它为多个业务类的调用提供了一个统一的入口，简化了类与类之间的交互。在外观模式中，那些需要交互的业务类被称为子系统(Subsystem)。如果没有外观类，那么每个客户端类需要和多个子系统之间进行复杂的交互，系统的耦合度将很大；而引入外观类之后，客户端类只需要直接与外观类交互，客户端类与子系统之间原有的复杂引用关系由外观类来实现，从而降低了系统的耦合度。</p><h3 id="1-模式定义"><a href="#1-模式定义" class="headerlink" title="1. 模式定义"></a>1. 模式定义</h3><blockquote><p>外观模式 (Facade Pattern)：为子系统中的一组接口提供一个统一的入口。外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。</p></blockquote><p>外观模式又称为门面模式，它是一种<strong>对象结构型模式</strong>。</p><p>外观模式是<strong>迪米特法则</strong>的一种具体实现，通过引入一个新的外观角色可以降低原有系统的复杂度，同时降低客户端类与子系统的耦合度。</p><h3 id="2-模式结构"><a href="#2-模式结构" class="headerlink" title="2. 模式结构"></a>2. 模式结构</h3><p>外观模式包含如下角色：</p><ul><li><p><code>Facade</code>：<strong>外观</strong></p><ul><li>客户端可以调用它的方法，在外观角色中可以知道相关的（一个或者多个）子系统的功能和责任；在正常情况下，它将所有从客户端发来的请求委派到相应的子系统去，传递给相应的子系统对象处理。</li></ul></li><li><p><code>SubSystem</code>：<strong>子系统</strong></p><ul><li>在软件系统中可以有一个或者多个子系统角色，每一个子系统可以不是一个单独的类，而是一个类的集合，它实现子系统的功能；每一个子系统都可以被客户端直接调用，或者被外观角色调用，它处理由外观类传过来的请求；子系统并不知道外观的存在，对于子系统而言，外观角色仅仅是另外一个客户端而已。</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/FacadePattern-0.png" alt="FacadePattern-0"></p><h3 id="3-模式实现"><a href="#3-模式实现" class="headerlink" title="3. 模式实现"></a>3. 模式实现</h3><ul><li><p>外观模式的主要目的在于降低系统的复杂程度，在面向对象软件系统中，类与类之间的关系越多，不能表示系统设计得越好，反而表示系统中类之间的耦合度太大，这样的系统在维护和修改时都缺乏灵活性，因为一个类的改动会导致多个类发生变化，而外观模式的引入在很大程度上降低了类与类之间的耦合关系。引入外观模式之后，增加新的子系统或者移除子系统都非常方便，客户端类无须进行修改（或者极少的修改），只需要在外观类中增加或移除对子系统的引用即可。从这一点来说，外观模式在一定程度上并不符合开闭原则，增加新的子系统需要对原有系统进行一定的修改，虽然这个修改工作量不大。</p></li><li><p>外观模式中所指的子系统是一个广义的概念，它可以是一个类、一个功能模块、系统的一个组成部分或者一个完整的系统。子系统类通常是一些业务类，实现了一些具体的、独立的业务功能。</p></li></ul><h3 id="4-外观模式应用实例"><a href="#4-外观模式应用实例" class="headerlink" title="4. 外观模式应用实例"></a>4. 外观模式应用实例</h3><p>下面通过一个实例进一步学习和理解外观模式。</p><h3 id="实例说明"><a href="#实例说明" class="headerlink" title="实例说明"></a>实例说明</h3><p>现在需要开发一个文件加密功能，该功能可以对文件中的数据进行加密并将加密之后的数据存储在一个新文件中，具体的流程包括三个部分，分别是读取源文件、加密、保存加密之后的文件。这三个操作相对独立，为了实现代码的独立重用，让设计更符合<strong>单一职责原则</strong>，这三个操作的业务代码封装在三个不同的类中。</p><p>现使用外观模式设计该文件加密功能。</p><h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><ul><li>EncryptFacade：<code>外观类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * EncryptFacade 加密外观类。 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-05 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">EncryptFacade</span><span class="token punctuation">{</span>    <span class="token comment">/**     * @var FileReader     */</span>    <span class="token keyword">private</span> <span class="token variable">$fileReader</span><span class="token punctuation">;</span>    <span class="token comment">/**     * @var CipherMachine     */</span>    <span class="token keyword">private</span> <span class="token variable">$cipherMachine</span><span class="token punctuation">;</span>    <span class="token comment">/**     * @var FileWriter     */</span>    <span class="token keyword">private</span> <span class="token variable">$fileWriter</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fileReader</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">cipherMachine</span> <span class="token operator">=</span> <span class="token class-name static-context">CipherMachine</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fileWriter</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">fileEncrypt</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$fileNameSrc</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$fileNameDes</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token comment">/* 读取文件，获取明文 */</span>        <span class="token variable">$plainStr</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fileReader</span><span class="token operator">-&gt;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token variable">$fileNameSrc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 数据加密，将明文转换为密文 */</span>        <span class="token variable">$encryptStr</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">cipherMachine</span><span class="token operator">-&gt;</span><span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token variable">$plainStr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 保存密文，写入文件 */</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">fileWriter</span><span class="token operator">-&gt;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$encryptStr</span><span class="token punctuation">,</span> <span class="token variable">$fileNameDes</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>FileReader、CipherMachine、FileWriter： <code>子系统类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * FileReader 文件读取类，充当子系统类。 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-05 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">FileReader</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$fileNameSrc</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token keyword return-type">string</span>    <span class="token punctuation">{</span>        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$stream</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$fileNameSrc</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token function">stream_get_contents</span><span class="token punctuation">(</span><span class="token variable">$stream</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$stream</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$ex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$str</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * CipherMachine 数据加密类，充当子系统类。 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-05 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">CipherMachine</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token variable">$iv</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$ivlen</span> <span class="token operator">=</span> <span class="token function">openssl_cipher_iv_length</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'aes-256-ctr'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$iv</span> <span class="token operator">=</span> <span class="token function">openssl_random_pseudo_bytes</span><span class="token punctuation">(</span><span class="token variable">$ivlen</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">iv</span> <span class="token operator">=</span> <span class="token variable">$iv</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">self</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$instance</span> <span class="token keyword">instanceof</span> <span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$instance</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$instance</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">encrypt</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$plainText</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">openssl_encrypt</span><span class="token punctuation">(</span><span class="token variable">$plainText</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'aes-256-ctr'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'secret'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">iv</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">decrypt</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$ciphertext</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">openssl_decrypt</span><span class="token punctuation">(</span><span class="token variable">$ciphertext</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'aes-256-ctr'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'secret'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">iv</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * FileWriter 文件保存类，充当子系统类。 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-05 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">FileWriter</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$ciphertext</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$fileNameDes</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$handle</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$fileNameDes</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$handle</span><span class="token punctuation">,</span> <span class="token variable">$ciphertext</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$handle</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>加密文件<code>src.txt</code>内容为</li></ul><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost Facade-Pattern]# echo 'hello,world!' &gt;  src.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>客户端测试</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$encryptFacade</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EncryptFacade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$encryptFacade</span><span class="token operator">-&gt;</span><span class="token function">fileEncrypt</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'src.txt'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'des.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>加密后的<code>des.txt</code>内容为</li></ul><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost Facade-Pattern]# cat des.txtpw2x3UEeO8GVjum36A==<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="5-UML类图"><a href="#5-UML类图" class="headerlink" title="5. UML类图"></a>5. UML类图</h3><p>示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/FacadePattern-1.png" alt="FacadePattern-1"></p><h3 id="6-外观模式的优点"><a href="#6-外观模式的优点" class="headerlink" title="6. 外观模式的优点"></a>6. 外观模式的优点</h3><p>外观模式的主要优点如下：</p><p>(1)它对客户端屏蔽了子系统组件，减少了客户端所需处理的对象数目，并使得子系统使用起来更加容易。通过引入外观模式，客户端代码将变得很简单，与之关联的对象也很少。</p><p>(2)它实现了子系统与客户端之间的松耦合关系，这使得子系统的变化不会影响到调用它的客户端，只需要调整外观类即可。</p><p>(3)一个子系统的修改对其他子系统没有任何影响，而且子系统内部变化也不会影响到外观对象。</p><h3 id="7-外观模式的缺点"><a href="#7-外观模式的缺点" class="headerlink" title="7. 外观模式的缺点"></a>7. 外观模式的缺点</h3><p>外观模式的主要缺点如下：</p><p>(1)不能很好地限制客户端直接使用子系统类，如果对客户端访问子系统类做太多的限制则减少了可变性和灵活性。</p><p>(2)增加新的子系统可能需要修改外观类的源代码，违背了<strong>开闭原则</strong>。</p><h3 id="8-外观模式适用场景"><a href="#8-外观模式适用场景" class="headerlink" title="8. 外观模式适用场景"></a>8. 外观模式适用场景</h3><p>在以下情况下可以考虑使用外观模式：</p><p>(1)当要为访问一系列复杂的子系统提供一个简单入口时可以使用外观模式。</p><p>(2)客户端程序与多个子系统之间存在很大的依赖性。引入外观类可以将子系统与客户端解耦，从而提高子系统的独立性和可移植性。</p><p>(3)在层次化结构中，可以使用外观模式定义系统中每一层的入口，层与层之间不直接产生联系，而通过外观类建立联系，降低层之间的耦合度。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式之-结构型模式-组合模式 (Composite Pattern)</title>
      <link href="/2021/07/08/she-ji-mo-shi-zhi-jie-gou-xing-mo-shi-zu-he-mo-shi-composite-pattern/"/>
      <url>/2021/07/08/she-ji-mo-shi-zhi-jie-gou-xing-mo-shi-zu-he-mo-shi-composite-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="组合模式-Composite-Pattern"><a href="#组合模式-Composite-Pattern" class="headerlink" title="组合模式 (Composite Pattern)"></a>组合模式 (Composite Pattern)</h1><hr><h3 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h3><p>树形结构在软件中随处可见，例如操作系统中的目录结构、应用软件中的菜单、办公系统中的公司组织结构等等，如何运用面向对象的方式来处理这种树形结构是组合模式需要解决的问题，组合模式通过一种巧妙的设计方案使得用户可以一致性地处理整个树形结构或者树形结构的一部分，也可以一致性地处理树形结构中的叶子节点（不包含子节点的节点）和树枝节点（包含子节点的节点）。</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/tree.png" alt="tree"></p><h3 id="1-模式定义"><a href="#1-模式定义" class="headerlink" title="1. 模式定义"></a>1. 模式定义</h3><blockquote><p>组合模式 (Composite Pattern)：组合多个对象形成树形结构以表示具有“整体—部分”关系的层次结构。组合模式对单个对象（即叶子对象）和组合对象（即树枝对象）的使用具有一致性，组合模式又可以称为“整体—部分”(Part-Whole)模式。</p></blockquote><p>组合模式是一种<strong>对象结构型模式</strong>。</p><h3 id="2-组合模式结构"><a href="#2-组合模式结构" class="headerlink" title="2. 组合模式结构"></a>2. 组合模式结构</h3><p>组合模式包含如下角色：</p><ul><li><p><code>Component</code>：<strong>抽象构件</strong></p><ul><li>它可以是接口或抽象类，为树叶构件和树枝构件对象声明接口，在该角色中可以包含所有子类共有行为的声明和实现。在抽象构件中定义了访问及管理它的子构件的方法，如增加子构件、删除子构件、获取子构件等。</li></ul></li><li><p><code>Leaf</code>：<strong>树叶构件</strong></p><ul><li>它在组合结构中表示叶子节点对象，叶子节点没有子节点，它实现了在抽象构件中定义的行为。对于那些访问及管理子构件的方法，可以通过异常等方式进行处理。</li></ul></li><li><p><code>Composite</code>：<strong>树枝构件</strong></p><ul><li>它在组合结构中表示树枝节点对象，树枝节点包含子节点，其子节点可以是叶子节点，也可以是树枝节点，它提供一个集合用于存储子节点，实现了在抽象构件中定义的行为，包括那些访问及管理子构件的方法，在其业务方法中可以递归调用其子节点的业务方法。</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/Composite-Pattern-0.jpg" alt="Composite-Pattern-0.jpg"></p><h3 id="3-组合模式应用实例"><a href="#3-组合模式应用实例" class="headerlink" title="3. 组合模式应用实例"></a>3. 组合模式应用实例</h3><p>下面通过一个实例进一步学习和理解组合模式。</p><h3 id="实例说明"><a href="#实例说明" class="headerlink" title="实例说明"></a>实例说明</h3><p>在Dendi软件公司的内部办公系统OA系统中，有一个与公司组织结构对应的树形菜单，行政人员可以给各级单位下发通知，这些单位可以是总公司的一个部门，也可以是一个分公司，还可以是分公司的一个部门。用户只需要选择一个根节点即可实现通知的下发操作，而无须关心具体的实现细节。</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">└── Dendi公司北京总部    ├── 上海分公司    │&nbsp;&nbsp; ├── 上海分公司财务部    │&nbsp;&nbsp; ├── 上海分公司人力资源部    │&nbsp;&nbsp; └── 上海分公司研发部    ├── 深圳分公司    │&nbsp;&nbsp; ├── 深圳分公司财务部    │&nbsp;&nbsp; ├── 深圳分公司人力资源部    │&nbsp;&nbsp; └── 深圳分公司研发部    ├── 总公司财务部    ├── 总公司人力资源部    └── 总公司研发部<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><ul><li>Units：<code>抽象构件</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 抽象单位类：抽象构件 * 这里单位即可以是某个部门，也可以某个公司 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-07-22 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Units</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$name</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/* 下发通知 */</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sendNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Company： <code>树枝构件角色</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 公司类：树枝构件角色 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-07-22 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Company</span> <span class="token keyword">extends</span> <span class="token class-name">Units</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 单位的集合，用于存储Units类型的成员     *     * @var array     */</span>    <span class="token keyword">private</span> <span class="token variable">$unitList</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Units</span> <span class="token variable">$u</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">unitList</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$u</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">remove</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Units</span> <span class="token variable">$u</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">array_search</span><span class="token punctuation">(</span><span class="token variable">$u</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">unitList</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$key</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">unitList</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getChild</span><span class="token punctuation">(</span><span class="token keyword type-hint">int</span> <span class="token variable">$i</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">unitList</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sendNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"*****%s收到通知*****\n"</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 递归调用子构件的sendNotify()方法 */</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">unitList</span> <span class="token keyword">as</span> <span class="token variable">$unit</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$unit</span><span class="token operator">-&gt;</span><span class="token function">sendNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ResearchDepartment、FinanceDepartment、HRDepartment： <code>树叶构件角色</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 研发部：树叶构件角色 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-07-22 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">ResearchDepartment</span> <span class="token keyword">extends</span> <span class="token class-name">Units</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sendNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"-----%s收到通知-----\n"</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 财务部：树叶构件角色 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-07-22 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">FinanceDepartment</span> <span class="token keyword">extends</span> <span class="token class-name">Units</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sendNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"-----%s收到通知-----\n"</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 人力资源部：树叶构件角色 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-07-22 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HRDepartment</span> <span class="token keyword">extends</span> <span class="token class-name">Units</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sendNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"-----%s收到通知-----\n"</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>客户端测试代码</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 客户端测试代码 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-07-22 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Client</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$rootCompany</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Company</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Dendi公司北京总部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shangHaiCompany</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Company</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"上海分公司"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shenZhenCompany</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Company</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"深圳分公司"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$rootRD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResearchDepartment</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"总公司研发部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$rootFD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinanceDepartment</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"总公司财务部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$rootHRD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HRDepartment</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"总公司人力资源部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shangHaiRD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResearchDepartment</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"上海分公司研发部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shangHaiFD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinanceDepartment</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"上海分公司财务部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shangHaiHRD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HRDepartment</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"上海分公司人力资源部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shenZhenRD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResearchDepartment</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"深圳分公司研发部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shenZhenFD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinanceDepartment</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"深圳分公司财务部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shenZhenHRD</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HRDepartment</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"深圳分公司人力资源部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shangHaiCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$shangHaiRD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shangHaiCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$shangHaiFD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shangHaiCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$shangHaiHRD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shenZhenCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$shenZhenRD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shenZhenCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$shenZhenFD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$shenZhenCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$shenZhenHRD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$rootCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$rootRD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$rootCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$rootFD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$rootCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$rootHRD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$rootCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$shangHaiCompany</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$rootCompany</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$shenZhenCompany</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//从"北京总部"节点开始下发通知</span>        <span class="token variable">$rootCompany</span><span class="token operator">-&gt;</span><span class="token function">sendNotify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>以上例程会输出：<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span>Dendi公司北京总部收到通知<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>总公司研发部收到通知<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>总公司财务部收到通知<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>总公司人力资源部收到通知<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span>上海分公司收到通知<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>上海分公司研发部收到通知<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>上海分公司财务部收到通知<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>上海分公司人力资源部收到通知<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span>深圳分公司收到通知<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>深圳分公司研发部收到通知<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>深圳分公司财务部收到通知<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>深圳分公司人力资源部收到通知<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-UML类图"><a href="#4-UML类图" class="headerlink" title="4. UML类图"></a>4. UML类图</h3><p>示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/Composite-Pattern-1.png" alt="Composite-Pattern-1"></p><h3 id="5-组合模式总结"><a href="#5-组合模式总结" class="headerlink" title="5. 组合模式总结"></a>5. 组合模式总结</h3><ul><li><p>组合模式的关键是定义了一个抽象构件类，它既可以代表叶子，又可以代表树枝，而客户端针对该抽象构件类进行编程，无须知道它到底表示的是叶子还是树枝，可以对其进行统一处理。同时树枝对象与抽象构件类之间还建立一个聚合关联关系，在树枝对象中既可以包含叶子，也可以包含树枝，以此实现递归组合，形成一个树形结构。</p></li><li><p>在使用组合模式时，根据抽象构件类的定义形式，我们可将组合模式分为透明组合模式和安全组合模式两种形式：</p></li></ul><p>(1)透明组合模式<br>透明组合模式中，抽象构件Component中声明了所有用于管理成员对象的方法，包括add()、remove()以及getChild()等方法，这样做的好处是确保所有的构件类都有相同的接口。在客户端看来，叶子对象与树枝对象所提供的方法是一致的，客户端可以相同地对待所有的对象。透明组合模式也是组合模式的标准形式，因为在叶子构件中需要实现在抽象构件类中声明的所有方法，包括业务方法以及管理和访问子构件的方法，但是叶子构件不能再包含子构件，因此在叶子构件中实现子构件管理和访问方法时需要提供异常处理或错误提示。</p><p>(2)安全组合模式<br>安全组合模式中，在抽象构件Component中没有声明任何用于管理成员对象的方法，而是在Composite类中声明并实现这些方法。这种做法是安全的，因为根本不向叶子对象提供这些管理成员对象的方法，对于叶子对象，客户端不可能调用到这些方法。</p><p>安全组合模式的缺点是不够透明，因为叶子构件和树枝构件具有不同的方法，且树枝构件中那些用于管理成员对象的方法没有在抽象构件类中定义，因此客户端不能完全针对抽象编程，必须有区别地对待叶子构件和树枝构件。在实际应用中，安全组合模式的使用频率也非常高。</p><h3 id="6-组合模式的优点"><a href="#6-组合模式的优点" class="headerlink" title="6. 组合模式的优点"></a>6. 组合模式的优点</h3><p>组合模式的主要优点如下：</p><p>(1)组合模式可以清楚地定义分层次的复杂对象，表示对象的全部或部分层次，它让客户端忽略了层次的差异，方便对整个层次结构进行控制。</p><p>(2)客户端可以一致地使用一个组合结构或其中单个对象，不必关心处理的是单个对象还是整个组合结构，简化了客户端代码。</p><p>(3)在组合模式中增加新的树枝构件和叶子构件都很方便，无须对现有类库进行任何修改，符合“开闭原则”。</p><p>(4)组合模式为树形结构的面向对象实现提供了一种灵活的解决方案，通过叶子对象和树枝对象的递归组合，可以形成复杂的树形结构，但对树形结构的控制却非常简单。</p><h3 id="7-组合模式的缺点"><a href="#7-组合模式的缺点" class="headerlink" title="7. 组合模式的缺点"></a>7. 组合模式的缺点</h3><p>组合模式的主要缺点如下：</p><p>在增加新构件时很难对树枝构件中的构件类型进行限制。有时候我们希望一个树枝构件中只能有某些特定类型的对象，例如在某个文件夹中只能包含文本文件，使用组合模式时，不能依赖类型系统来施加这些约束，因为它们都来自于相同的抽象层，在这种情况下，必须通过在运行时进行类型检查来实现，这个实现过程较为复杂。</p><h3 id="8-组合模式适用场景"><a href="#8-组合模式适用场景" class="headerlink" title="8.组合模式适用场景"></a>8.组合模式适用场景</h3><p>在以下情况下可以考虑使用组合模式：</p><p>(1)在具有整体和部分的层次结构中，希望通过一种方式忽略整体与部分的差异，客户端可以一致地对待它们。</p><p>(2)在一个使用面向对象语言开发的系统中需要处理一个树形结构。</p><p>(3)在一个系统中能够分离出叶子对象和树枝对象，而且它们的类型不固定，需要增加一些新的类型。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式之-结构型模式-装饰模式 (Decorator Pattern)</title>
      <link href="/2021/07/06/she-ji-mo-shi-zhi-jie-gou-xing-mo-shi-zhuang-shi-mo-shi-decorator-pattern/"/>
      <url>/2021/07/06/she-ji-mo-shi-zhi-jie-gou-xing-mo-shi-zhuang-shi-mo-shi-decorator-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="装饰模式-Decorator-Pattern"><a href="#装饰模式-Decorator-Pattern" class="headerlink" title="装饰模式 (Decorator Pattern)"></a>装饰模式 (Decorator Pattern)</h1><hr><h3 id="0、早餐店的故事"><a href="#0、早餐店的故事" class="headerlink" title="0、早餐店的故事"></a>0、早餐店的故事</h3><ul><li>我们借助早餐店的故事来认识一下装饰模式。小张刚创业一个人开了一家早餐店提供煎饼、手抓饼出售，现在需要实现一个制作面饼的系统。</li></ul><blockquote><ul><li>实现方案</li></ul></blockquote><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 一个各种面饼的制作接口 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-30 13:55:28 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">interface</span> <span class="token class-name-definition class-name">Pie</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/** * 煎饼套餐：加鸡蛋、香肠、番茄酱 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-30 14:16:40 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">JianBing</span> <span class="token keyword">implements</span> <span class="token class-name">Pie</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"普通的煎饼"</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">attachEgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token operator">-&gt;</span><span class="token function">attachSausage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token operator">-&gt;</span><span class="token function">attachKetchup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachEgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+鸡蛋"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachSausage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+香肠"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachKetchup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+番茄酱"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 手抓饼套餐：加鸡蛋、油条、辣椒酱 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-30 13:58:45 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">ShouZhuaBing</span> <span class="token keyword">implements</span> <span class="token class-name">Pie</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"普通的手抓饼"</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">attachEgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token operator">-&gt;</span><span class="token function">attachCruller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token operator">-&gt;</span><span class="token function">attachChiliPaste</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachEgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+鸡蛋"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachCruller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+油条"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span>  <span class="token variable">$this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachChiliPaste</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+辣椒酱"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 早餐类，出售各种面饼 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-30 14:03:50 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Breakfast</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token variable">$pie</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Pie</span> <span class="token variable">$pie</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">pie</span> <span class="token operator">=</span> <span class="token variable">$pie</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">pie</span><span class="token operator">-&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">//Client 调用</span><span class="token variable">$breakfastOne</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Breakfast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JianBing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$breakfastOne</span><span class="token operator">-&gt;</span><span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//普通的煎饼+鸡蛋+香肠+番茄酱</span><span class="token variable">$breakfastTwo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Breakfast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ShouZhuaBing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$breakfastTwo</span><span class="token operator">-&gt;</span><span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//普通的手抓饼+鸡蛋+油条+辣椒酱</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><ul><li><p>由于小张每天起早贪黑的努力工作生意越来越好，娶上了媳妇现在多了一个帮手，小张想要扩张一下出售面饼的各类，还想要出售鸡蛋灌饼、葱花鸡蛋饼等。原来的面饼系统就出现了一些问题</p><ul><li>每增加一种面饼种类就要增加一个该面饼的实现类。</li><li>随着面饼种类越来越多类的数量也就越多，类的维护成本就很大。</li><li>面饼的制作不够灵活，制作方法里硬编码了制作的配料。</li><li>公用的配料制作方法没有得到复用，比如鸡蛋配料方法。</li></ul></li><li><p>问：那小张该如何做？</p><ul><li>答：请看下面的<strong>装饰模式</strong></li></ul></li></ul><h3 id="1-模式定义"><a href="#1-模式定义" class="headerlink" title="1. 模式定义"></a>1. 模式定义</h3><p>装饰模式 (Decorator Pattern)：它属于对象<strong>结构型模式</strong>。动态地给一个对象添加一些额外的职责，就增加功能来说，装饰模式比生成子类更加灵活。</p><h3 id="2-模式结构"><a href="#2-模式结构" class="headerlink" title="2. 模式结构"></a>2. 模式结构</h3><p>装饰模式包含如下角色：</p><ul><li><p><code>Component</code>：抽象构件类</p><ul><li>定义一个对象接口，可以给这些对象动态地添加职责（方法）。</li></ul></li><li><p><code>ConcreteComponent</code>：具体构件类</p><ul><li>定义了具体的构件对象，实现了在抽象构件中声明的方法，装饰器可以给它增加额外的职责（方法）。</li></ul></li><li><p><code>Decorator</code>：抽象装饰类</p><ul><li>抽象装饰类是抽象构件类的子类，用于给具体构件增加职责，但是具体职责在其子类中实现。</li></ul></li><li><p><code>ConcreteDecorator</code>：具体装饰类</p><ul><li>具体装饰类是抽象装饰类的子类，负责向构件中添加新的职责。</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/DecoratorPattern-0.png" alt="DecoratorPattern-0.png"></p><h3 id="3-装饰模式实现的面饼系统代码示例"><a href="#3-装饰模式实现的面饼系统代码示例" class="headerlink" title="3. 装饰模式实现的面饼系统代码示例"></a>3. 装饰模式实现的面饼系统代码示例</h3><ul><li>Grain：抽象构件类</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 一个制作杂粮的接口 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-31 12:14:38 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">interface</span> <span class="token class-name-definition class-name">Grain</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>JianBing、ShouZhuaBing：具体构件类</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 煎饼类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-31 12:14:38 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">JianBing</span> <span class="token keyword">implements</span> <span class="token class-name">Grain</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"普通的煎饼"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 手抓饼类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-31 12:14:38 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">ShouZhuaBing</span> <span class="token keyword">implements</span> <span class="token class-name">Grain</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"普通的手抓饼"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>GrainDecorator：抽象装饰类</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 面饼装饰抽象类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-31 13:14:42 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">GrainDecorator</span> <span class="token keyword">implements</span> <span class="token class-name">Grain</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token variable">$grain</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Grain</span> <span class="token variable">$grain</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">grain</span> <span class="token operator">=</span> <span class="token variable">$grain</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">grain</span><span class="token operator">-&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Egg、Sausage、Ketchup、Cruller、ChiliPaste：具体装饰类</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token operator">**</span> <span class="token operator">*</span> 鸡蛋装饰类 <span class="token operator">*</span> <span class="token operator">*</span> @author     <span class="token operator">&lt;</span>dendi875@<span class="token number">163.</span>com<span class="token operator">&gt;</span> <span class="token operator">*</span> @createDate <span class="token number">2018</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">13</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">42</span> <span class="token operator">*</span> @copyright  <span class="token function">Copyright</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2018</span> dendi875@<span class="token number">163.</span>com <span class="token operator">*</span><span class="token operator">/</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Egg</span> <span class="token keyword">extends</span> <span class="token class-name">GrainDecorator</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Grain</span> <span class="token variable">$grain</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$grain</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">attachEgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachEgg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+鸡蛋"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 香肠装饰类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-31 13:15:54 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Sausage</span> <span class="token keyword">extends</span> <span class="token class-name">GrainDecorator</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Grain</span> <span class="token variable">$grain</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$grain</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">attachSausage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachSausage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+香肠"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 番茄酱装饰类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-31 13:16:36 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Ketchup</span> <span class="token keyword">extends</span> <span class="token class-name">GrainDecorator</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Grain</span> <span class="token variable">$grain</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$grain</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">attachKetchup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachKetchup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+番茄酱"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 油条装饰类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-31 13:16:55 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Cruller</span> <span class="token keyword">extends</span> <span class="token class-name">GrainDecorator</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Grain</span> <span class="token variable">$grain</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$grain</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">attachCruller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachCruller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+油条"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 辣椒酱装饰类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-31 13:17:17 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">ChiliPaste</span> <span class="token keyword">extends</span> <span class="token class-name">GrainDecorator</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Grain</span> <span class="token variable">$grain</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$grain</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">attachChiliPaste</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">attachChiliPaste</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"+辣椒酱"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-客户端的使用"><a href="#4-客户端的使用" class="headerlink" title="4. 客户端的使用"></a>4. 客户端的使用</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 早餐类，出售各种面饼 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-31 13:22:19 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Breakfast</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token variable">$grain</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Grain</span> <span class="token variable">$grain</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">grain</span> <span class="token operator">=</span> <span class="token variable">$grain</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">grain</span><span class="token operator">-&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">//Client 调用</span><span class="token comment">//制作一套煎饼</span><span class="token variable">$pie</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ketchup</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Sausage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Egg</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JianBing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$breakfast</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Breakfast</span><span class="token punctuation">(</span><span class="token variable">$pie</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$breakfast</span><span class="token operator">-&gt;</span><span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//普通的煎饼+鸡蛋+香肠+番茄酱</span><span class="token comment">//Client 调用</span><span class="token comment">//制作一套手抓饼</span><span class="token variable">$pie</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChiliPaste</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Cruller</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Egg</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ShouZhuaBing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$breakfast</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Breakfast</span><span class="token punctuation">(</span><span class="token variable">$pie</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$breakfast</span><span class="token operator">-&gt;</span><span class="token function">sale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//普通的手抓饼+鸡蛋+油条+辣椒酱</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-UML类图"><a href="#5-UML类图" class="headerlink" title="5. UML类图"></a>5. UML类图</h3><p>装饰模式实现的面饼系统示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/DecoratorPattern-1.png" alt="DecoratorPattern-1.png"></p><p>现在的面饼系统就变得强大了许多，可以按照顾客的需求用各种配料来装饰面饼而且装饰的顺序也很灵活，各种配料也能得以<strong>复用</strong>（同种配料可以被不同种类面饼利用），系统也很容易维护。</p><h3 id="6-模式分析"><a href="#6-模式分析" class="headerlink" title="6. 模式分析"></a>6. 模式分析</h3><ul><li>与继承关系相比，关联关系的主要优势在于不会破坏类的封装性，而且继承是一种耦合度较大的静态关系，无法在程序运行时动态扩展。在软件开发阶段，关联关系虽然不会比继承关系减少编码量，但是到了软件维护阶段，由于关联关系使系统具有较好的松耦合性，因此使得系统更加容易维护。</li><li>装饰模式把每个要装饰的功能放在单独的类中，并让这个类包装它所要装饰的对象，因此，当需要执行特殊行为时，客户端代码就可以在运行时根据需要有选择地、按顺序地使用装饰功能包装对象。</li></ul><h3 id="7-装饰模式的优点"><a href="#7-装饰模式的优点" class="headerlink" title="7. 装饰模式的优点"></a>7. 装饰模式的优点</h3><ul><li>装饰模式与继承关系的目的都是要扩展对象的功能，但是装饰模式可以提供比继承更多的灵活性。</li><li>通过使用不同的具体装饰类以及这些装饰类的排列组合，可以创造出很多不同行为的组合。可以使用多个具体装饰类来装饰同一对象，得到功能更为强大的对象。</li><li>具体构件类与具体装饰类可以独立变化，用户可以根据需要增加新的具体构件类和具体装饰类，在使用时再对其进行组合，原有代码无须改变，符合<strong>开闭原则</strong>。</li><li>有效地把类的核心职责和装饰功能区分开了。而且可以去除相关类中重复的装饰逻辑。</li></ul><h3 id="8-装饰模式的缺点"><a href="#8-装饰模式的缺点" class="headerlink" title="8. 装饰模式的缺点"></a>8. 装饰模式的缺点</h3><ul><li>使用装饰模式进行系统设计时将产生很多具体装饰类，将增加系统的复杂度，加大学习与理解的难度。</li><li>这种比继承更加灵活机动的特性，也同时意味着装饰模式比继承更加易于出错，排错也很困难，对于多次装饰的对象，调试时寻找错误可能需要逐级排查，较为烦琐。</li></ul><h3 id="9-适用场景"><a href="#9-适用场景" class="headerlink" title="9. 适用场景"></a>9. 适用场景</h3><p>以下情况可以使用装饰模式：</p><ul><li>在不影响其他对象的情况下，以动态、透明的方式给单个对象添加职责。</li><li>需要动态地给一个对象增加功能，这些功能也可以动态地被撤销。</li><li>当不能采用继承的方式对系统进行扩充或者采用继承不利于系统扩展和维护时。不能采用继承的情况主要有两类：第一类是系统中存在大量独立的扩展，为支持每一种组合将产生大量的子类，使得子类数目呈爆炸性增长；第二类是因为类定义不能继承（如final类）。</li></ul><h3 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h3><ul><li>一个装饰类的接口必须与被装饰类的接口保持相同，对于客户端来说无论是装饰之前的对象还是装饰之后的对象都可以一致对待。</li><li>尽量保持具体构件类<code>Component</code>作为一个“轻”类，也就是说不要把太多的逻辑和状态放在具体构件类中，可以通过装饰。</li><li>如果只有一个具体构件类而没有抽象构件类，那么抽象装饰类可以作为具体构件类的直接子类。</li><li>如果只有一个具体装饰类，那么就没有必要建立一个单独的<code>Decorator</code>，可以把<code>Decorator</code>和<code>ConcreteDecorator</code>的责任合并成一个类。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式之-结构型模式-适配器模式 (Adapter Pattern)</title>
      <link href="/2021/07/01/she-ji-mo-shi-zhi-jie-gou-xing-mo-shi-gua-pei-qi-mo-shi-adapter-pattern/"/>
      <url>/2021/07/01/she-ji-mo-shi-zhi-jie-gou-xing-mo-shi-gua-pei-qi-mo-shi-adapter-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="适配器模式-Adapter-Pattern"><a href="#适配器模式-Adapter-Pattern" class="headerlink" title="适配器模式 (Adapter Pattern)"></a>适配器模式 (Adapter Pattern)</h1><hr><h3 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h3><p>我的笔记本电脑的工作电压是20V，而我国的家庭用电是220V，如何让20V的笔记本电脑能够在220V的电压下工作？答案是引入一个电源适配器(AC Adapter)，俗称充电器或变压器，有了这个电源适配器，生活用电和笔记本电脑即可兼容，如图1所示：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/ac.jpg" alt="ac"></p><p>图1 电源适配器示意图</p><p>在软件开发中，有时也存在类似这种不兼容的情况，我们也可以像引入一个电源适配器一样引入一个称之为适配器的角色来协调这些存在不兼容的结构，这种设计方案即为适配器模式。</p><p>与电源适配器相似，在适配器模式中引入了一个被称为适配器(Adapter)的包装类，而它所包装的对象称为适配者(Adaptee)，即被适配的类。适配器的实现就是把客户类的请求转化为对适配者的相应接口的调用。也就是说：当客户类调用适配器的方法时，在适配器类的内部将调用适配者类的方法，而这个过程对客户类是透明的，客户类并不直接访问适配者类。因此，适配器让那些由于接口不兼容而不能交互的类可以一起工作。</p><h3 id="1-模式定义"><a href="#1-模式定义" class="headerlink" title="1. 模式定义"></a>1. 模式定义</h3><blockquote><p>适配器模式 (Adapter Pattern)：将一个接口转换成客户希望的另一个接口，使接口不兼容的那些类可以一起工作，其别名为包装器(Wrapper)。</p></blockquote><p>适配器模式既可以作为<strong>类结构型模式</strong>，也可以作为<strong>对象结构型模式</strong>。</p><ul><li>适配器模式可以将一个类的接口和另一个类的接口匹配起来，而无须修改原来的适配者接口和抽象目标类接口。</li><li>在适配器模式定义中所提及的接口是指广义的接口，它可以表示一个方法或者方法的集合。</li><li>在适配器模式中，我们通过增加一个新的适配器类来解决接口不兼容的问题，使得原本没有任何关系的类可以协同工作。根据适配器类与适配者类的关系不同，适配器模式可分为对象适配器和类适配器两种，在对象适配器模式中，适配器与适配者之间是关联关系；在类适配器模式中，适配器与适配者之间是继承（或实现）关系。在实际开发中，对象适配器的使用频率更高。</li></ul><h3 id="2-对象适配器模式结构"><a href="#2-对象适配器模式结构" class="headerlink" title="2. 对象适配器模式结构"></a>2. 对象适配器模式结构</h3><p>对象适配器模式包含如下角色：</p><ul><li><p><code>Target</code>：<strong>目标抽象类</strong></p><ul><li>目标抽象类定义客户所需接口，可以是一个抽象类或接口，也可以是具体类。</li></ul></li><li><p><code>Adaptee</code>：<strong>适配者类</strong></p><ul><li>适配者即被适配的角色，它定义了一个已经存在的接口，这个接口需要适配，适配者类一般是一个具体的类，包含了客户希望使用的业务方法，在某些情况下可能没有适配者类的源代码。</li></ul></li><li><p><code>Adapter</code>：<strong>适配器类</strong></p><ul><li>适配器可以调用另一个接口，作为一个转换器，对Adaptee和Target进行适配，适配器类是适配器模式的核心，在对象适配器中，它通过继承Targe并关联一个Adaptee对象使二者产生联系。</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/Adapter-Pattern-0.jpg" alt="Adapter-Pattern-0"></p><p>根据对象适配器模式结构图，在对象适配器中，客户端需要调用request()方法，而适配者类Adaptee没有该方法，但是它所提供的specificRequest()方法却是客户端所需要的。为了使客户端能够使用适配者类，需要提供一个包装类Adapter，即适配器类。这个包装类包装了一个适配者的实例，从而将客户端与适配者衔接起来，在适配器的request()方法中调用适配者的specificRequest()方法。因为适配器类与适配者类是关联关系（也可称之为委派关系），所以这种适配器模式称为对象适配器模式。</p><h3 id="3-适配器模式应用实例"><a href="#3-适配器模式应用实例" class="headerlink" title="3. 适配器模式应用实例"></a>3. 适配器模式应用实例</h3><p>下面通过一个实例进一步学习和理解适配器模式。</p><h3 id="实例说明"><a href="#实例说明" class="headerlink" title="实例说明"></a>实例说明</h3><blockquote><p>Sunny软件公司在很久以前曾开发了一个算法库，里面包含了一些常用的算法，例如排序算法和查找算法，在进行各类软件开发时经常需要重用该算法库中的算法。在为某学校开发教务管理系统时，开发人员发现需要对学生成绩进行排序和查找，该系统的设计人员已经开发了一个成绩操作接口ScoreOperation，在该接口中声明了排序方法<code>arraySort(array $list): array</code>和查找方法<code>arraySearch(int $needle, array $haystack): int</code>，为了提高排序和查找的效率，开发人员决定重用算法库中的快速排序算法类QuickSort和二分查找算法类BinarySearch，其中QuickSort的<code>qSort(array $list): array</code>方法实现了快速排序，BinarySearch的<code>binsearch(array $arr, int $start, int $end, int $needle): int</code>方法实现了二分查找。</p></blockquote><p>由于某些原因，现在Sunny公司开发人员已经找不到该算法库的源代码，无法直接通过复制和粘贴操作来重用其中的代码；部分开发人员已经针对ScoreOperation接口编程，如果再要求对该接口进行修改或要求大家直接使用QuickSort类和BinarySearch类将导致大量代码需要修改。</p><p>Sunny软件公司开发人员面对这个没有源码的算法库，遇到一个幸福而又烦恼的问题：如何在既不修改现有接口又不需要任何算法库代码的基础上能够实现算法库的重用？</p><p>通过分析，我们不难得知，现在Sunny软件公司面对的问题有点类似本章最开始所提到的电压问题，成绩操作接口ScoreOperation好比只支持20V电压的笔记本，而算法库好比220V的家庭用电，这两部分都没有办法再进行修改，而且它们原本是两个完全不相关的结构，如图2所示：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/algorithm.jpg" alt="algorithm"></p><p>图2 需协调的两个系统的结构示意图</p><p>解决方案：我们需要ScoreOperation接口能够和已有算法库一起工作，让它们在同一个系统中能够兼容，最好的实现方法是增加一个类似电源适配器一样的适配器角色，通过适配器来协调这两个原本不兼容的结构。</p><h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><ul><li>ScoreOperation：<code>目标抽象类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 抽象成绩操作类：目标抽象类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-06-25 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">interface</span> <span class="token class-name-definition class-name">ScoreOperation</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">arraySort</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$list</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">arraySearch</span><span class="token punctuation">(</span><span class="token keyword type-hint">int</span> <span class="token variable">$needle</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$haystack</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">int</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>QuickSort、BinarySearch： <code>适配者类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 快速排序类：适配者 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-06-25 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">QuickSort</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">qSort</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$list</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$list</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token variable">$list</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$baseValue</span> <span class="token operator">=</span> <span class="token variable">$list</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$leftArray</span> <span class="token operator">=</span> <span class="token variable">$rightArray</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">array_shift</span><span class="token punctuation">(</span><span class="token variable">$list</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$list</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$value</span> <span class="token operator">&lt;</span> <span class="token variable">$baseValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$leftArray</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token variable">$rightArray</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token variable">$leftArray</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">qSort</span><span class="token punctuation">(</span><span class="token variable">$leftArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$rightArray</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">qSort</span><span class="token punctuation">(</span><span class="token variable">$rightArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$leftArray</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$baseValue</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$rightArray</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 二分查找类：适配者 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-06-25 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">BinarySearch</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">binsearch</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$arr</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$start</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$end</span><span class="token punctuation">,</span> <span class="token keyword type-hint">int</span> <span class="token variable">$needle</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">int</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$start</span> <span class="token operator">&gt;</span> <span class="token variable">$end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$mid</span> <span class="token operator">=</span> <span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$end</span> <span class="token operator">+</span> <span class="token variable">$start</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$mid</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token variable">$needle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">binsearch</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">,</span> <span class="token variable">$start</span><span class="token punctuation">,</span> <span class="token variable">$end</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$needle</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$mid</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token variable">$needle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">binsearch</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">,</span> <span class="token variable">$start</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$end</span><span class="token punctuation">,</span> <span class="token variable">$needle</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token variable">$mid</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>OperationAdapter： <code>适配器类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 操作适配器：适配器类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-06-25 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">OperationAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">ScoreOperation</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token variable">$sortObj</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token variable">$searchObj</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">sortObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuickSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">searchObj</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BinarySearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">arraySort</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$list</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">array</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">sortObj</span><span class="token operator">-&gt;</span><span class="token function">qSort</span><span class="token punctuation">(</span><span class="token variable">$list</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">arraySearch</span><span class="token punctuation">(</span><span class="token keyword type-hint">int</span> <span class="token variable">$needle</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$haystack</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">int</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">searchObj</span><span class="token operator">-&gt;</span><span class="token function">binsearch</span><span class="token punctuation">(</span><span class="token variable">$haystack</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$haystack</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$needle</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>客户端测试代码</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/* 定义成绩数组 */</span><span class="token variable">$scores</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">69</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$operation</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OperationAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$operation</span><span class="token operator">-&gt;</span><span class="token function">arraySort</span><span class="token punctuation">(</span><span class="token variable">$scores</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token string double-quoted-string">"成绩排序结果："</span><span class="token operator">.</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//output：成绩排序结果：50,69,76,84,88,90,90,91,96</span><span class="token variable">$key1</span> <span class="token operator">=</span> <span class="token variable">$operation</span><span class="token operator">-&gt;</span><span class="token function">arraySearch</span><span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$key2</span> <span class="token operator">=</span> <span class="token variable">$operation</span><span class="token operator">-&gt;</span><span class="token function">arraySearch</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$key3</span> <span class="token operator">=</span> <span class="token variable">$operation</span><span class="token operator">-&gt;</span><span class="token function">arraySearch</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token string double-quoted-string">"查找成绩为90的索引位置："</span><span class="token operator">.</span><span class="token variable">$key1</span><span class="token punctuation">;</span>   <span class="token comment">//output：查找成绩为90的索引位置：5</span><span class="token keyword">echo</span> <span class="token string double-quoted-string">"查找成绩84的索引位置："</span><span class="token operator">.</span><span class="token variable">$key2</span><span class="token punctuation">;</span>   <span class="token comment">//output：查查找成绩84的索引位置：3</span><span class="token keyword">echo</span> <span class="token string double-quoted-string">"查找成绩100的索引位置："</span><span class="token operator">.</span><span class="token variable">$key3</span><span class="token punctuation">;</span>  <span class="token comment">//output：查找成绩100的索引位置：-1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-UML类图"><a href="#4-UML类图" class="headerlink" title="4. UML类图"></a>4. UML类图</h3><p>示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/AdapterPattern-1.png" alt="AdapterPattern-1"></p><h3 id="5-适配器模式的优点"><a href="#5-适配器模式的优点" class="headerlink" title="5. 适配器模式的优点"></a>5. 适配器模式的优点</h3><p>适配器模式的主要优点如下：</p><p>(1)将目标类和适配者类解耦，通过引入一个适配器类来重用现有的适配者类，无须修改原有结构。</p><p>(2)增加了类的透明性和复用性，将具体的业务实现过程封装在适配者类中，对于客户端类而言是透明的，而且提高了适配者的复用性，同一个适配者类可以在多个不同的系统中复用。</p><p>(3)一个对象适配器可以把多个不同的适配者适配到同一个目标。</p><h3 id="6-适配器模式的缺点"><a href="#6-适配器模式的缺点" class="headerlink" title="6. 适配器模式的缺点"></a>6. 适配器模式的缺点</h3><p>类适配器模式的主要缺点如下：</p><p>(1)PHP不支持多继承，一次最多只能适配一个适配者类，不能同时适配多个适配者；但可以通过<code>Trait</code>来减少单继承的限制。</p><p>(2)适配者类不能为最终类，如在PHP中不能为final类；</p><p>对象适配器模式的缺点如下：</p><p>与类适配器模式相比，要在适配器中置换适配者类的某些方法比较麻烦。如果一定要置换掉适配者类的一个或多个方法，可以先做一个适配者类的子类，将适配者类的方法置换掉，然后再把适配者类的子类当做真正的适配者进行适配，实现过程较为复杂。</p><h3 id="7-适配器模式适用场景"><a href="#7-适配器模式适用场景" class="headerlink" title="7.适配器模式适用场景"></a>7.适配器模式适用场景</h3><p>在以下情况下可以考虑使用适配器模式：</p><p>(1)系统需要使用一些现有的类，而这些类的接口（如方法名）不符合系统的需要，甚至没有这些类的源代码。</p><p>(2) 想创建一个可以重复使用的类，用于与一些彼此之间没有太大关联的一些类，包括一些可能在将来引进的类一起工作。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式之-创建型模式-原型模式 (Prototype Pattern)</title>
      <link href="/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-yuan-xing-mo-shi-prototype-pattern/"/>
      <url>/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-yuan-xing-mo-shi-prototype-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="原型模式-Prototype-Pattern"><a href="#原型模式-Prototype-Pattern" class="headerlink" title="原型模式 (Prototype Pattern)"></a>原型模式 (Prototype Pattern)</h1><hr><h3 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h3><p>有些时候，我们需要创建多个类似的大对象，如果每次去new，初始化开销很大，这个时候我们先new一个模版对象，然后其它实例都去clone这个模版，这样可以节约不少性能。这个模版就是原型（Prototype）,原型模式比单纯的clone要稍微升级一下。</p><h3 id="1-模式定义"><a href="#1-模式定义" class="headerlink" title="1. 模式定义"></a>1. 模式定义</h3><p>原型模式 (Prototype Pattern)：它属于对象<strong>创建型模式</strong>。用原型实例指定创建对象的种类，并且通过拷贝这些原型创建新的对象。</p><h3 id="2-模式结构"><a href="#2-模式结构" class="headerlink" title="2. 模式结构"></a>2. 模式结构</h3><p>原型模式包含如下角色：</p><ul><li><p><code>Prototype</code>：<strong>抽象原型角色</strong></p><ul><li>声明一个克隆自身的接口。</li></ul></li><li><p><code>ConcretePrototype</code>：<strong>具体原型角色</strong></p><ul><li>实现一个克隆自身的操作。</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/PrototypePattern-0.png" alt="PrototypePattern-0"></p><h3 id="3-浅复制和深复制"><a href="#3-浅复制和深复制" class="headerlink" title="3. 浅复制和深复制"></a>3. 浅复制和深复制</h3><p>用示例说明一下PHP中浅复制和深复制</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 员工类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-04-21 14:14:48 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Person</span><span class="token punctuation">{</span>    <span class="token comment">/**     * @var string     */</span>    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token comment">/**     * @var Account     */</span>    <span class="token keyword">public</span> <span class="token variable">$account</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Account</span> <span class="token variable">$account</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">account</span> <span class="token operator">=</span> <span class="token variable">$account</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 账户类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-04-21 14:22:04 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Account</span><span class="token punctuation">{</span>    <span class="token comment">/**     * @var float     */</span>    <span class="token keyword">public</span> <span class="token variable">$balance</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token keyword type-hint">float</span> <span class="token variable">$balance</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">balance</span> <span class="token operator">=</span> <span class="token variable">$balance</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$p1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'小明'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token number">10000.00</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$p2</span> <span class="token operator">=</span> <span class="token keyword">clone</span> <span class="token variable">$p1</span><span class="token punctuation">;</span><span class="token variable">$p1</span><span class="token operator">-&gt;</span><span class="token property">account</span><span class="token operator">-&gt;</span><span class="token property">balance</span> <span class="token operator">=</span> <span class="token number">20000.00</span><span class="token punctuation">;</span><span class="token variable">$p1</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'小王'</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$p1</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//小王</span><span class="token keyword">echo</span> <span class="token variable">$p1</span><span class="token operator">-&gt;</span><span class="token property">account</span><span class="token operator">-&gt;</span><span class="token property">balance</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//20000</span><span class="token keyword">echo</span> <span class="token variable">$p2</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//小明</span><span class="token keyword">echo</span> <span class="token variable">$p2</span><span class="token operator">-&gt;</span><span class="token property">account</span><span class="token operator">-&gt;</span><span class="token property">balance</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//20000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>示例结果可以看出<code>$p2</code>对象是<code>$p1</code>clone后的一个副本，修改了<code>$p1</code>对象<code>name</code>值后<code>$p2</code>的<code>name</code>值并未改变（是我们所期望的），但<code>$p1</code>中的<code>account</code>属性是一个指向<code>Account</code>对象的引用，clone后<code>$p2</code>和原来的<code>$p1</code>的<code>account</code>还是指向同一个对象（这显然不是我们所期望的），这就是<strong>浅复制</strong></li></ul><p>改造<code>Person</code>类后的<strong>深复制</strong></p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 员工类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-04-21 14:14:48 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Person</span><span class="token punctuation">{</span>    <span class="token comment">/**     * @var string     */</span>    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token comment">/**     * @var Account     */</span>    <span class="token keyword">public</span> <span class="token variable">$account</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Account</span> <span class="token variable">$account</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">account</span> <span class="token operator">=</span> <span class="token variable">$account</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">account</span> <span class="token operator">=</span> <span class="token keyword">clone</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">account</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$p1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'小明'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token number">10000.00</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$p2</span> <span class="token operator">=</span> <span class="token keyword">clone</span> <span class="token variable">$p1</span><span class="token punctuation">;</span><span class="token variable">$p1</span><span class="token operator">-&gt;</span><span class="token property">account</span><span class="token operator">-&gt;</span><span class="token property">balance</span> <span class="token operator">=</span> <span class="token number">20000.00</span><span class="token punctuation">;</span><span class="token variable">$p1</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'小王'</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$p1</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//小王</span><span class="token keyword">echo</span> <span class="token variable">$p1</span><span class="token operator">-&gt;</span><span class="token property">account</span><span class="token operator">-&gt;</span><span class="token property">balance</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//20000</span><span class="token keyword">echo</span> <span class="token variable">$p2</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//小明</span><span class="token keyword">echo</span> <span class="token variable">$p2</span><span class="token operator">-&gt;</span><span class="token property">account</span><span class="token operator">-&gt;</span><span class="token property">balance</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//10000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-基于深复制的原型模式示例"><a href="#4-基于深复制的原型模式示例" class="headerlink" title="4. 基于深复制的原型模式示例"></a>4. 基于深复制的原型模式示例</h3><p>我们现在正开发一个游戏，有不同的地图，地图大小都是一样的，并且都有海洋，但是不同的地图温度不一样。</p><ul><li>MapPrototype：抽象原型类</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 抽象地图原型类，地图有长、宽、海洋 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-04-21 13:45:27 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">MapPrototype</span><span class="token punctuation">{</span>    <span class="token comment">/**     * @var int     */</span>    <span class="token keyword">public</span> <span class="token variable">$width</span><span class="token punctuation">;</span>    <span class="token comment">/**     * @var int     */</span>    <span class="token keyword">public</span> <span class="token variable">$height</span><span class="token punctuation">;</span>    <span class="token comment">/**     * @var Sea     */</span>    <span class="token keyword">public</span> <span class="token variable">$sea</span><span class="token punctuation">;</span>    <span class="token comment">/**     * @param array $attributes     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setAttribute</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$attributes</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$attributes</span> <span class="token keyword">as</span> <span class="token variable">$key</span><span class="token operator">=&gt;</span><span class="token variable">$val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$val</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * @return void     */</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Map：具体原型类</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 具体原型类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-04-21 13:50:40 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Map</span> <span class="token keyword">extends</span> <span class="token class-name">MapPrototype</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">sea</span>  <span class="token operator">=</span> <span class="token keyword">clone</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">sea</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Sea：海洋类</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 海洋类 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-04-21 13:52:16 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Sea</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$color</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'蓝色'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-客户端的使用"><a href="#5-客户端的使用" class="headerlink" title="5. 客户端的使用"></a>5. 客户端的使用</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//先创建一个原型对象</span><span class="token variable">$mapPrototype</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">;</span><span class="token variable">$mapPrototype</span><span class="token operator">-&gt;</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'width'</span><span class="token operator">=&gt;</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'height'</span><span class="token operator">=&gt;</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sea'</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Sea</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//原型对象已经有了（模版已经有了），如果我们需要一个新的map对象只需要克隆一下模版就行</span><span class="token variable">$newMap1</span> <span class="token operator">=</span> <span class="token keyword">clone</span> <span class="token variable">$mapPrototype</span><span class="token punctuation">;</span><span class="token variable">$newMap1</span><span class="token operator">-&gt;</span><span class="token property">sea</span><span class="token operator">-&gt;</span><span class="token property">color</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'深蓝'</span><span class="token punctuation">;</span> <span class="token comment">//给第一张地图的海洋换个颜色</span><span class="token keyword">echo</span> <span class="token variable">$newMap1</span><span class="token operator">-&gt;</span><span class="token property">sea</span><span class="token operator">-&gt;</span><span class="token property">color</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//深蓝</span><span class="token comment">//需要第二张地图只需再克隆一下模版</span><span class="token variable">$newMap2</span> <span class="token operator">=</span> <span class="token keyword">clone</span> <span class="token variable">$mapPrototype</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$newMap2</span><span class="token operator">-&gt;</span><span class="token property">sea</span><span class="token operator">-&gt;</span><span class="token property">color</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span> <span class="token comment">//蓝色，可以看出修改地图1海洋颜色并不影响地图2的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>我们可以发现利用原型模式，只需要实例并初始化一个地图原型对象。以后如果需要生产一个新的地图对象，都可以直接通过clone原型对象产生。省去了重新初始化的过程。</li></ul><h3 id="6-UML类图"><a href="#6-UML类图" class="headerlink" title="6. UML类图"></a>6. UML类图</h3><p>原型模式实现的地图示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/PrototypePattern-1.png" alt="PrototypePattern-1"></p><h3 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h3><ul><li>原型模式是创建型模式的一种，其特点在于通过<strong>复制</strong>一个已经存在的实例来返回新的实例,而不是新建实例。被复制的实例就是我们所称的<strong>原型</strong>，这个原型是可定制的。</li><li>原型模式多用于创建复杂的或者耗时的实例，因为这种情况下，复制一个已经存在的实例使程序运行更高效；或者创建值相等，只是命名不一样的同类数据。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式之-创建型模式-建造者模式 (Builder Pattern)</title>
      <link href="/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-jian-zao-zhe-mo-shi-builder-pattern/"/>
      <url>/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-jian-zao-zhe-mo-shi-builder-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="建造者模式-Builder-Pattern"><a href="#建造者模式-Builder-Pattern" class="headerlink" title="建造者模式 (Builder Pattern)"></a>建造者模式 (Builder Pattern)</h1><hr><h3 id="0-建造者模式概述"><a href="#0-建造者模式概述" class="headerlink" title="0. 建造者模式概述"></a>0. 建造者模式概述</h3><p>无论是在现实世界中还是在软件系统中，都存在一些复杂的对象，它们拥有多个组成部分，如汽车，它包括车轮、方向盘、发动机等各种部件。而对于大多数用户而言，无须知道这些部件的装配细节，也几乎不会使用单独某个部件，而是使用一辆完整的汽车，可以通过建造者模式对其进行设计与描述，建造者模式可以将部件和其组装过程分开，一步一步创建一个复杂的对象。用户只需要指定复杂对象的类型就可以得到该对象，而无须知道其内部的具体构造细节。</p><p>在软件开发中，也存在大量类似汽车一样的复杂对象，它们拥有一系列成员属性，这些成员属性中有些是引用类型的成员对象。而且在这些复杂对象中，还可能存在一些限制条件，如某些属性没有赋值则复杂对象不能作为一个完整的产品使用；有些属性的赋值必须按照某个顺序，一个属性没有赋值之前，另一个属性可能无法赋值等。</p><p>复杂对象相当于一辆有待建造的汽车，而对象的属性相当于汽车的部件，建造产品的过程就相当于组合部件的过程。由于组合部件的过程很复杂，因此，这些部件的组合过程往往被“外部化”到一个称作建造者的对象里，建造者返还给客户端的是一个已经建造完毕的完整产品对象，而用户无须关心该对象所包含的属性以及它们的组装方式，这就是建造者模式的模式动机。</p><h3 id="1-模式定义"><a href="#1-模式定义" class="headerlink" title="1. 模式定义"></a>1. 模式定义</h3><blockquote><p>建造者模式 (Builder Pattern)：将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建不同的表示。</p></blockquote><p>建造者模式又称为生成器模式，它是一种<strong>对象创建型模式</strong>。</p><h3 id="2-模式结构"><a href="#2-模式结构" class="headerlink" title="2. 模式结构"></a>2. 模式结构</h3><p>建造者模式包含如下角色：</p><ul><li><p><code>Builder</code>：<strong>抽象建造者</strong></p><ul><li>它为创建一个产品Product对象的各个部件指定抽象接口，在该接口中一般声明两类方法，一类方法是buildPartX()，它们用于创建复杂对象的各个部件；另一类方法是getResult()，它们用于返回复杂对象。Builder既可以是抽象类，也可以是接口。</li></ul></li><li><p><code>ConcreteBuilder</code>：<strong>具体建造者</strong></p><ul><li>它实现了Builder接口，实现各个部件的具体构造和装配方法，定义并明确它所创建的复杂对象，也可以提供一个方法返回创建好的复杂产品对象。</li></ul></li><li><p><code>Product</code>：<strong>产品角色</strong></p><ul><li>它是被构建的复杂对象，包含多个组成部件，具体建造者创建该产品的内部表示并定义它的装配过程。</li></ul></li><li><p><code>Director</code>：<strong>指挥者</strong></p><ul><li>指挥者又称为导演类，它负责安排复杂对象的建造次序，指挥者与抽象建造者之间存在关联关系，可以在其construct()建造方法中调用建造者对象的部件构造与装配方法，完成复杂对象的建造。客户端一般只需要与指挥者进行交互，在客户端确定具体建造者的类型，并实例化具体建造者对象，然后通过指挥者类的构造函数或者Setter方法将该对象传入指挥者类中。</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/BuilderPattern-0.png" alt="BuilderPattern-0"></p><h3 id="3-模式实现"><a href="#3-模式实现" class="headerlink" title="3. 模式实现"></a>3. 模式实现</h3><ul><li><p>建造者模式是较为复杂的创建型模式，它将客户端与包含多个组成部分（或部件）的复杂对象的创建过程分离，客户端无须知道复杂对象的内部组成部分与装配方式，只需要知道所需建造者的类型即可。它关注如何一步一步创建一个的复杂对象，不同的具体建造者定义了不同的创建过程，且具体建造者相互独立，增加新的建造者非常方便，无须修改已有代码，系统具有较好的扩展性。</p></li><li><p>在建造者模式的结构中引入了一个指挥者类Director，该类主要有两个作用：一方面它隔离了客户端与产品创建的过程；另一方面它控制产品的创建过程，包括某个buildPartX()方法是否被调用以及多个buildPartX()方法调用的先后次序等。指挥者针对抽象建造者编程，客户端只需要知道具体建造者的类型，即可通过指挥者类调用建造者的相关方法，返回一个完整的产品对象。</p></li></ul><h3 id="4-建造者模式应用实例"><a href="#4-建造者模式应用实例" class="headerlink" title="4. 建造者模式应用实例"></a>4. 建造者模式应用实例</h3><p>下面通过一个实例进一步学习和理解建造者模式。</p><h3 id="实例说明"><a href="#实例说明" class="headerlink" title="实例说明"></a>实例说明</h3><p>现在需要开发一个创建RPG游戏角色的功能，像大多数RPG游戏一样不同类型的游戏角色，其性别、脸型、服装、发型等外部特性都有所差异，例如“天使”拥有美丽的面容和披肩的长发，并身穿一袭白裙；而“恶魔”极其丑陋，留着光头并穿一件刺眼的黑衣。</p><p>现使用建造者模式来实现游戏角色的创建。</p><h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><ul><li>Actor：<code>产品角色类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 游戏角色类(复杂产品类)，本例子成员属性(部件或零件)都是很简单的string，真实情况下 *可能会存在多个成员属性是其它类的对象，所以才构成一个复杂对象 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-12 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">Actor</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 角色类型     * @var string     */</span>    <span class="token keyword">private</span> <span class="token variable">$type</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 角色性别     * @var string     */</span>    <span class="token keyword">private</span> <span class="token variable">$sex</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 角色脸形     * @var string     */</span>    <span class="token keyword">private</span> <span class="token variable">$face</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 角色服装     * @var string     */</span>    <span class="token keyword">private</span> <span class="token variable">$constume</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 角色发型     * @var string     */</span>    <span class="token keyword">private</span> <span class="token variable">$hairstype</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setType</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$type</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">type</span> <span class="token operator">=</span> <span class="token variable">$type</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setSex</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$sex</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">sex</span> <span class="token operator">=</span> <span class="token variable">$sex</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setFace</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$face</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">face</span> <span class="token operator">=</span> <span class="token variable">$face</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setConstume</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$constume</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">constume</span> <span class="token operator">=</span> <span class="token variable">$constume</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setHairstype</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$hairstype</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">hairstype</span> <span class="token operator">=</span> <span class="token variable">$hairstype</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">type</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">sex</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">face</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getConstume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">constume</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getHairstype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">string</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">hairstype</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ActorBuilder： <code>抽象建造者类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 角色建造器：抽象建造者 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-12 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">ActorBuilder</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 游戏角色产品对象     * @var Actor     */</span>    <span class="token keyword">protected</span> <span class="token variable">$actor</span><span class="token punctuation">;</span>    <span class="token comment">/**     *+-----------------------------------------------------------     *| 这里ActorBuilder 与 Actor 表现为组合关系。     *|----------------------------------------------------------     *| ActorBuilder为整体对象，Actor为成员对象。     *|-----------------------------------------------------------     *| 组合关系表示类之间整体和部分的关系，成员对象与整体对象之间     *| 具有同生共死的关系，一旦整体对象不存在，成员对象也将不存在。     *+-----------------------------------------------------------     *| 组合关系通常通过在整体类的构造方法中直接实例化成员类。     *+-----------------------------------------------------------     *     * @return Actor     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Actor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildConstume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildHairstyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 返回一个构建好的完整的游戏角色对象     *     * @return Actor     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createActor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Actor</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>HeroBuilder、AngelBuilder、DevilBuilder： <code>具体建造类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 英雄角色建造器：具体建造者 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-12 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HeroBuilder</span> <span class="token keyword">extends</span> <span class="token class-name">ActorBuilder</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'英雄'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setSex</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'男'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setFace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'英俊'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildConstume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setConstume</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'盔甲'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildHairstyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setHairstype</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'飘逸'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 天使角色建造器：具体建造者 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-12 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">AngelBuilder</span> <span class="token keyword">extends</span> <span class="token class-name">ActorBuilder</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'天使'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setSex</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'女'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setFace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'漂亮'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildConstume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setConstume</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'白裙'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildHairstyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setHairstype</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'披肩长发'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 恶魔角色建造器：具体建造者 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-12 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">DevilBuilder</span> <span class="token keyword">extends</span> <span class="token class-name">ActorBuilder</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'恶魔'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setSex</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'妖'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setFace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'丑陋'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildConstume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setConstume</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'黑衣'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">buildHairstyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">actor</span><span class="token operator">-&gt;</span><span class="token function">setHairstype</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'光头'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ActorDirector： <code>指挥者类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 游戏角色创建者：指挥者 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-12 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">ActorDirector</span><span class="token punctuation">{</span>    <span class="token comment">/**     * 逐步构建复杂产品对象     *+-----------------------------------------------------------     *| 这里ActorDirector 与 ActorBuilder 表现为是依赖关系。     *+-----------------------------------------------------------     *|依赖关系通常有三种方式来实现     *|1.将一个类的对象作为另一个类中方法的参数     *|2.一个类的方法中将另一个类的对象作为其局部变量     *|3.在一个类的方法中调用另一个类的静态方法     *+-----------------------------------------------------------     *     * @return Actor     */</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">build</span><span class="token punctuation">(</span><span class="token class-name type-declaration">ActorBuilder</span> <span class="token variable">$actorBuilder</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Actor</span>    <span class="token punctuation">{</span>        <span class="token variable">$actorBuilder</span><span class="token operator">-&gt;</span><span class="token function">buildType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$actorBuilder</span><span class="token operator">-&gt;</span><span class="token function">buildSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$actorBuilder</span><span class="token operator">-&gt;</span><span class="token function">buildFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$actorBuilder</span><span class="token operator">-&gt;</span><span class="token function">buildConstume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$actorBuilder</span><span class="token operator">-&gt;</span><span class="token function">buildHairstyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$actorBuilder</span><span class="token operator">-&gt;</span><span class="token function">createActor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>客户端测试代码</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/* 指明要创造的具体建造者 */</span><span class="token variable">$builder</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeroBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* 实例化指挥者类 */</span><span class="token variable">$actorDirector</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActorDirector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* 通过指挥者创建完整的产品 */</span><span class="token variable">$actor</span> <span class="token operator">=</span> <span class="token variable">$actorDirector</span><span class="token operator">-&gt;</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token variable">$builder</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token string double-quoted-string">"类型："</span><span class="token operator">.</span><span class="token variable">$actor</span><span class="token operator">-&gt;</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token operator">.</span>     <span class="token string double-quoted-string">"性别："</span><span class="token operator">.</span><span class="token variable">$actor</span><span class="token operator">-&gt;</span><span class="token function">getSex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token operator">.</span>     <span class="token string double-quoted-string">"面容："</span><span class="token operator">.</span><span class="token variable">$actor</span><span class="token operator">-&gt;</span><span class="token function">getFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token operator">.</span>     <span class="token string double-quoted-string">"服装："</span><span class="token operator">.</span><span class="token variable">$actor</span><span class="token operator">-&gt;</span><span class="token function">getConstume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token operator">.</span>     <span class="token string double-quoted-string">"发型："</span><span class="token operator">.</span><span class="token variable">$actor</span><span class="token operator">-&gt;</span><span class="token function">getHairstype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上例程会输出：</p><p>类型：英雄<br>性别：男<br>面容：英俊<br>服装：盔甲<br>发型：飘逸</p><h3 id="5-UML类图"><a href="#5-UML类图" class="headerlink" title="5. UML类图"></a>5. UML类图</h3><p>示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/BuilderPattern-1.png" alt="BuilderPattern-1"></p><h3 id="6-建造者模式的优点"><a href="#6-建造者模式的优点" class="headerlink" title="6. 建造者模式的优点"></a>6. 建造者模式的优点</h3><p>建造者模式的主要优点如下：</p><p>(1)在建造者模式中，客户端不必知道产品内部组成的细节，将产品本身与产品的创建过程解耦，使得相同的创建过程可以创建不同的产品对象。</p><p>(2)每一个具体建造者都相对独立，而与其他的具体建造者无关，因些可以很方便地替换具体建造者或增加新的具体建造者，用户使用不同的具体建造者即可得到不同的产品对象。</p><p>(3)可以更加精细地控制产品的创建过程。将复杂产品的创建步骤分解在不同的方法中，使得创建过程更加清晰，也更方便使用程序来控制创建过程。</p><p>(4)由于指挥者类针对抽象建造者编程，增加新的具体建造者无须修改原有类库的代码，系统扩展方便，符合“开闭原则”</p><h3 id="7-建造者模式的缺点"><a href="#7-建造者模式的缺点" class="headerlink" title="7. 建造者模式的缺点"></a>7. 建造者模式的缺点</h3><p>建造者模式的主要缺点如下：</p><p>(1)建造者模式所创建的产品一般具有较多的共同点，其组成部分相似，如果产品之间的差异性很大，例如很多组成部分都不相同，不适合使用建造者模式，因此其使用范围受到一定的限制。</p><p>(2)如果产品的内部变化复杂，可能会导致需要定义很多具体建造者类来实现这种变化，导致系统变得很庞大，增加系统的理解难度和运行成本。</p><h3 id="8-建造者模式适用场景"><a href="#8-建造者模式适用场景" class="headerlink" title="8. 建造者模式适用场景"></a>8. 建造者模式适用场景</h3><p>在以下情况下可以考虑使用建造者模式：</p><p>(1)需要生成的产品对象有复杂的内部结构，这些产品对象通常包含多个成员属性。</p><p>(2)需要生成的产品对象的属性相互依赖，需要指定其生成顺序。</p><p>(3)对象的创建过程独立于创建该对象的类。在建造者模式中通过引入了指挥者类，将创建过程封装在指挥者类中，而不在建造者类和客户类中。</p><p>(4)隔离复杂对象的创建和使用，并使得相同的创建过程可以创建不同的产品。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式之-创建型模式-抽象工厂模式 (Abstract Factory Pattern)</title>
      <link href="/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-chou-xiang-gong-han-mo-shi-abstract-factory-pattern/"/>
      <url>/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-chou-xiang-gong-han-mo-shi-abstract-factory-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="抽象工厂模式-Abstract-Factory-Pattern"><a href="#抽象工厂模式-Abstract-Factory-Pattern" class="headerlink" title="抽象工厂模式 (Abstract Factory Pattern)"></a>抽象工厂模式 (Abstract Factory Pattern)</h1><hr><h3 id="0-抽象工厂模式概述"><a href="#0-抽象工厂模式概述" class="headerlink" title="0. 抽象工厂模式概述"></a>0. 抽象工厂模式概述</h3><p>在工厂方法模式中具体工厂负责生产具体的产品，每一个具体工厂对应一种具体产品，工厂方法具有唯一性，一般情况下，一个具体工厂中只有一个或者一组重载的工厂方法。但是有时候我们希望一个工厂可以提供多个产品对象，而不是单一的产品对象，如一个电器工厂，它可以生产电视机、电冰箱、空调等多种电器，而不是只生产某一种电器。为了更好地理解抽象工厂模式，我们先引入两个概念：</p><p>(1)产品等级结构：产品等级结构即产品的继承结构，如一个抽象类是电视机，其子类有海尔电视机、海信电视机、TCL电视机，则抽象电视机与具体品牌的电视机之间构成了一个产品等级结构，抽象电视机是父类，而具体品牌的电视机是其子类。</p><p>(2)产品族：在抽象工厂模式中，产品族是指由同一个工厂生产的，位于不同产品等级结构中的一组产品，如海尔电器工厂生产的海尔电视机、海尔电冰箱，海尔电视机位于电视机产品等级结构中，海尔电冰箱位于电冰箱产品等级结构中，海尔电视机、海尔电冰箱构成了一个产品族。</p><p>产品等级结构与产品族示意图如图1所示：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/1.jpg" alt="1"></p><p>图1 产品族与产品等级结构示意图</p><p>在图1中，不同颜色的多个正方形、圆形和椭圆形分别构成了三个不同的产品等级结构，而相同颜色的正方形、圆形和椭圆形构成了一个产品族，每一个形状对象都位于某个产品族，并属于某个产品等级结构。图1中一共有五个产品族，分属于三个不同的产品等级结构。我们只要指明一个产品所处的产品族以及它所属的等级结构，就可以唯一确定这个产品。</p><p>当系统所提供的工厂生产的具体产品并不是一个简单的对象，而是多个位于不同产品等级结构、属于不同类型的具体产品时就可以使用抽象工厂模式。抽象工厂模式是所有形式的工厂模式中最为抽象和最具一般性的一种形式。抽象工厂模式与工厂方法模式最大的区别在于，工厂方法模式针对的是一个产品等级结构，而抽象工厂模式需要面对多个产品等级结构，一个工厂等级结构可以负责多个不同产品等级结构中的产品对象的创建。当一个工厂等级结构可以创建出分属于不同产品等级结构的一个产品族中的所有对象时，抽象工厂模式比工厂方法模式更为简单、更有效率。抽象工厂模式示意图如图2所示：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/2.jpg" alt="2"></p><p>图2 抽象工厂模式示意图</p><h3 id="1-模式定义"><a href="#1-模式定义" class="headerlink" title="1. 模式定义"></a>1. 模式定义</h3><blockquote><p>抽象工厂模式 (Abstract Factory Pattern)：提供一个创建一系列相关或相互依赖对象的接口，而无须指定它们具体的类。</p></blockquote><p>抽象工厂模式是一种<strong>对象创建型模式</strong>。</p><ul><li><p>抽象工厂模式为创建一组对象提供了一种解决方案。与工厂方法模式相比，抽象工厂模式中的具体工厂不只是创建一种产品，它负责创建一族产品。</p></li><li><p>在抽象工厂模式中，每一个具体工厂都提供了多个工厂方法用于产生多种不同类型的产品，这些产品构成了一个产品族。</p></li></ul><h3 id="2-模式结构"><a href="#2-模式结构" class="headerlink" title="2. 模式结构"></a>2. 模式结构</h3><p>抽象工厂模式包含如下角色：</p><ul><li><p><code>AbstractFactory</code>：<strong>抽象工厂</strong></p><ul><li>它声明了一组用于创建一族产品的方法，每一个方法对应一种产品。</li></ul></li><li><p><code>ConcreteFactory</code>：<strong>具体工厂</strong></p><ul><li>它实现了在抽象工厂中声明的创建产品的方法，生成一组具体产品，这些产品构成了一个产品族，每一个产品都位于某个产品等级结构中。</li></ul></li><li><p><code>AbstractProduct</code>：<strong>抽象产品</strong></p><ul><li>它为每种产品声明接口，在抽象产品中声明了产品所具有的业务方法。</li></ul></li><li><p><code>ConcreteProduct</code>：<strong>具体产品</strong></p><ul><li>它定义具体工厂生产的具体产品对象，实现抽象产品接口中声明的业务方法。</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/AbstractFactoryPattern-0.jpg" alt="AbstractFactoryPattern-0"></p><h3 id="3-抽象工厂模式应用实例"><a href="#3-抽象工厂模式应用实例" class="headerlink" title="3. 抽象工厂模式应用实例"></a>3. 抽象工厂模式应用实例</h3><p>下面通过一个实例进一步学习和理解抽象工厂模式。</p><h3 id="实例说明"><a href="#实例说明" class="headerlink" title="实例说明"></a>实例说明</h3><p>我们就以生产家用电器的例子来学习下抽象工厂模式，现有多个工厂，每个工厂都生产自己品牌电视机、冰箱、洗衣机；客户端可以很灵活的选择某个工厂生产的一系列产品，也能方便的增加新的工厂。</p><h3 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h3><ul><li>HomeAppliancesFactory：<code>抽象工厂类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 家用电器工厂接口：抽象工厂 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">HomeAppliancesFactory</span><span class="token punctuation">{</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createTv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createIceBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createWasher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>HaierFactory、MideaFactory： <code>具体工厂</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * Haier工厂：具体工厂 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HaierFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HomeAppliancesFactory</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createTv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">HaierTv</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HaierTv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createIceBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">HaierIceBox</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HaierIceBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createWasher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">HaierWasher</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HaierWasher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * Midea工厂：具体工厂 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">MideaFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HomeAppliancesFactory</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createTv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">MideaTv</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MideaTv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createIceBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">MideaIceBox</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MideaIceBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createWasher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">MideaWasher</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MideaWasher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Tv： <code>抽象产品类</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 电视机接口：抽象产品 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">interface</span> <span class="token class-name-definition class-name">Tv</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>HaierTv、MideaTv： <code>具体产品</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * Haier电视机类：具体产品 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HaierTv</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Haier电视"</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * Midea电视机类：具体产品 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">MideaTv</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Midea电视"</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>IceBox： <code>抽象产品</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 冰箱接口：抽象产品 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">interface</span> <span class="token class-name-definition class-name">IceBox</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>HaierIceBox、MideaIceBox： <code>具体产品</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * Haier冰箱类：具体产品 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HaierIceBox</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Haier冰箱"</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * Midea冰箱类：具体产品 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">MideaIceBox</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Midea冰箱"</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Washer： <code>抽象产品</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 洗衣机接口：抽象产品 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">interface</span> <span class="token class-name-definition class-name">Washer</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>HaierWasher、MideaWasher： <code>具体产品</code></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * Haier洗衣机类：具体产品 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">HaierWasher</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Haier洗衣机"</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * Midea洗衣机类：具体产品 * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-05-26 * @copyright  Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">MideaWasher</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword return-type">void</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Midea洗衣机"</span><span class="token operator">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>客户端测试代码</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//$factory = new HaierFactory();</span><span class="token variable">$factory</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MideaFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$tv</span> <span class="token operator">=</span> <span class="token variable">$factory</span><span class="token operator">-&gt;</span><span class="token function">createTv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$iceBox</span> <span class="token operator">=</span> <span class="token variable">$factory</span><span class="token operator">-&gt;</span><span class="token function">createIceBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$washer</span> <span class="token operator">=</span> <span class="token variable">$factory</span><span class="token operator">-&gt;</span><span class="token function">createWasher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$tv</span><span class="token operator">-&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$iceBox</span><span class="token operator">-&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$washer</span><span class="token operator">-&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上例程会输出：</p><p>Midea电视<br><br>Midea冰箱<br><br>Midea洗衣机<br></p><p>如果需要更换成Haier生产的电器则只需把 <code>new MideaFactory()</code>变为<code>new HaierFactory() </code></p><h3 id="4-UML类图"><a href="#4-UML类图" class="headerlink" title="4. UML类图"></a>4. UML类图</h3><p>示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/AbstractFactoryPattern-1.png" alt="AbstractFactoryPattern-1"></p><h3 id="5-抽象工厂模式分析"><a href="#5-抽象工厂模式分析" class="headerlink" title="5. 抽象工厂模式分析"></a>5. 抽象工厂模式分析</h3><p>在抽象工厂模式中，增加新的产品族很方便，但是增加新的产品等级结构很麻烦，抽象工厂模式的这种性质称为“开闭原则”的倾斜性。“开闭原则”要求系统对扩展开放，对修改封闭，通过扩展达到增强其功能的目的，对于涉及到多个产品族与多个产品等级结构的系统，其功能增强包括两方面：</p><p>(1)增加产品族：对于增加新的产品族，抽象工厂模式很好地支持了“开闭原则”，只需要增加具体产品并对应增加一个新的具体工厂，对已有代码无须做任何修改。</p><p>(2)增加新的产品等级结构：对于增加新的产品等级结构，需要修改所有的工厂角色，包括抽象工厂类，在所有的工厂类中都需要增加生产新产品的方法，违背了“开闭原则”。</p><p>正因为抽象工厂模式存在“开闭原则”的倾斜性，它以一种倾斜的方式来满足“开闭原则”，为增加新产品族提供方便，但不能为增加新产品结构提供这样的方便，因此要求设计人员在设计之初就能够全面考虑，不会在设计完成之后向系统中增加新的产品等级结构，也不会删除已有的产品等级结构，否则将会导致系统出现较大的修改，为后续维护工作带来诸多麻烦。</p><h3 id="6-抽象工厂模式的优点"><a href="#6-抽象工厂模式的优点" class="headerlink" title="6. 抽象工厂模式的优点"></a>6. 抽象工厂模式的优点</h3><p>抽象工厂模式的主要优点如下：</p><p>(1)抽象工厂模式隔离了具体类的生成，使得客户并不需要知道什么被创建。由于这种隔离，更换一个具体工厂就变得相对容易，所有的具体工厂都实现了抽象工厂中定义的那些公共接口，因此只需改变具体工厂的实例，就可以在某种程度上改变整个软件系统的行为。</p><p>(2)当一个产品族中的多个对象被设计成一起工作时，它能够保证客户端始终只使用同一个产品族中的对象。</p><p>(3)增加新的产品族很方便，无须修改已有系统，符合“开闭原则”。</p><h3 id="7-抽象工厂模式的缺点"><a href="#7-抽象工厂模式的缺点" class="headerlink" title="7. 抽象工厂模式的缺点"></a>7. 抽象工厂模式的缺点</h3><p>抽象工厂模式的主要缺点如下：</p><p>增加新的产品等级结构麻烦，需要对原有系统进行较大的修改，甚至需要修改抽象层代码，这显然会带来较大的不便，违背了“开闭原则”。</p><h3 id="8-抽象工厂模式适用场景"><a href="#8-抽象工厂模式适用场景" class="headerlink" title="8. 抽象工厂模式适用场景"></a>8. 抽象工厂模式适用场景</h3><p>在以下情况下可以考虑使用抽象工厂模式：</p><p>(1)一个系统不应当依赖于产品类实例如何被创建、组合和表达的细节，这对于所有类型的工厂模式都是很重要的，用户无须关心对象的创建过程，将对象的创建和使用解耦。</p><p>(2)系统中有多于一个的产品族，而每次只使用其中某一产品族。用户可以动态改变产品族，也可以很方便地增加新的产品族。</p><p>(3)属于同一个产品族的产品将在一起使用，这一约束必须在系统的设计中体现出来。同一个产品族中的产品可以是没有任何关系的对象，但是它们都具有一些共同的约束，如同一品牌的电视机和冰箱，电视机与冰箱之间没有直接关系，但它们都是属于某一品牌的，此时具有一个共同的约束条件：品牌的类型。</p><p>(4)产品等级结构稳定，设计完成之后，不会向系统中增加新的产品等级结构或者删除已有的产品等级结构。</p>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式之-创建型模式-工厂方法模式 (Factory Method Pattern)</title>
      <link href="/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-gong-han-fang-fa-mo-shi-factory-method-pattern/"/>
      <url>/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-gong-han-fang-fa-mo-shi-factory-method-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="工厂方法模式-Factory-Method-Pattern"><a href="#工厂方法模式-Factory-Method-Pattern" class="headerlink" title="工厂方法模式 (Factory Method Pattern)"></a>工厂方法模式 (Factory Method Pattern)</h1><hr><h3 id="1-模式定义"><a href="#1-模式定义" class="headerlink" title="1. 模式定义"></a>1. 模式定义</h3><p>工厂方法模式 (Factory Method Pattern)：它属于类创建型模式。定义一个用于创建对象的接口，让子类决定实例化哪一个类。工厂方法模式使一个类的实例化延迟到其子类中完成。</p><h3 id="2-模式结构"><a href="#2-模式结构" class="headerlink" title="2. 模式结构"></a>2. 模式结构</h3><p>工厂方法模式包含如下角色：</p><ul><li><p>AbstractProduct: 抽象产品</p><ul><li>抽象产品角色是所有需要实例化产品类的父类</li></ul></li><li><p>ConcreteProduct：具体产品</p><ul><li>具体的产品，继承了抽象产品</li></ul></li><li><p>Factory：抽象工厂</p><ul><li>声明工厂方法，该方法返回一个AbstractProduct类型的对象</li></ul></li><li><p>ConcreteFactory：具体工厂</p><ul><li>重新定义工厂方法以返回一个ConcreteProduct类型的对象</li></ul></li></ul><h3 id="3-示例"><a href="#3-示例" class="headerlink" title="3. 示例"></a>3. 示例</h3><p>以一个简单的计算器功能来说明下各角色的应用：</p><ul><li>Operation.php：抽象产品</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 运算抽象类 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-17 14:52:15 * @copyright Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Operation</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token variable">$numberA</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token variable">$numberB</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setNumberA</span><span class="token punctuation">(</span><span class="token variable">$numberA</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberA</span> <span class="token operator">=</span> <span class="token variable">$numberA</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getNumberA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberA</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setNumberB</span><span class="token punctuation">(</span><span class="token variable">$numberB</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberB</span> <span class="token operator">=</span> <span class="token variable">$numberB</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getNumberB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberB</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>OperationAdd.php、OperationSub.php：具体产品</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 加法运算类 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-17 14:54:10 * @copyright Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">OperationAdd</span> <span class="token keyword">extends</span> <span class="token class-name">Operation</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">bcadd</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberA</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberB</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 减法运算类 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-17 14:54:26 * @copyright Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">OperationSub</span> <span class="token keyword">extends</span> <span class="token class-name">Operation</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">bcsub</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberA</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberB</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>FactoryInterface.php：抽象工厂</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 运算工厂接口类 * 定义了一个用于创建对象的接口，让其子类决定实例化哪一个类 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-17 14:56:24 * @copyright Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">interface</span> <span class="token class-name-definition class-name">FactoryInterface</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createOperate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>AddFactory.php、SubFactory.php：具体工厂</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 加法类工厂 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-17 15:01:27 * @copyright Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">AddFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryInterface</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createOperate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OperationAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 减法类工厂 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-17 17:21:41 * @copyright Copyright (c) 2018 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">SubFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryInterface</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createOperate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OperationSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-客户端的使用"><a href="#4-客户端的使用" class="headerlink" title="4. 客户端的使用"></a>4. 客户端的使用</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$addFactory</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$addOperation</span> <span class="token operator">=</span> <span class="token variable">$addFactory</span><span class="token operator">-&gt;</span><span class="token function">createOperate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$addOperation</span><span class="token operator">-&gt;</span><span class="token function">setNumberA</span><span class="token punctuation">(</span><span class="token number">2000.30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$addOperation</span><span class="token operator">-&gt;</span><span class="token function">setNumberB</span><span class="token punctuation">(</span><span class="token number">299.40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$addOperation</span><span class="token operator">-&gt;</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-UML类图"><a href="#5-UML类图" class="headerlink" title="5. UML类图"></a>5. UML类图</h3><p>工厂方法模式实现的简单计算器示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/FactoryMethodPattern.png" alt="FactoryMethodPattern"></p><h3 id="6-工厂方法模式的优点"><a href="#6-工厂方法模式的优点" class="headerlink" title="6. 工厂方法模式的优点"></a>6. 工厂方法模式的优点</h3><ul><li>基于抽象工厂和抽象产品的多态性设计是工厂方法模式的关键。它能够使工厂可以自主确定创建何种产品对象，而如何创建这个对象的细节则完全封装在具体工厂内部。</li><li>工厂方法模式是简单工厂模式的进一步抽象和推广，使得在系统中加入新产品时，无须修改抽象工厂和抽象产品，也无须修改具体工厂和具体产品，而只要添加一个具体工厂和具体产品就行。这样，系统的可扩展性也就变得非常好，完全符合“开放－封闭原则”。</li></ul><h3 id="7-工厂方法模式的缺点"><a href="#7-工厂方法模式的缺点" class="headerlink" title="7. 工厂方法模式的缺点"></a>7. 工厂方法模式的缺点</h3><ul><li>在添加新产品时，需要编写新的具体工厂类和具体产品类，系统中类的个数将成对增加，在一定程度上增加了系统的复杂度和额外的开放量，有更多的类需要加载和解析，会给系统带来一些额外的开销。</li><li>由于引入了抽象工厂类和抽象产品类，增加了系统的抽象性和理解难度。</li></ul><h3 id="8-适用场景"><a href="#8-适用场景" class="headerlink" title="8. 适用场景"></a>8. 适用场景</h3><p>以下情况可以使用简单工厂方法模式：</p><ul><li>客户端不知道它所需要的对象的类：在工厂方法模式中，客户端不需要知道具体产品类的类名，只需要知道其所对应的工厂即可，具体的产品由具体工厂类创建，客户端需要知道创建具体产品的工厂类。</li><li>一个类通过其子类来指定创建哪个对象：在工厂方法模式中，对于抽象工厂类只需要提供一个创建产品的接口，而由其子类来确定具体要创建的对象，利用面向对象的多态性和里氏代换原则，在程序运行时，子类将覆盖父类的方法，从而使得系统更容易扩展。</li></ul><h3 id="9-模式扩展"><a href="#9-模式扩展" class="headerlink" title="9. 模式扩展"></a>9. 模式扩展</h3><ul><li>多态性的丧失和模式的退化：一般来说，具体工厂类应当有一个抽象工厂父类，如果只有一个具体工厂类的话，抽象工厂父类就可以省略，也将发生退化。当只有一个具体工厂类时，在具体工厂类中可以创建所有的具体产品对象，并且具体工厂类中的方法设计为静态方法时，工厂模式就退化成简单工厂模式。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式之-创建型模式-简单工厂模式 (Simple Factory Pattern)</title>
      <link href="/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-jian-dan-gong-han-mo-shi-simple-factory-pattern/"/>
      <url>/2021/06/30/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-jian-dan-gong-han-mo-shi-simple-factory-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="简单工厂模式-Simple-Factory-Pattern"><a href="#简单工厂模式-Simple-Factory-Pattern" class="headerlink" title="简单工厂模式 (Simple Factory Pattern)"></a>简单工厂模式 (Simple Factory Pattern)</h1><hr><h3 id="1-模式定义"><a href="#1-模式定义" class="headerlink" title="1. 模式定义"></a>1. 模式定义</h3><p>简单工厂模式(Simple Factory Pattern)：又称为静态工厂方法(Static Factory Method)模式，它属于类创建型模式。在简单工厂模式中，可以根据参数的不同返回不同的实例。简单工厂模式专门定义一个类来负责创建其他类的实例，被创建的实例通常都具有相同的接口或父类。</p><h3 id="2-模式结构"><a href="#2-模式结构" class="headerlink" title="2. 模式结构"></a>2. 模式结构</h3><p>简单工厂模式包含如下角色：</p><ul><li><p>Factory：工厂</p><ul><li>工厂负责实现创建所需类的实例</li></ul></li><li><p>AbstractProduct: 抽象产品</p><ul><li>抽象产品是所有具体产品类的父类</li></ul></li><li><p>ConcreteProduct：具体产品</p><ul><li>具体产品是创建目标</li></ul></li></ul><h3 id="3-示例"><a href="#3-示例" class="headerlink" title="3. 示例"></a>3. 示例</h3><p>以一个简单的计算器功能来说明下各角色的应用：</p><ul><li>OperationFactory.php：工厂</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 运算工厂类 * 一、根据不同的参数来创建加法、减法类等实例。 * 二、通常createOperate方法为公开的静态方法。 * 三、通常createOperate方法中包含简单的switch...case判断逻辑。 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-08 20:03:21 * @copyright Copyright (c) 2017 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">OperationFactory</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">createOperate</span><span class="token punctuation">(</span><span class="token variable">$operate</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$operation</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$operate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token string single-quoted-string">'+'</span><span class="token punctuation">:</span>                <span class="token variable">$operation</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OperationAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string single-quoted-string">'-'</span><span class="token punctuation">:</span>                <span class="token variable">$operation</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OperationSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$operation</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Operation.php：抽象产品</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 运算抽象类 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-08 20:00:07 * @copyright Copyright (c) 2017 dendi875@163.com */</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Operation</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token variable">$numberA</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token variable">$numberB</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setNumberA</span><span class="token punctuation">(</span><span class="token variable">$numberA</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberA</span> <span class="token operator">=</span> <span class="token variable">$numberA</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getNumberA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberA</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setNumberB</span><span class="token punctuation">(</span><span class="token variable">$numberB</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberB</span> <span class="token operator">=</span> <span class="token variable">$numberB</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getNumberB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberB</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>OperationAdd.php、OperationSub.php：具体产品</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/** * 加法运算类 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-08 20:02:42 * @copyright Copyright (c) 2017 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">OperationAdd</span> <span class="token keyword">extends</span> <span class="token class-name">Operation</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">bcadd</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberA</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberB</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * 减法运算类 * * @author    &lt;dendi875@163.com&gt; * @createDate 2018-03-08 20:03:01 * @copyright Copyright (c) 2017 dendi875@163.com */</span><span class="token keyword">class</span> <span class="token class-name-definition class-name">OperationSub</span> <span class="token keyword">extends</span> <span class="token class-name">Operation</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">bcsub</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberA</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">numberB</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-客户端的使用"><a href="#4-客户端的使用" class="headerlink" title="4. 客户端的使用"></a>4. 客户端的使用</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$operation</span> <span class="token operator">=</span> <span class="token class-name static-context">OperationFactory</span><span class="token operator">::</span><span class="token function">createOperate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$operation</span><span class="token operator">-&gt;</span><span class="token function">setNumberA</span><span class="token punctuation">(</span><span class="token number">2000.30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$operation</span><span class="token operator">-&gt;</span><span class="token function">setNumberB</span><span class="token punctuation">(</span><span class="token number">299.40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$operation</span><span class="token operator">-&gt;</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-UML类图"><a href="#5-UML类图" class="headerlink" title="5. UML类图"></a>5. UML类图</h3><p>简单工厂模式实现的计算器示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/SimpleFactoryPattern-0.png" alt="SimpleFactoryPattern-0"></p><h3 id="6-简单工厂模式的优点"><a href="#6-简单工厂模式的优点" class="headerlink" title="6. 简单工厂模式的优点"></a>6. 简单工厂模式的优点</h3><ul><li>简单工厂模式的最大优点在于工厂类中包含了必要的逻辑判断，根据客户端的选择条件动态实例化相关的类，对于客户端来说，去除了与具体产品的依赖。</li><li>客户端无须知道所创建产品类的类名，只需要知道具体产品类所对应的参数，对于一些复杂的类名，通过简单工厂模式可以减少使用者的记忆量</li></ul><h3 id="7-简单工厂模式的缺点"><a href="#7-简单工厂模式的缺点" class="headerlink" title="7. 简单工厂模式的缺点"></a>7. 简单工厂模式的缺点</h3><ul><li>使用简单工厂模式将会增加系统中类的个数，在一定程度上增加了系统的复杂度和理解难度。</li><li>在产品类型较多时，有可能造成工厂类逻辑过于复杂，不利于系统的扩展和维护。</li><li>一旦添加新的产品就不得不修改工厂类逻辑，在工厂类的方法中增加“Case”条件分支，修改了原生的类，这就违背了开放－封闭原则</li></ul><h3 id="8-适用场景"><a href="#8-适用场景" class="headerlink" title="8. 适用场景"></a>8. 适用场景</h3><p>以下情况可以使用简单工厂模式：</p><ul><li>工厂类负责创建的对象比较少：由于创建的对象较少，不会造成工厂方法中的业务逻辑太过复杂。</li><li>客户端只关心传入工厂类的参数，对于如何创建对象不关心：客户端既不需要关心创建细节，甚至连类名都不需要记住，只需要知道各产品类所对应的参数。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式之-创建型模式-单例模式（Singleton Pattern）</title>
      <link href="/2021/06/29/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-dan-li-mo-shi-singleton-pattern/"/>
      <url>/2021/06/29/she-ji-mo-shi-zhi-chuang-jian-xing-mo-shi-dan-li-mo-shi-singleton-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="设计模式之-单例模式（Singleton-Pattern）"><a href="#设计模式之-单例模式（Singleton-Pattern）" class="headerlink" title="设计模式之-单例模式（Singleton Pattern）"></a>设计模式之-单例模式（Singleton Pattern）</h1><hr><h3 id="1-模式动机"><a href="#1-模式动机" class="headerlink" title="1. 模式动机"></a>1. 模式动机</h3><p>对于系统中的某些类来说，只有一个实例很重要，例如，一个系统只能有一个计时工具或ID（序号）生成器；一个系统中只能有一个锁定应用程序的文件。</p><p>如何保证一个类只有一个实例并且这个实例易于被访问呢？定义一个全局变量可以确保对象随时都可以被访问，但不能防止我们实例化多个对象。</p><p>一个更好的解决办法是让类自身负责保存它的唯一实例。这个类可以保证没有其他实例被创建，并且它可以提供一个访问该实例的方法。这就是单例模式的模式动机。</p><h3 id="2-模式定义"><a href="#2-模式定义" class="headerlink" title="2. 模式定义"></a>2. 模式定义</h3><p>单例模式（Singleton Pattern）：单例模式确保某一个类只有一个实例，而且自行实例化并向整个系统提供这个实例，这个类称为单例类，它提供全局访问的方法。</p><p>单例模式的要点有三个：</p><ul><li><p>一是某个类只能有一个实例</p></li><li><p>二是它必须自行创建这个实例</p></li><li><p>三是它必须自行向整个系统提供这个实例。单例模式是一种对象创建型模式。单例模式又名单件模式或单态模式</p></li></ul><h3 id="3-代码示例"><a href="#3-代码示例" class="headerlink" title="3. 代码示例"></a>3. 代码示例</h3><ul><li>Singleton.php</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * Singleton * * @author     &lt;dendi875@163.com&gt; * @createDate 2018-03-02 14:12:28 * @copyright  Copyright (c) 2019 dendi875@163.com */</span><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name-definition class-name">Singleton</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 提供一个公有的静态方法     *     * @return Singleton     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Singleton</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword static-context">static</span><span class="token operator">::</span><span class="token variable">$instance</span> <span class="token operator">===</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword static-context">static</span><span class="token operator">::</span><span class="token variable">$instance</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">static</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword static-context">static</span><span class="token operator">::</span><span class="token variable">$instance</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 不允许从外部调用，以防止创建多个实例，     * 要使用单例，必须从 Singleton::getInstance() 获取实例     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 防止实例被克隆（这将创建它的第二个实例）     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">__clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 防止被反序列化（这将创建它的第二个实例）     */</span>    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-模式分析"><a href="#4-模式分析" class="headerlink" title="4. 模式分析"></a>4. 模式分析</h3><p>单例模式的目的是保证一个类仅有一个实例，并提供一个访问它的全局访问点。单例模式包含的角色只有一个，就是单例类——<strong>Singleton</strong>。单例类拥有一个私有构造函数，确保用户无法通过<code>new</code>关键字直接实例化它。除此之外，该模式中包含一个静态私有成员变量与静态公有的方法，该方法负责检验实例的存在性并实例化自己，然后存储在静态成员变量中，以确保只有一个实例被创建。</p><p>在单例模式的实现过程中，需要注意如下三点：</p><ul><li><p>单例类的构造函数为私有</p></li><li><p>提供一个自身的静态私有成员变量</p></li><li><p>提供一个公有的静态方法</p></li></ul><h3 id="5-UML类图"><a href="#5-UML类图" class="headerlink" title="5. UML类图"></a>5. UML类图</h3><p>简单工厂模式实现的计算器示例代码UML图：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/singleton.png" alt="singleton"></p><h3 id="6-优点"><a href="#6-优点" class="headerlink" title="6. 优点"></a>6. 优点</h3><ul><li><p>提供了对唯一实例的受控访问。因为单例类封装了它的唯一实例，所以它可以严格控制客户怎样以及何时访问它，并为设计及开发团队提供了共享的概念。</p></li><li><p>由于在系统内存中只存在一个对象，因此可以节约系统资源，对于一些需要频繁创建和销毁的对象，单例模式无疑可以提高系统的性能。</p></li></ul><h3 id="7-缺点"><a href="#7-缺点" class="headerlink" title="7. 缺点"></a>7. 缺点</h3><ul><li><p>由于单例模式中没有抽象层，因此单例类的扩展有很大的困难</p></li><li><p>滥用单例将带来一些负面问题，如为了节省资源将数据库连接池对象设计为单例类，可能会导致共享连接池对象的程序过多而出现连接池溢出；现在很多面向对象语言(如Java、PHP)的运行环境都提供了自动垃圾回收的技术，因此，如果实例化的对象长时间不被利用，系统会认为它是垃圾，会自动销毁并回收资源，下次利用时又将重新实例化，这将导致对象状态的丢失。</p></li></ul><h3 id="8-适用场景"><a href="#8-适用场景" class="headerlink" title="8. 适用场景"></a>8. 适用场景</h3><p>以下情况可以使用单例模式：</p><ul><li><p>系统只需要一个实例对象，如系统要求提供一个唯一的序列号生成器，或者需要考虑资源消耗太大而只允许创建一个对象</p></li><li><p>客户调用类的单个实例只允许使用一个公共访问点，除了该公共访问点，不能通过其他途径访问该实例</p></li><li><p>在一个系统中要求一个类只有一个实例时才应当使用单例模式。反过来，如果一个类可以有几个实例共存，就需要对单例模式进行改进，使之成为多例模式</p></li></ul><h3 id="9-模式应用"><a href="#9-模式应用" class="headerlink" title="9. 模式应用"></a>9. 模式应用</h3><ul><li><p>数据库连接器</p></li><li><p>一个具有自动编号主键的表可以有多个用户同时使用，但数据库中只能有一个地方分配下一个主键编号，否则会出现主键重复，因此该主键编号生成器必须具备唯一性，可以通过单例模式来实现</p></li></ul><h3 id="10-总结"><a href="#10-总结" class="headerlink" title="10. 总结"></a>10. 总结</h3><ul><li><p>单例模式确保某一个类只有一个实例，而且自行实例化并向整个系统提供这个实例，这个类称为单例类，它提供全局访问的方法。单例模式的要点有三个：一是某个类只能有一个实例；二是它必须自行创建这个实例；三是它必须自行向整个系统提供这个实例。单例模式是一种对象创建型模式。</p></li><li><p>单例模式只包含一个单例角色：在单例类的内部实现只生成一个实例，同时它提供一个静态的方法，让客户可以使用它的唯一实例；为了防止在外部对其实例化，将其构造函数设计为私有。</p></li><li><p>单例模式的目的是保证一个类仅有一个实例，并提供一个访问它的全局访问点。单例类拥有一个私有构造函数，确保用户无法通过<code>new</code>关键字直接实例化它。除此之外，该模式中包含一个静态私有成员变量与静态公有的方法。该方法负责检验实例的存在性并实例化自己，然后存储在静态成员变量中，以确保只有一个实例被创建。</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
            <tag> 面向对象 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Beanstalkd 学习研究</title>
      <link href="/2021/06/29/beanstalkd-xue-xi-yan-jiu/"/>
      <url>/2021/06/29/beanstalkd-xue-xi-yan-jiu/</url>
      
        <content type="html"><![CDATA[<h1 id="Beanstalkd-学习研究"><a href="#Beanstalkd-学习研究" class="headerlink" title="Beanstalkd 学习研究"></a>Beanstalkd 学习研究</h1><hr><h2 id="1-Beanstalkd-介绍"><a href="#1-Beanstalkd-介绍" class="headerlink" title="1. Beanstalkd 介绍"></a>1. Beanstalkd 介绍</h2><p>Beanstalkd是一个简单、高效的工作队列系统，其最初设计目的是通过后台异步执行耗时任务方式降低高容量Web应用的页面延时。而其简单、轻量、易用等特点，和对<code>任务优先级（priority）</code>、<code>任务延时（delay）</code>、<code>任务超时重发（time-to-run）</code>和<code>任务预留（buired）</code>等控制，以及众多语言版本的客户端的良好支持，使其能够很好的支持分布式的后台任务和定时任务处理。</p><p>beanstalkd还提供了<code>binlog</code>机制，当重启beanstalkd，当前任务的状态能够从记录的本地<code>binlog</code>中恢复。</p><h2 id="2-Beanstalkd-中的重要概念"><a href="#2-Beanstalkd-中的重要概念" class="headerlink" title="2. Beanstalkd 中的重要概念"></a>2. Beanstalkd 中的重要概念</h2><h3 id="2-1-核心概念"><a href="#2-1-核心概念" class="headerlink" title="2.1 核心概念"></a>2.1 核心概念</h3><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/beanstalkd-architecture.png" alt="beanstalkd-architecture"></p><p><code>Beanstalkd</code> 使用 <code>Producer-Consumer</code>设计模式，无论是其协议结构还是使用方式都是类似<code>Memcached</code>风格的。以下是<code>Beanstalkd</code>设计思想中核心概念：</p><h4 id="job-任务"><a href="#job-任务" class="headerlink" title="job - 任务"></a>job - 任务</h4><p><code>job</code>是一个需要异步处理的处理，是 <code>Beanstalkd</code>中的基本单元，每个<code>job</code>都会有一个id和优先级，<code>job</code>需要放在一个<code>tube</code>中。 <code>Beanstalkd</code>中的任务（<code>job</code>）类似于其消息队列中的消息（<code>message</code>）的概念。</p><h4 id="tube-管道"><a href="#tube-管道" class="headerlink" title="tube - 管道"></a>tube - 管道</h4><p>管道即某一种类型的任务队列，其类似于消息的主题（<code>topic</code>），是<code>Producer</code>和<code>Consumer</code>的操作对象。一个<code>Beanstalkd</code>中可以有多个管道，每个管道都有自己的生产者（<code>Producer</code>）和消费者（<code>Consumer</code>），管道之间互相不影响。</p><h4 id="producer-生产者"><a href="#producer-生产者" class="headerlink" title="producer - 生产者"></a>producer - 生产者</h4><p>任务（<code>job</code>）的生产者，通过<code>put</code>命令来将一个<code>job</code>放到一个<code>tube</code>中。</p><h4 id="consumer-消费者"><a href="#consumer-消费者" class="headerlink" title="consumer - 消费者"></a>consumer - 消费者</h4><p>任务（<code>job</code>）的消费者，通过<code>reserve</code>来获取<code>job</code>，通过<code>delete</code>、<code>release</code>、<code>bury</code>来改变<code>job</code>的状态。</p><h3 id="2-2-任务生命周期"><a href="#2-2-任务生命周期" class="headerlink" title="2.2 任务生命周期"></a>2.2 任务生命周期</h3><p><code>Beanstalkd</code>中的任务（<code>job</code>）替代了消息（<code>message</code>）的概念，任务会有一系列状态。任务的生命周期如下：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/beanstalkd-job-status.png" alt="beanstalkd-job-status"></p><p>一个 <code>Beanstalkd</code>任务可能会包含以下状态：</p><ul><li><strong>READY</strong> - 需要立即处理的任务。当<code>producter</code>直接<code>put</code>一个任务时，任务就处理<code>READY</code>状态，以等待<code>consumer</code>来处理。当延时（<code>DELAYED</code>）任务到期后会自动成为当前<code>READY</code>状态的任务</li><li><strong>RESERVED</strong> - 已经被消费者获取，正在执行的任务。当<code>consumer</code>获取了当前<code>READY</code>的任务后，该任务的状态就会迁移到<code>RESERVED</code>状态，这时其它的<code>consumer</code>就不能再操作该任务。<code>Beanstalkd</code>会检查任务是否在<code>TTR</code>（<code>time-to-run</code>）内完成</li><li><strong>DELETED</strong> - 消息被删除，<code>Beanstalkd</code>不再维持这些消息。即任务生命周期结束</li><li><strong>DELAYED</strong> - 延迟执行的任务。当任务被延时<code>put</code>时，任务就处理<code>DELAYED</code>状态。等待时间过后，任务会被迁移到<code>READY</code>状态。当消费者处理任务后，可以将任务再次放回<code>DELAYED</code>队列延迟执行</li><li><strong>BURIED</strong> - 埋葬的任务，这时任务不会被执行，也不会消失。当<code>consumer</code>完成该任务后，可以选择<code>delete</code>或<code>release</code>或<code>bury</code>操作<ul><li><code>delete</code>后，任务被删除，生命周期结束</li><li><code>release</code>操作可以把任务状态迁移回<code>READY</code>状态或<code>DELAYED</code>状态，使其它<code>consumer</code>可以继续获取和执行该任务</li><li><code>bury</code>操作会埋葬任务，等需要该任务时，再将埋葬的任务<code>kick</code>回<code>READY</code>，也可以通过<code>delete</code>删除<code>BURIED</code>状态的任务</li></ul></li></ul><h3 id="2-3-Beanstalkd特点"><a href="#2-3-Beanstalkd特点" class="headerlink" title="2.3 Beanstalkd特点"></a>2.3 Beanstalkd特点</h3><ul><li><strong>任务优先级（priority）</strong></li></ul><p>任务（<code>job</code>）可以有<code>0~2^32</code>个优先级，<code>0</code>表示优先级最高。<code>Beanstalkd</code>采用最大最小堆（Minx-max heap）处理任务优先级排序，任何时刻调用<code>reverse</code>命令的消费者总是能拿到当前优先级最高的任务，时间复杂度为<code>O(logn)</code></p><ul><li><strong>任务延时（delay）</strong></li></ul><p><code>Beanstalkd</code>中可以通过两种方式延时执行任务：生产者发布任务时指定延时；或者当任务处理完毕后，消费者再次将任务放入队列延时执行（<code>release with delay</code>）。这种机制可以实现分布式定时任务，这种任务机制的优势是：如果某个消费者节点故障，任务超时重发（<code>time-to-run</code>）以保证任务转移到其它节点执行</p><ul><li><strong>任务超时重发（time-to-run）</strong></li></ul><p><code>Beanstalkd</code>把任务返回给消费者后，消费者必须在预设的<code>TTR</code>(<code>time-to-run</code>)时间内发送<code>delete</code>、或<code>release</code>、或<code>bury</code>命令改变任务的状态；否则<code>Beanstalkd</code>会认为任务处理失败，然后把任务交给另外的消费者节点执行。如果消费者预计在<code>TTR</code>时间内无法完成任务，可以发送<code>touch</code>命令，以使<code>Beanstalkd</code>重新计算<code>TTR</code></p><ul><li><strong>任务预留（buried）</strong></li></ul><p>当<code>RESERVED</code>状态的任务因为某些原因无法执行时，消费者可以使用<code>bury</code>命令将其设置为<code>buried</code>状态，这时<code>Beanstalkd</code>会继续保留这些任务。在具备任务执行条件时，再通过<code>kick</code>将任务迁移回<code>READY</code>状态</p><h2 id="3-beanstalkd安装使用"><a href="#3-beanstalkd安装使用" class="headerlink" title="3. beanstalkd安装使用"></a>3. beanstalkd安装使用</h2><p>Beanstalkd分为服务端和客户端两部分。可以在其官网查找相关安装包及安装方法：</p><ul><li>服务端：<a href="http://kr.github.io/beanstalkd/download.html">http://kr.github.io/beanstalkd/download.html</a></li><li>客户端：<a href="https://github.com/kr/beanstalkd/wiki/client-libraries">https://github.com/kr/beanstalkd/wiki/client-libraries</a></li></ul><h3 id="3-1-服务端"><a href="#3-1-服务端" class="headerlink" title="3.1 服务端"></a>3.1 服务端</h3><h4 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h4><p>下载、解压并进入源码目录后，执行<code>make</code>或<code>make install</code>命令即可：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ sudo make// 或$ sudo make install// 或$ sudo make install PERFIX=/usr/bin/beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="安装包安装"><a href="#安装包安装" class="headerlink" title="安装包安装"></a>安装包安装</h4><p>在Unbuntu或Debian系统中，可以使用以下命令安装：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ sudo apt-get install beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在CentOS或RHEL系统中，首先需要更新<code>EPEL</code>源，然后再使用<code>yum</code>命令安装。</p><p>小提示：更多关于<code>EPEL</code>的知识可以查阅下面的资料：</p><ul><li><p><a href="https://fedoraproject.org/wiki/EPEL">Information on EPEL</a></p></li><li><p><a href="https://fedoraproject.org/wiki/EPEL/FAQ#howtouse">How to use EPEL</a></p></li></ul><p>在RHEL6/CentOS6中使用以下命令更新源：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ su -c 'rpm -Uvh http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在RHEL7中：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ su -c 'rpm -Uvh http://download.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-9.noarch.rpm'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>检查<code>EPEL</code>源是否更新成功：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ yum repolist enabled | grep epel * epel: mirrors.yun-idc.comepel                  Extra Packages for Enterprise Linux 6 - i386        10,254<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>执行安装：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ yum install -y beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>加入开启自启动：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ chkconfig beanstalkd  on<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>添加用户组：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ groupadd beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>添加用户：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ useradd -M -g beanstalkd -s /sbin/nologin beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>创建<code>binlog</code>存放目录并修改所有者/所属组（有权限写入）：</p><pre class="line-numbers language-none"><code class="language-none">$ mkdir -p /data/beanstalkd/binlog/$ chown -R beanstalkd:beanstalkd  /data/beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>修改配置文件中存放<code>binlog</code>的目录：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ vi /etc/sysconfig/beanstalkd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><em>BEANSTALKD_BINLOG_DIR=/data/beanstalkd/binlog</em></p><h4 id="运行beanstalkd"><a href="#运行beanstalkd" class="headerlink" title="运行beanstalkd"></a>运行beanstalkd</h4><p>Beanstalkd安装后，就可以通过beanstalkd命令来启动或配置Beanstalkd。该命令的使用格式如下：</p><pre class="line-numbers language-none"><code class="language-none">beanstalkd [OPTIONS]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可选[OPTIONS]参数有：</p><ul><li>-b DIR - wal目录（开启binlog，断电重启后会自动恢复任务）</li><li>-f MS  - 指定MS毫秒内的 fsync (-f0 为”always fsync”)</li><li>-F - 从不 fsync (默认)</li><li>-l ADDR - 指定监听地址（默认为：0.0.0.0）</li><li>-p PORT - 指定监听端口（默认为：11300）</li><li>-u USER - 用户与用户组</li><li>-z BYTE - 最大的任务大小（默认为：65535）</li><li>-s BYTE - 每个wal文件的大小（默认为：10485760）</li><li>-c - 压缩binlog（默认）</li><li>-n - 不压缩binlog</li><li>-v - 显示版本信息</li><li>-h - 显示帮助</li></ul><p>我们使用<code>nohup</code>和<code>&amp;</code>来配合启动程序，这样能免疫 <strong>Ctrl-C发送的SIGINT信号和关闭session发送的SIGHUP信号</strong></p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ nohup beanstalkd -l 0.0.0.0 -p 11300 -b /data/beanstalkd/binlog/ -u beanstalkd &amp;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-2-客户端"><a href="#3-2-客户端" class="headerlink" title="3.2 客户端"></a>3.2 客户端</h3><p>客户端包含了Beanstalkd设计概念中的任务<code>生产者（Producer）</code>和<code>消费者（Consumer）</code>。Beanstalkd有很多语言版本客户端的实现，点击<a href="https://github.com/beanstalkd/beanstalkd/wiki/Client-Libraries">Beanstalkd 客户端</a>查找自已所需要的版本，如果都不能满足需要，还可以根据<a href="https://github.com/beanstalkd/beanstalkd/blob/v1.3/doc/protocol.txt">Beanstalkd 协议</a>自行实现。</p><p>笔者日常工作中，接触PHP语言较多，以下用一个PHP版本的Beanstalkd 客户端：<a href="https://packagist.org/packages/pda/pheanstalk">pda/pheanstalk</a>为例，简单演示Beanstalkd的任务处理流程。</p><p>安装 pda/pheanstalk</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ composer require pda/pheanstalk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="生产-job"><a href="#生产-job" class="headerlink" title="生产 job"></a>生产 job</h4><p>创建一个 producer 来生产 job</p><p>producer.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'./vendor/autoload.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Pheanstalk<span class="token punctuation">\</span>Pheanstalk</span><span class="token punctuation">;</span><span class="token variable">$pheanstalk</span>  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pheanstalk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">11300</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$tubeName</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'syslog'</span><span class="token punctuation">;</span><span class="token variable">$jobData</span> <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string single-quoted-string">'type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'Debug'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'level'</span> <span class="token operator">=&gt;</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// error log</span>    <span class="token string single-quoted-string">'content'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'queue connect failed'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'timestamp'</span> <span class="token operator">=&gt;</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">microtime</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'timeCreated'</span> <span class="token operator">=&gt;</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d H:i:s'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$pheanstalk</span>    <span class="token operator">-&gt;</span><span class="token function">useTube</span><span class="token punctuation">(</span><span class="token variable">$tubeName</span><span class="token punctuation">)</span>    <span class="token operator">-&gt;</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$jobData</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行 producer.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">$ php producer<span class="token operator">.</span>php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="消费-job"><a href="#消费-job" class="headerlink" title="消费 job"></a>消费 job</h4><p>创建一个 consumer 来消费 job</p><p>consumer.php</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">&lt;?phpif (PHP_SAPI !== 'cli') {    echo 'Warning: should be invoked via the CLI version of PHP, not the '.PHP_SAPI.' SAPI'.PHP_EOL;}require_once('./vendor/autoload.php');use Pheanstalk\Pheanstalk;$pheanstalk  = new Pheanstalk('127.0.0.1', 11300);$tubeName = 'syslog';while (true) {    // 从指定队列获取信息，reserve 阻塞获取    $job = $pheanstalk-&gt;useTube($tubeName)-&gt;watch($tubeName)-&gt;ignore('default')-&gt;reserve(60);    if ($job !== false) {        // do stuff        echo $data = $job-&gt;getData();        // 处理完成，删除 job        $pheanstalk-&gt;delete($job);    }    usleep(500000); // 0.5 s}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行 consumer.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">$ php consumer<span class="token operator">.</span>php<span class="token punctuation">{</span><span class="token string double-quoted-string">"type"</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"Debug"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"level"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"content"</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"queue connect failed"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"timestamp"</span><span class="token punctuation">:</span><span class="token number">1576113851568</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"timeCreated"</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"2019-12-12 01:24:11"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>可以使用<strong>deamontools</strong>和<strong>supervisor</strong>等将<code>php consumer.php</code>变为常驻内存的进程。</p><h4 id="监控-beanstalkd-状态"><a href="#监控-beanstalkd-状态" class="headerlink" title="监控 beanstalkd 状态"></a>监控 beanstalkd 状态</h4><p>创建一个 heartbeat 来检查与服务器的连接状态</p><p>heartbeat.php</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">&lt;?php/** * 心跳检查脚本：定期在定时任务系统（crontab、MySQL Event Scheduler、Elastic-Job）上运行并收集与服务器连接状态信息， * 如果连接不是活的状态，则可以发送消息报警（sms、email） */if (PHP_SAPI !== 'cli') {    echo 'Warning: should be invoked via the CLI version of PHP, not the '.PHP_SAPI.' SAPI'.PHP_EOL;}require_once('./vendor/autoload.php');use Pheanstalk\Pheanstalk;$pheanstalk  = new Pheanstalk('127.0.0.1', 11300);$isAlive = $pheanstalk-&gt;getConnection()-&gt;isServiceListening();var_dump($isAlive);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行 heartbeat.php</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ php heartbeat.phpbool(true)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="4-beanstalkd-管理工具"><a href="#4-beanstalkd-管理工具" class="headerlink" title="4. beanstalkd 管理工具"></a>4. beanstalkd 管理工具</h2><p>Tools：<a href="https://github.com/beanstalkd/beanstalkd/wiki/Tools">https://github.com/beanstalkd/beanstalkd/wiki/Tools</a></p><p>笔者经常使用的两款工具：</p><p>web 界面：<a href="https://github.com/ptrofimov/beanstalk_console">https://github.com/ptrofimov/beanstalk_console</a></p><p>命令行：<a href="https://github.com/src-d/beanstool">https://github.com/src-d/beanstool</a></p><p>对 beanstalkd 的操作也可以使用<code>telnet</code>，比如 <code>telnet 127.0.0.1 11300</code>。然后便可以执行 beanstalkd 的各命令，如 <code>stats</code> 查看信息，<code>use</code>, <code>put</code>, <code>watch</code> 等等。</p><p><code>telnet</code>对beanstalkd的操作：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ telnet 127.0.0.1 11300statsOK 929---current-jobs-urgent: 0current-jobs-ready: 0current-jobs-reserved: 0current-jobs-delayed: 0current-jobs-buried: 0...list-tubesOK 23---- default- syslog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="5-Beanstalkd-使用总结"><a href="#5-Beanstalkd-使用总结" class="headerlink" title="5. Beanstalkd 使用总结"></a>5. Beanstalkd 使用总结</h2><ul><li><p>如果需要对<code>job</code>有<strong>持久化</strong>的需要，在启动beanstalkd时可以使用<code>-b</code>参数来开启<code>binlog</code>（二进制日志）， 通过<code>binlog</code>可以将<code>job</code>及其状态记录到文件里，如果断电，则可以使用相同的选项重新启动beanstalkd，它将读取<code>binlog</code>来恢复之前的<code>job</code>及状态</p></li><li><p><code>put</code>前先要<code>use tube xxxtube</code>，这样<code>put</code>的时候就会把<code>job</code>放到指定名称的<code>tube</code>中，否则会放到一个<code>default</code>的<code>tube</code>中</p></li><li><p><code>reserve</code>或<code>reserve-with-timeout</code>前先要<code>watch xxxtube</code>，可以同时监控多个<code>tube</code>，这样可以同时取几个队列的任务。但是，千万要小心，如果在一个进程中，不小心<code>watch</code>到了多个<code>tube</code>，那么有时候会取错任务，一般取<code>job</code>的步骤为：<code>useTube xxxtube -&gt; watch xxxtube -&gt; ignore default -&gt; reserve</code></p></li><li><p><code>job</code>处理完成，应该<code>delete</code>删除掉，或者<code>release</code>再放回队列，或者<code>bury</code>把它埋葬掉，这个取决于你的设计</p></li></ul><h2 id="6-Beanstalkd-不足"><a href="#6-Beanstalkd-不足" class="headerlink" title="6. Beanstalkd 不足"></a>6. Beanstalkd 不足</h2><ul><li><p>无最大内存控制，如果有消息堆积或者业务使用方式有误，而导致内存暴涨拖垮机器</p></li><li><p>跟<code>Memcached</code>类似，没有<code>master-slave</code>故障切换机制，需要自己解决单点问题</p></li></ul><h2 id="7-参考资料"><a href="#7-参考资料" class="headerlink" title="7. 参考资料"></a>7. 参考资料</h2><ul><li><a href="https://beanstalkd.github.io/">beanstalkd 官网</a></li><li><a href="https://github.com/beanstalkd/beanstalkd/wiki/Client-Libraries">Beanstalkd 客户端</a></li><li><a href="https://github.com/beanstalkd/beanstalkd/wiki/FAQ">beanstalkd FAQ</a></li><li><a href="https://github.com/beanstalkd/beanstalkd/blob/master/doc/protocol.zh-CN.md">Beanstalkd 中文协议</a></li><li><a href="https://github.com/pheanstalk/pheanstalk">pheanstalk</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 消息队列 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 中间件 </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP 多进程编程</title>
      <link href="/2021/06/29/php-duo-jin-cheng-bian-cheng/"/>
      <url>/2021/06/29/php-duo-jin-cheng-bian-cheng/</url>
      
        <content type="html"><![CDATA[<h1 id="PHP-多进程编程"><a href="#PHP-多进程编程" class="headerlink" title="PHP 多进程编程"></a>PHP 多进程编程</h1><hr><h2 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h2><p>想完成某个耗时的任务，又觉得一个进程太慢，那么，试试用多进程来搞吧。这篇文章将会介绍一下<code>PHP</code>多进程的基本知识，如何创建多进程以及基本的信号控制。</p><h2 id="1-基本概念与环境准备"><a href="#1-基本概念与环境准备" class="headerlink" title="1. 基本概念与环境准备"></a>1. 基本概念与环境准备</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><ul><li><p>程序和进程</p><blockquote><p>程序（program）是一个存储在磁盘上某个目录中的可执行文件。</p><p>程序的执行实例被称为进程（process）。</p></blockquote></li><li><p>进程相关概念</p></li></ul><p>1）进程ID</p><p>进程标识符（<code>PID</code>）是大多数操作系统的内核用于唯一标识进程的一个数值。这一数值可以作为许多函数调用的参数，以使调整进程优先级、杀死进程之类的进程控制行为成为可能。</p><p>在<code>UNIX</code>里，除了<code>进程0</code>（即PID=0的交换进程，Swapper Process）以外的所有进程都是由其他进程使用系统调用<code>fork</code>创建的，这里调用<code>fork</code>创建新进程的进程即为父进程，而相对应的为其创建出的进程则为子进程，因而除了<code>进程0</code>以外的进程都只有一个父进程，但一个进程可以有多个子进程。</p><p> 0号进程是系统引导时创建的一个特殊进程，在其调用<code> fork</code>创建出一个子进程（即PID=1的进程1，又称 init）后，<code> 进程0</code>就转为交换进程（有时也被称为空闲进程），而<code> 进程1</code>（init进程）就是系统里其他所有进程的祖先。</p><p>2）调用进程的父进程ID</p><p>3）调用进程的实际用户ID</p><p>4）调用进程的有效用户ID</p><p>5）调用进程的实际组ID</p><p>6）调用进程的有效组ID</p><p>7）进程的优先级</p><p>例如修改bash进程的优先级</p><ul><li>获取bash进程的进程ID<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[dendi875@localhost ~]$ echo $$3224<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li>top查看进程的优先级</li></ul><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">top -d -2 -p &lt;pid&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>top状态下按<strong>r</strong>输入进程ID后按回车，然后再输入<code>nice</code>值</li></ul><p>8）进程状态</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/process-status.png" alt="process-status"></p><p>9）进程组</p><ul><li>进程组是一个或多个进程的集合。每个进程组有一个唯一的进程组ID。进程组ID类似进程ID，它是一个正整数。</li><li>每个进程组有一个组长进程。组长进程的进程ID等于其进程ID。</li></ul><p>10）会话</p><ul><li>会话（session）是一个或多个进程组的集合。</li><li>如果调用进程不是一个组长进程则可以使用<code>setsid</code>来创建一个新会话。具体会发生3件事<ul><li>该进程变成新会话的<strong>会话首进程</strong>（会话首进程是创建该会话的进程）。此时，该进程是新会话中的唯一进程。</li><li>该进程成为一个新进程组的组长进程。新进程组ID是该调用进程的进程ID。</li><li>该进程脱离控制终端。</li></ul></li></ul><p>11）控制终端</p><ul><li>一个会话可以有一个<strong>控制终端</strong>。本地终端（例如：tty1）或远程终端（例如：/pts/0）。</li><li>一个会话中的几个进程组可被分成一个前台进程组（foreground process group）以及一个或多个后台进程组（background process group）。</li><li>如果一个会话有一个控制终端，则它有一个前台进程组，其他进程组为后台进程组。</li></ul><p>12）和信号相关的信息</p><ul><li><code>Ctrl+C</code> 发送<code>SIGINT</code>信号，终止进程</li><li><code>Ctrl+\</code> 发送<code>SIGQUIT</code>信号，终止进程并产生<strong>coredump</strong></li><li>关闭<code>session</code>，发送<code>SIGHUP</code>信号</li><li>浮点异常时产生<code>SIGFPE</code>信号，比如除以0</li><li>段错误时产生<code>SIGSEGV</code>信号</li></ul><p>相关的<code>linux</code>命令</p><ul><li>进程相关</li></ul><pre class="line-numbers language-none"><code class="language-none">ps -elfps auxps ajxfpstree -Auptop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>线程相关</p><pre class="line-numbers language-none"><code class="language-none">ps -eLfps -Lw &lt;pid&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>信号相关</p><pre class="line-numbers language-none"><code class="language-none">kill -lman 7 signalulimit -aman 5 coreman 5 limits.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>和终端终端相关</p><pre class="line-numbers language-none"><code class="language-none">stty --helpbgfgkill -&lt;signo&gt; &lt;%jobid&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul><li><p><code>php</code>多进程主要是在<code>CLI</code>（命令行模式）下应用。</p></li><li><p> <code>php</code>多进程需要安装<code>pcntl</code>（process control）和<code>posix</code>扩展（windows不支持）。</p></li></ul><p>确认扩展是否都有安装：</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ~]# php -m | grep -E 'pcntl|posix'pcntlposix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>编译时<code>pcntl</code>扩展默认是不安装的，记得编译配置时加上<code>--enable-pcntl</code>参数；<code>posix</code>扩展默认安装，只要你编译时没有加上<code>--disable-posix</code>。</p><h2 id="2-主要函数详解"><a href="#2-主要函数详解" class="headerlink" title="2. 主要函数详解"></a>2. 主要函数详解</h2><h3 id="pcntl-fork-创建子进程"><a href="#pcntl-fork-创建子进程" class="headerlink" title="pcntl_fork() 创建子进程"></a>pcntl_fork() 创建子进程</h3><p>例子1：创建一个子进程 fork1.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"11111111111111111111\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//  返回值为-1,创建失败</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'could not fork'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 子进程中</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I'm child pid：%d ppid：%d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment">// 父进程中</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I'm parent pid：%d ppid：%d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"2222222222222222222\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cli" data-language="cli"><div class="caption"><span>```下运行结果为：</span></div><code class="language-cli">```ssh[dendi875@localhost process]$ php fork1.php11111111111111111111I'm parent pid：7526 ppid：27892222222222222222222I'm child pid：7527 ppid：75262222222222222222222<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上代码说明<code>pcntl_fork()</code>函数调用成功后，在父进程中会返回子进程的<code>PID</code>，而在子进程中返回的是<code>0</code>。</p><p>例子2：创建多个子进程 fork2.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** *循环创建多个进程 */</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//  返回值为-1，创建失败</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'could not fork'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 子进程中</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I'm %d child pid：%d ppid：%d\n"</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment">// 父进程中</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I'm %d parent pid：%d ppid：%d\n"</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cli" data-language="cli"><div class="caption"><span>```下运行结果为：</span></div><code class="language-cli">```ssh[dendi875@localhost process]$ php fork2.phpI'm 0 parent pid：7785 ppid：2789I'm 1 parent pid：7785 ppid：2789I'm 2 parent pid：7785 ppid：2789I'm 2 child pid：7788 ppid：7785I'm 1 child pid：7787 ppid：7785I'm 2 parent pid：7787 ppid：7785I'm 0 child pid：7786 ppid：7785I'm 1 parent pid：7786 ppid：7785I'm 2 parent pid：7786 ppid：7785I'm 2 child pid：7789 ppid：7787[dendi875@localhost process]$ I'm 1 child pid：7790 ppid：7786I'm 2 parent pid：7790 ppid：7786I'm 2 child pid：7791 ppid：7786I'm 2 child pid：7792 ppid：7790<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>分析为什么会出现8个进程，printf了14次？</strong></p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/fork.png" alt="fork"></p><p>例子3：循环创建多个子进程改进版 fork3.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** *循环创建多个进程 */</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//  返回值为-1，创建失败</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'could not fork'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// 子进程中</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I'm %d child pid：%d ppid：%d\n"</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment">// 父进程中</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I'm %d parent pid：%d ppid：%d\n"</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cli" data-language="cli"><div class="caption"><span>```下运行结果为</span></div><code class="language-cli">```shell[dendi875@localhost process]$ php fork3.phpI'm 0 parent pid：7776 ppid：2789I'm 1 parent pid：7776 ppid：2789I'm 2 parent pid：7776 ppid：2789I'm 2 child pid：7779 ppid：7776I'm 1 child pid：7778 ppid：7776I'm 0 child pid：7777 ppid：7776<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在循环中创建子进程需要注意以下两点：</p><p>1）子进程代码中要<code>exit</code>防止子进程再<code>fork</code>子进程，进入子进程的循环把系统的资源耗尽。</p><p>2）父进程代码中不要<code>exit</code>否则会终止多进程。</p><h3 id="pcntl-signal-注册信号处理函数和pcntl-signal-dispatch-检测是否有有信号未处理"><a href="#pcntl-signal-注册信号处理函数和pcntl-signal-dispatch-检测是否有有信号未处理" class="headerlink" title="pcntl_signal 注册信号处理函数和pcntl_signal_dispatch 检测是否有有信号未处理"></a>pcntl_signal 注册信号处理函数和pcntl_signal_dispatch 检测是否有有信号未处理</h3><p>例子：signal.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">function</span> <span class="token function-definition function">signalHandler</span><span class="token punctuation">(</span><span class="token variable">$signo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$signo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> <span class="token constant">SIGINT</span><span class="token punctuation">:</span>            <span class="token comment">// 处理按`Ctrl-C`时发送的SIGINT（2）信号</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"handle signal SIGINT （%d）\n"</span><span class="token punctuation">,</span> <span class="token variable">$signo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token constant">SIGHUP</span><span class="token punctuation">:</span>            <span class="token comment">// 处理关闭`session`时发送的SIGHUP（1）信号</span>            <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"handle signal SIGHUP （%d）\n"</span><span class="token punctuation">,</span> <span class="token variable">$signo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'t.log'</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token constant">SIGTERM</span><span class="token punctuation">:</span>            <span class="token comment">// 处理`kill`命令默认发送的SIGTERM（15）信号</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"handle signal SIGTERM （%d）\n"</span><span class="token punctuation">,</span> <span class="token variable">$signo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>            <span class="token comment">// 处理其它信号</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// 注册一个信号处理器，当接收到SIGINT、SIGHUP、SIGTERM信号时调用signalHandler函数</span><span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGINT</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'signalHandler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGHUP</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'signalHandler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGTERM</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'signalHandler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检测是否有末决信号待处理，调用相应的信号处理函数</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"hello, %d\n"</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意：</p><ul><li><code>pcntl_signal()</code>函数仅仅是注册信号和它的处理方法，检测信号并调用其处理方法的函数是<code>pcntl_signal_dispatch()</code>。</li><li>9号信号（<strong>SIGKILL</strong>）和19号信号（<strong>SIGSTOP</strong>）不能被捕捉、不能被忽略、不能被阻塞。</li></ul><h3 id="孤儿进程与僵尸进程"><a href="#孤儿进程与僵尸进程" class="headerlink" title="孤儿进程与僵尸进程"></a>孤儿进程与僵尸进程</h3><h4 id="孤儿进程"><a href="#孤儿进程" class="headerlink" title="孤儿进程"></a>孤儿进程</h4><ul><li><p>所谓孤儿进程，顾名思义，和现实生活中的孤儿有点类似，当一个进程的<strong>父进程结束</strong>时，但是它自己还没有结束，那么这个进程将会成为孤儿进程。最后孤儿进程将会被<code>init进程</code>（进程号为1）的进程收养，当然在子进程结束时也会由init进程完成对它的状态收集工作，因此一般来说，孤儿进程并不会有什么危害。</p></li><li><p>孤儿进程实例：orphan.php</p></li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">function</span> <span class="token function-definition function">pr_ids</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"%s：pid = %d, ppid = %d, pgid = %d, sid = %d\n"</span><span class="token punctuation">,</span>        <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$pid</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getpgid</span><span class="token punctuation">(</span><span class="token variable">$pid</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getsid</span><span class="token punctuation">(</span><span class="token variable">$pid</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">/* 子进程中 */</span>        <span class="token function">pr_ids</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"child"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* 睡眠3s，保证父进程先退出，子进程成为孤儿进程 */</span>        <span class="token function">pr_ids</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"now child"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 父进程睡眠1s，保证子进程先运行     * 在子进程还没有成为孤儿进程前打印父进程ID和子进程成为孤儿进程后打印的父进程ID做对比     */</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">pr_ids</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"parent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"parent process is exited.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上代码输出：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@localhost process]# php orphan.phpchild：pid = 29615, ppid = 29614, pgid = 29614, sid = 7937parent：pid = 29614, ppid = 21998, pgid = 29614, sid = 7937parent process is exited.[root@localhost process]# now child：pid = 29615, ppid = 1, pgid = 29614, sid = 7937<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上例子中，在<code>run</code>函数中，创建子进程，然后让父进程睡眠1s，让子进程先打印出其进程<code> id（pid）</code>以及父进程<code> id（ppid）</code>；随后子进程睡眠3s（此时会调度到父进程运行直结束），目的是让<strong>父进程先于子进程结束</strong>，让子进程有个孤儿的状态；最后子进程再打印出其进程<code>id(pid)</code>以及父进程<code>id(ppid)</code>；观察两次打印 其父进程<code>id(ppid)</code>的区别。</p><p>从运行结果来看：当其父进程结束后，子进程成为了孤儿进程，其父进程<code>id(ppid)</code>为1，也就是说，<code>init进程</code>成为该子进程的父进程了。</p><h4 id="僵尸进程"><a href="#僵尸进程" class="headerlink" title="僵尸进程"></a>僵尸进程</h4><blockquote><p>当一个进程正常或异步终止时，内核就向其父进程发送 <code>SIGCHLD</code>信号。因为子进程终止是个异步事件（这可以在父进程运行的任何时候发生），所以这种信号也是内核向父进程发的异步通知。父进程可以选择忽略该信号，或者提供一个该信号发生时即被调用执行的函数（信号处理程序）。对于这种信号的系统默认动作是忽略它。–APUE</p></blockquote><ul><li>僵尸进程实例：zombie.c</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 僵尸进程实例 */</span><span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">/* 子进程中 */</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I am child process pid：%d\tppid：%d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"child process is exited.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">/* 子进程正常退出 */</span>    <span class="token punctuation">}</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I am parent process pid：%d\tppid：%d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行查看</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">root@vultr:/data1/www/test/php/process# php zombie.phpI am parent process pid：25210  ppid：24032I am child process pid：25211   ppid：25210child process is exited.I am parent process pid：25210  ppid：24032I am parent process pid：25210  ppid：24032...（省略）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再打开一个终端查看进程状态</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">root@vultr:~# ps -elf...（省略）0 S root     25312 24032  0  80   0 - 19076 hrtime 03:07 pts/0    00:00:00 php zombie.php1 Z root     25313 25312  0  80   0 -     0 -      03:07 pts/0    00:00:00 [php] &lt;defunct&gt;...（省略）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>僵尸进程是指：一个进程使用<code>fork</code>创建子进程，如果<strong>子进程退出</strong>，而父进程并没有调用<code>wait</code>或<code>waitpid</code>获取子进程的状态信息，那么子进程的某些信息如进程描述符仍然保存在系统中。这种进程称之为僵尸进程。</p><p>我们详细理解下，在<code>UNIX/Linux</code>中，正常情况下，子进程是通过父进程<code>fork</code> 创建的。子进程和父进程的运行是一个异步过程，理论上父进程无法知道子进程的运行状态。但知道子进程运行状态是一个很合理的需求，所以<code>UNIX</code> 提供了一种机制可以保证只要父进程想知道子进程结束时的状态信息，就可以得到。这种机制就是: 在每个进程退出的时候，内核释放该进程的一部分资源，包括<strong>打开的文件</strong>、<strong>占用的内存</strong>等，同时仍然为其保留一定的信息（包括<strong>进程号</strong>，<strong>退出状态</strong>，<strong>运行时间</strong>等）。父进程可以通过<code>wait()/waitpid()</code>来获取这些信息，然后操作系统才释放。</p><p>如果父进程不调用<code>wait()/waitpid()</code> 的话，那么保留的信息就不会释放，其进程号就会一直被占用，就像僵尸一样，所以把这些进程称为僵尸进程。</p><h3 id="pcntl-waitpid-回收僵尸进程"><a href="#pcntl-waitpid-回收僵尸进程" class="headerlink" title="pcntl_waitpid 回收僵尸进程"></a>pcntl_waitpid 回收僵尸进程</h3><p>例子1：<code>waitpid</code> 阻塞/非阻塞回收指定的子进程 waitpid.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 使用waitpid阻塞/非阻塞回收指定的子进程 */</span><span class="token comment">/** * 打印进程退出状态 */</span><span class="token keyword">function</span> <span class="token function-definition function">pr_exit</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcntl_wifexited</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"normal termination, exit status = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_wexitstatus</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcntl_wifsignaled</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"abnormal termination, signal number = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_wtermsig</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcntl_wifstopped</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"child stoped, signal number = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_wstopsig</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">/* 子进程中 */</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I am child process pid：%d\tppid：%d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"child process is exited.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I am parent process pid：%d\tppid：%d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//$wid = pcntl_waitpid($pid, $status, 0);</span>        <span class="token variable">$wid</span> <span class="token operator">=</span> <span class="token function">pcntl_waitpid</span><span class="token punctuation">(</span><span class="token variable">$pid</span><span class="token punctuation">,</span> <span class="token variable">$status</span><span class="token punctuation">,</span> <span class="token constant">WNOHANG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$wid</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"waitpid error：%s\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_strerror</span><span class="token punctuation">(</span><span class="token function">pcntl_errno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$wid</span> <span class="token operator">==</span> <span class="token variable">$pid</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">pr_exit</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"wait for child wid = %d\n"</span><span class="token punctuation">,</span> <span class="token variable">$wid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例子2：waitpid阻塞/非阻塞回收多个子进程实例 waitpid2.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * waitpid阻塞/非阻塞回收多个子进程实例 */</span><span class="token comment">/** * 打印进程退出状态 */</span><span class="token keyword">function</span> <span class="token function-definition function">pr_exit</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcntl_wifexited</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"normal termination, exit status = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_wexitstatus</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcntl_wifsignaled</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"abnormal termination, signal number = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_wtermsig</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcntl_wifstopped</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"child stoped, signal number = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_wstopsig</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>    <span class="token variable">$childs</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">/* 子进程中 */</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I am child process pid：%d\tppid：%d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// sleep($i+1);  /* 非阻塞时打开注释 */</span>            <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment">/* 父进程中 */</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"I am parent process pid：%d\tppid：%d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">posix_getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$childs</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$pid</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$childs</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$childs</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=&gt;</span> <span class="token variable">$pid</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$wid</span> <span class="token operator">=</span> <span class="token function">pcntl_waitpid</span><span class="token punctuation">(</span><span class="token variable">$pid</span><span class="token punctuation">,</span> <span class="token variable">$status</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">/* 阻塞*/</span>            <span class="token comment">// $wid = pcntl_waitpid($pid, $status, WNOHANG);  /* 非阻塞 */</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$wid</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"waitpid error：%s\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_strerror</span><span class="token punctuation">(</span><span class="token function">pcntl_errno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$wid</span> <span class="token operator">==</span> <span class="token variable">$pid</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$childs</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">pr_exit</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"wait for child wid = %d\n"</span><span class="token punctuation">,</span> <span class="token variable">$wid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上代码输出：</p><pre class="line-numbers language-none"><code class="language-none">[root@localhost process]# ./wait-nohang.phpparent  8288    7870    1542632609.5141wait return is 0parent  8288    7870    1542632609.5142wait return is 0parent  8288    7870    1542632609.5144wait return is 0child   8291    8288    1542632609.5172child   8290    8288    1542632609.5174child   8289    8288    1542632609.5178<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>例子3：使用信号处理函数来回收僵尸进程 sigchld.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 使用信号处理函数来回收僵尸进程 */</span><span class="token comment">/** * 打印进程退出状态 */</span><span class="token keyword">function</span> <span class="token function-definition function">pr_exit</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcntl_wifexited</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"normal termination, exit status = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_wexitstatus</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcntl_wifsignaled</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"abnormal termination, signal number = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_wtermsig</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcntl_wifstopped</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"child stoped, signal number = %d\n"</span><span class="token punctuation">,</span> <span class="token function">pcntl_wstopsig</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">/** * SIGCHLD 信号处理函数 */</span><span class="token keyword">function</span> <span class="token function-definition function">sig_chld</span><span class="token punctuation">(</span><span class="token variable">$signo</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">$status</span><span class="token punctuation">,</span> <span class="token constant">WNOHANG</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">pr_exit</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">/* 子进程中 */</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/* 10个子进程 */</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"child ID %d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//posix_kill(posix_getpid(), SIGABRT);</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">/* 一个父进程 */</span>        <span class="token comment">// 安装 SIGCHLD 信号处理函数</span>        <span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGCHLD</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sig_chld'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 检测是否有未处理的信号 */</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"parent ID %d\n"</span><span class="token punctuation">,</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>备注：</p><p>1）<code>pcntl_waitpid(-1, $status, 0)</code>行为等价于函数<code>pcntl_wait($status)</code></p><p>2）多理解<code>pcntl_waitpid</code>函数的<code>pid</code>的4种情况（&lt; -1, -1, 0, &gt; 0）及3种返回值（0, &gt; 0, -1）。</p><p>这里要理解多进程程序中父进程阻塞与非阻塞的区别</p><ul><li>阻塞： 父进程一直等待，直到收到一个子进程结束的信号再执行。</li><li>非阻塞：父进程和子进程同时执行，不用等子进程执行完。在子进程退出后，再回收。</li></ul><h3 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h3><blockquote><p>守护进程（daemon）是一种生存期很长的一种进程。它们通常是在系统开机时启动，在系统关闭时才终止。它们脱离控制终端在后台长期运行为我们提供某种服务。守护进程程序的名称通常以字母“d”结尾，例如<strong>syslogd</strong>就是指管理系统日志的守护进程。</p></blockquote><p>创建一个守护进程实例</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token comment">/** * 创建一个守护进程 */</span><span class="token keyword">function</span> <span class="token function-definition function">daemonize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment">/**     *重新设置文件权限掩码     */</span>    <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 调用fork创建子进程，父进程退出，保证了子进程不是一个组长进程，这是执行setsid调用的先决条件     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">/* 父进程中 */</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 创建一个会话，使进程成为会话首进程并脱离控制终端     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">posix_setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"setsid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 再次fork避免在System V的系统中，重新获取对终端的控制     */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * 改变当前工作目录     */</span>    <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">daemonize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建守护进程步骤：</p><p>1）重新设置文件权限掩码。<strong>umask</strong> 函数，防止使用继承过来的掩码来创建文件可能会被设置为拒绝某些权限</p><p>2）调用<strong>fork</strong>创建子进程，父进程退出。保证了子进程不是一个组长进程，这是执行<strong>setsid</strong>调用的先决条件</p><p>3）调用setsid创建一个新的会话。目的是使调用进程：</p><ul><li><p>成为新会话的首进程</p></li><li><p>成为一个新进程组的组长进程</p></li><li><p>脱离控制终端</p></li></ul><p>4）调用<strong>chdir</strong>更改当前工作目录，一般为根目录。防止占用可卸载的文件系统</p><p>5）关闭所有的文件描述符。从父进程继承过来的文件描述符不会再被用到，如果不关闭就浪费了系统资源</p><p>6）使0、1、2文件描述符指向<code>/dev/null</code>。目的是使任何一个试图从标准输入读、写到标准输出、写到标准错误的程序都不会产生效果，因为守护进程并不与终端设备相关联，所以其输出无处显示，也无处从交互式用户那里接收输入。</p><h2 id="3-如何让挂掉的服务自动启动"><a href="#3-如何让挂掉的服务自动启动" class="headerlink" title="3. 如何让挂掉的服务自动启动"></a>3. 如何让挂掉的服务自动启动</h2><ul><li> <code>nohup</code>与<code>&amp;</code>的区别</li></ul><p>测试代码如下 hello.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"hello, %d\n"</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>使用 <code>php hello.php</code>前台运行，效果如下</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost process]# php hello.phphello, 0hello, 1hello, 2hello, 3^C[root@localhost process]#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时键入<code>Ctrl-C</code>，程序会收到一个<code>SIGINT</code>信号，如果不做特殊处理，程序的默认行为是终止。</p></li><li><p>使用<code>php hello.php &amp;</code>后台运行程序，效果如下</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost process]# php hello.php &amp;[2] 31540[root@localhost process]# hello, 0hello, 1^C[root@localhost process]# hello, 2hello, 3^C[root@localhost process]# hello, 4hello, 5hello, 6hello, 7hello, 8^C[root@localhost process]# hello, 9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ~]# ps aux | grep helloroot     31540  0.1  0.7  35964  7776 pts/0    S    17:33   0:00 php hello.phproot     31544  0.0  0.0   5976   748 pts/1    S+   17:33   0:00 grep --color=auto hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以看到首先会在终端显示进程号31540，键入<code>Ctrl-C</code>，发送<code>SIGINT</code>信号，<strong>程序会继续运行</strong>。<code>ps</code>查看进程的确在运行。</p><p>此时关掉<code>session</code>，程序会收到一个<code>SIGHUP</code>信号，此时会怎么样？</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ~]# ps aux | grep helloroot     31792  0.0  0.0   5976   748 pts/1    S+   18:07   0:00 grep --color=auto hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-ps" data-language="ps"><div class="caption"><span>```再次确认，可以看到关闭``` session ```之后，进程号是31540的``` hello.php ```的进程也关闭了。</span></div><code class="language-ps">* 使用``` nohup php hello.php ```效果是怎么样？``` ssh[root@localhost process]# nohup php hello.phpnohup: 忽略输入并把输出追加到"nohup.out"[root@localhost ~]# ps aux | grep hello.phproot     31835  0.1  0.7  35964  7776 pts/0    S+   18:10   0:00 php hello.phproot     31863  0.0  0.0   5976   752 pts/1    S+   18:11   0:00 grep --color=auto hello.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用<code>nohup</code>运行程序后，用<code>ps</code>查看进程号是31835。此时关掉<code>session</code>，程序会收到一个<code>SIGHUP</code>信号，程序会不会关闭呢？</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ~]# ps aux | grep hello.phproot     31835  0.0  0.7  35964  7776 ?        S    18:10   0:00 php hello.phproot     31881  0.0  0.0   5976   756 pts/1    S+   18:13   0:00 grep --color=auto hello.php[root@localhost ~]# ps aux | grep hello.phproot     31835  0.0  0.7  35964  7776 ?        S    18:10   0:00 php hello.phproot     31883  0.0  0.0   5976   752 pts/1    S+   18:13   0:00 grep --color=auto hello.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关掉<code>session</code>后，再次<code>ps</code>查看，<code>PID</code>为31835的进程还在。只能通过<code>kill</code>杀掉。</p><ul><li>测试下<code>nohup php hello.php</code>后按<code>Ctrl-C</code>会发生什么？</li></ul><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost process]# nohup php hello.phpnohup: 忽略输入并把输出追加到"nohup.out"^C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到键入<code>Ctrl-C</code>，程序收到<code>SIGINT</code>信号后，程序关闭了。</p><ul><li>最后测试下<code>nohup</code>和<code>&amp;</code>，同时使用，即<code>nohup php hello.php &amp;</code>会怎么样？</li></ul><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost process]# nohup php hello.php &amp;[1] 32004[root@localhost process]# nohup: 忽略输入并把输出追加到"nohup.out"^C[root@localhost process]# ^C[root@localhost process]# ^C[root@localhost process]# ps aux | grep hello.phproot     32004  0.0  0.7  35964  7776 pts/0    S    18:27   0:00 php hello.phproot     32015  0.0  0.0   5976   780 pts/0    S+   18:28   0:00 grep --color=auto hello.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时键入<code>Ctrl-C</code>，发送<code>SIGINT</code>信号，该进程还在。<br>此时关闭<code>session</code>，发送<code>SIGHUP</code>信号，再来看看进程还在不在？</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ~]# ps aux | grep hello.phproot     32004  0.1  0.7  35964  7776 ?        S    18:27   0:00 php hello.phproot     32053  0.0  0.0   5976   756 pts/1    S+   18:29   0:00 grep --color=auto hello.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以看到关闭<code>session</code>，后进程还在，现在也只能使用<code>kill</code>来杀掉。</p><p>结论<br>使用<code>&amp;</code>后台运行程序：</p><blockquote><p>使用<code>Ctrl-C</code>发送<code>SIGINT</code>信号，进程免疫。</p><p>关闭<code>session</code>发送<code>SIGHUP</code>信号，进程终止。</p></blockquote><p>使用<code>nohup</code>运行程序：</p><blockquote><p>使用<code>Ctrl-C</code>发送<code>SIGINT</code>信号，进程终止。</p><p>关闭<code>session</code>发送<code>SIGHUP</code>信号，进程免疫。</p></blockquote><p>使用<code>&amp;nohup</code>和<code>&amp;</code>来配合启动程序：</p><blockquote><p>同时免疫<code>SIGINT</code>和<code>SIGHUP</code>信号</p></blockquote><p>思考：如果使用了<code>nohup</code>和<code>&amp;</code>启动程序后，程序因异常情况被<code>kill</code>掉，如何让程序自动启动？</p><h2 id="4-进程的守护神daemontools和supervisor"><a href="#4-进程的守护神daemontools和supervisor" class="headerlink" title="4. 进程的守护神daemontools和supervisor"></a>4. 进程的守护神daemontools和supervisor</h2><p>daemontools：<a href="https://github.com/dendi875/Linux/blob/master/daemontools.md">https://github.com/dendi875/Linux/blob/master/daemontools.md</a></p><h2 id="5-参考资料"><a href="#5-参考资料" class="headerlink" title="5. 参考资料"></a>5. 参考资料</h2><ul><li><a href="https://book.douban.com/subject/1788421/">APUE</a></li><li><a href="https://www.php.net/manual/zh/book.posix.php">PHP：POSIX</a></li><li><a href="https://www.php.net/manual/zh/book.pcntl.php">PHP：PCNTL</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 编程语言 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git 的 4 个阶段的撤销更改</title>
      <link href="/2021/06/29/git-de-4-ge-jie-duan-de-che-xiao-geng-gai/"/>
      <url>/2021/06/29/git-de-4-ge-jie-duan-de-che-xiao-geng-gai/</url>
      
        <content type="html"><![CDATA[<h1 id="Git-的-4-个阶段的撤销更改"><a href="#Git-的-4-个阶段的撤销更改" class="headerlink" title="Git 的 4 个阶段的撤销更改"></a>Git 的 4 个阶段的撤销更改</h1><blockquote><p>原文出处：<a href="https://www.fengerzh.com/git-reset/">张京</a></p></blockquote><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/63918611gy1fltan48ktfj21hm12y7f5.jpg" alt="img"></p><p>虽然git诞生距今已有12年之久，网上各种关于git的介绍文章数不胜数，但是依然有很多人（包括我自己在内）对于它的功能不能完全掌握。以下的介绍只是基于我个人对于git的理解，并且可能生编硬造了一些不完全符合git说法的词语。目的只是为了让git通俗化，使初学者也能大概了解如何快速上手git。同时，下面所有讨论，我们都假设只使用一个分支，也就是主分支master的情况，虽然这种作法并不符合git规范，但是现实情况中绝大部分用户是直接在master分支上进行工作的，所以在这里我们不去引入更加复杂的各种分支的情况，也不涉及标签tag的操作，只讲在最简单的主分支上如何回退。</p><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="3个步骤"><a href="#3个步骤" class="headerlink" title="3个步骤"></a>3个步骤</h3><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/63918611gy1fltan4vu1cj20m80463yo.jpg" alt="img"></p><p>正常情况下，我们的工作流就是3个步骤，对应上图中的3个箭头线：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git add .git commit -m "comment"git push<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol><li><code>git add .</code> 把所有文件放入<code>暂存区</code>；</li><li><code>git commit</code> 把所有文件从<code>暂存区</code>提交进<code>本地仓库</code>；</li><li><code>git push</code> 把所有文件从<code>本地仓库</code>推送进<code>远程仓库</code>。</li></ol><h3 id="4个区"><a href="#4个区" class="headerlink" title="4个区"></a>4个区</h3><p>git之所以令人费解，主要是它相比于svn等等传统的版本管理工具，多引入了一个<strong>暂存区</strong>(Stage)的概念，就因为多了这一个概念，而使很多人疑惑。其实，在初学者来说，每个区具体怎么工作的，我们完全不需要关心，而只要知道有这么4个区就够了：</p><ul><li>工作区(Working Area)</li><li>暂存区(Stage)</li><li>本地仓库(Local Repository)</li><li>远程仓库(Remote Repository)</li></ul><h3 id="5种状态"><a href="#5种状态" class="headerlink" title="5种状态"></a>5种状态</h3><p>以上4个区，进入每一个区成功之后会产生一个状态，再加上最初始的一个状态，一共是5种状态。以下我们把这5种状态分别命名为：</p><ul><li>未修改(Origin)</li><li>已修改(Modified)</li><li>已暂存(Staged)</li><li>已提交(Committed)</li><li>已推送(Pushed)</li></ul><h2 id="检查修改"><a href="#检查修改" class="headerlink" title="检查修改"></a>检查修改</h2><p>了解了基本概念之后，我们来谈一谈犯错误之后如何撤销的问题。首先，我们要了解如何检查这3个步骤当中每一个步骤修改了什么，然后才好判断有没有修改成功。检查修改的二级命令都相同，都是diff，只是参数有所不同。</p><h3 id="已修改，未暂存"><a href="#已修改，未暂存" class="headerlink" title="已修改，未暂存"></a>已修改，未暂存</h3><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git diff<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>首先，我们来看一下，如果我们只是简单地在浏览器里保存了一下文件，但是还没有做<code>git add .</code>之前，我们如何检查有哪些修改。我们先随便拿一个文件来做一下实验：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/63918611gy1fltan5a4xuj20fi07z3zc.jpg" alt="img"></p><p>我们在文件开头的第2行胡乱加了4个数字<code>1234</code>，存盘，这时文件进入了已修改状态，但是还没有进入<code>暂存区</code>，我们运行<code>git diff</code>，结果如下：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">diff --git a/index.md b/index.mdindex 73ff1ba..1066758 100644--- a/index.md+++ b/index.md&lt;a href='http://www.jobbole.com/members/li754132448'&gt;@@&lt;/a&gt; -1,5 +1,5 &lt;a href='http://www.jobbole.com/members/li754132448'&gt;@@&lt;/a&gt; ----layout: main+1234layout: main color: black ---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>git diff</code>的结果告诉我们哪些文件已经做了哪些修改。</p><h3 id="已暂存，未提交"><a href="#已暂存，未提交" class="headerlink" title="已暂存，未提交"></a>已暂存，未提交</h3><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git diff --cached<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>现在我们把修改放入<code>暂存区</code>看一下。先执行<code>git add .</code>，然后执行<code>git diff</code>，你会发现没有任何结果：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/63918611gy1fltan5m82pj20ag01rt8l.jpg" alt="img"></p><p>这说明<code>git diff</code>这个命令只检查我们的<code>工作区</code>和<code>暂存区</code>之间的差异，如果我们想看到<code>暂存区</code>和<code>本地仓库</code>之间的差异，就需要加一个参数<code>git diff --cached</code>：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">diff --git a/index.md b/index.mdindex 73ff1ba..1066758 100644--- a/index.md+++ b/index.md&lt;a href='http://www.jobbole.com/members/li754132448'&gt;@@&lt;/a&gt; -1,5 +1,5 &lt;a href='http://www.jobbole.com/members/li754132448'&gt;@@&lt;/a&gt; ----layout: main+1234layout: main color: black ---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这时候我们看到的差异是<code>暂存区</code>和<code>本地仓库</code>之间的差异。</p><h3 id="已提交，未推送"><a href="#已提交，未推送" class="headerlink" title="已提交，未推送"></a>已提交，未推送</h3><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git diff master origin/master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>现在，我们把修改从<code>暂存区</code>提交到<code>本地仓库</code>，再看一下差异。先执行<code>git commit</code>，然后再执行<code>git diff --cached</code>，没有差异，执行<code>git diff master origin/master</code>，可以看到差异：</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/63918611gy1fltan637jhj20en076aas.jpg" alt="img"></p><p>在这里，<code>master</code>就是你的本地仓库，而<code>origin/master</code>就是你的远程仓库，<code>master</code>是主分支的意思，因为我们都在主分支上工作，所以这里两边都是<code>master</code>，而<code>origin</code>就代表远程。</p><h2 id="撤销修改"><a href="#撤销修改" class="headerlink" title="撤销修改"></a>撤销修改</h2><p>了解清楚如何检查各种修改之后，我们开始尝试各种撤销操作。</p><h3 id="已修改，未暂存-1"><a href="#已修改，未暂存-1" class="headerlink" title="已修改，未暂存"></a>已修改，未暂存</h3><p>如果我们只是在编辑器里修改了文件，但还没有执行<code>git add .</code>，这时候我们的文件还在工作区，并没有进入暂存区，我们可以用：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git checkout .<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>或者</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git reset --hard<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>来进行撤销操作。</p><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/63918611gy1fltan6hur7j20c9075jrr.jpg" alt="img"></p><p>可以看到，在执行完<code>git checkout .</code>之后，修改已被撤销，<code>git diff</code>没有任何内容了。</p><blockquote><p><strong>一对反义词</strong> <code>git add .</code>的反义词是<code>git checkout .</code>。做完修改之后，如果你想向前走一步，让修改进入暂存区，就执行<code>git add .</code>，如果你想向后退一步，撤销刚才的修改，就执行<code>git checkout .</code>。</p></blockquote><h3 id="已暂存，未提交-1"><a href="#已暂存，未提交-1" class="headerlink" title="已暂存，未提交"></a>已暂存，未提交</h3><p>你已经执行了<code>git add .</code>，但还没有执行<code>git commit -m "comment"</code>。这时候你意识到了错误，想要撤销，你可以执行：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git resetgit checkout .<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>或者</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git reset --hard<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>git reset</code>只是把修改退回到了<code>git add .</code>之前的状态，也就是说文件本身还处于已修改未暂存状态，你如果想退回未修改状态，还需要执行<code>git checkout .</code>。</p><p>或许你已经注意到了，以上两个步骤都可以用同一个命令<code>git reset --hard</code>来完成。是的，就是这个强大的命令，可以一步到位地把你的修改完全恢复到未修改的状态。</p><h3 id="已提交，未推送-1"><a href="#已提交，未推送-1" class="headerlink" title="已提交，未推送"></a>已提交，未推送</h3><p>你的手太快，你既执行了<code>git add .</code>，又执行了<code>git commit</code>，这时候你的代码已经进入了你的本地仓库，然而你后悔了，怎么办？不要着急，还有办法。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git reset --hard origin/master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>还是这个<code>git reset --hard</code>命令，只不过这次多了一个参数<code>origin/master</code>，正如我们上面讲过的，<code>origin/master</code>代表远程仓库，既然你已经污染了你的本地仓库，那么就从远程仓库把代码取回来吧。</p><h3 id="已推送"><a href="#已推送" class="headerlink" title="已推送"></a>已推送</h3><p>很不幸，你的手实在是太快了，你既<code>git add</code>了，又<code>git commit</code>了，并且还<code>git push</code>了，这时你的代码已经进入远程仓库。如果你想恢复的话，还好，由于你的本地仓库和远程仓库是等价的，你只需要先恢复本地仓库，再强制push到远程仓库就好了：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git reset --hard HEAD^git push -f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/63918611gy1fltan6vs0lj20di04d0td.jpg" alt="img"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上4种状态的撤销我们都用到了同一个命令<code>git reset --hard</code>，前2种状态的用法甚至完全一样，所以只要掌握了<code>git reset --hard</code>这个命令的用法，从此你再也不用担心提交错误了。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://www.fengerzh.com/git-reset/">原文</a></li><li><a href="https://segmentfault.com/a/1190000011910766">独孤求败：Git中的各种后悔药</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 学习研究</title>
      <link href="/2021/06/29/elasticsearch-xue-xi-yan-jiu/"/>
      <url>/2021/06/29/elasticsearch-xue-xi-yan-jiu/</url>
      
        <content type="html"><![CDATA[<h1 id="Elasticsearch-学习研究"><a href="#Elasticsearch-学习研究" class="headerlink" title="Elasticsearch 学习研究"></a>Elasticsearch 学习研究</h1><hr><h2 id="1-Elasticsearch-介绍"><a href="#1-Elasticsearch-介绍" class="headerlink" title="1. Elasticsearch 介绍"></a>1. Elasticsearch 介绍</h2><p>Elasticsearch（ES）是基于文本搜索库<a href="https://lucene.apache.org/">Lucene</a>构建的高度可扩展的分布式开源搜索和分析引擎。</p><p>如果有足够的计算机，ES集群通常可以跨非常大的数据集执行搜索和聚合查询。<br>如果你希望对一组文本文档进行传统的全文本搜索（类似于 Google 搜索），则ES很适合，</p><p>Elasticsearch 主要用于搜索和日志分析，也是当今最流行的日志分析平台（ELK）（Elasticsearch，Logstash和Kibana）的核心。它在处理大数据（如：系统日志，网络流量）时非常有用。</p><h2 id="2-Elasticsearch-中的重要概念"><a href="#2-Elasticsearch-中的重要概念" class="headerlink" title="2. Elasticsearch 中的重要概念"></a>2. Elasticsearch 中的重要概念</h2><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/Elasticsearch.png" alt="Elasticsearch"></p><h3 id="2-1-Cluster（集群）"><a href="#2-1-Cluster（集群）" class="headerlink" title="2.1 Cluster（集群）"></a>2.1 Cluster（集群）</h3><p>cluster是一个或一组服务器（节点）的集合，这些节点一起协同保存你的数据，并在所有节点之间为你提供索引和搜索功能。cluster具有唯一名称标识（默认是elasticsearch），你只需要指定集群标识名，启动的时候，凡是集群是这个名字的节点都会默认加到同一个集群中，选举master节点和节点管理都是自动完成的。当然一个节点也可以组成一个集群。</p><h3 id="2-2-Node（节点）"><a href="#2-2-Node（节点）" class="headerlink" title="2.2 Node（节点）"></a>2.2 Node（节点）</h3><p>node是参与到cluster的单个服务器节点，具有唯一标识名，可加入到指定的cluster中。 单个es实例称为一个节点（node）。一组节点构成一个集群（cluster）。</p><h3 id="2-3-Index（索引）"><a href="#2-3-Index（索引）" class="headerlink" title="2.3 Index（索引）"></a>2.3 Index（索引）</h3><p>Index是一类文档的集合。例如，你可以为用户数据创建一个索引，为商品数据创建另一个索引，为订单数据创建另一个索引。es 数据管理的顶层单位就叫做 Index（索引），相当于传统数据库中的数据库。每个 Index （即数据库）的名字必须是小写。</p><p>es数据的索引、搜索和分析都是基于索引完成的。每个Index包含多个shard，默认是5个，分散在不同的node上。当索引创建完成的时候，主分片的数量就固定了，但是复制分片的数量可以随时调整。</p><p>在单个cluster中，你可以创建任意个Index。</p><p>下面的命令可以查看当前节点的所有 Index。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl -X GET 'http://localhost:9200/_cat/indices?v' -d ''health status index  pri rep docs.count docs.deleted store.size pri.store.sizeyellow open   orders   5   1          0            0       650b           650b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="2-4-Type（类型）"><a href="#2-4-Type（类型）" class="headerlink" title="2.4 Type（类型）"></a>2.4 Type（类型）</h3><p>Type是 Index 中数据的 ，在索引中，你可以定义一个或多个类型。它是索引中虚拟逻辑的分组，用来过滤    Document ，相当于传统数据库的表。</p><p>不同的 Type 应该有相似的结构（schema），举例来说，<code>id</code>字段不能在这个 Type 是字符串，在另 Type 是数值。这是与关系型数据库的表的一个<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.3/mapping.html">区别</a>。</p><p>举例来说，在一个商城系统中，你可以定义一个订单的 type（orders_order），可以定义一个商品的 type（orders_product），还可以定义一个日志的 type（orders_log）。</p><p>下面的命令可以列出每个 Index 所包含的 Type。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl 'http://localhost:9200/_mapping?pretty=true'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-5-Document（文档）"><a href="#2-5-Document（文档）" class="headerlink" title="2.5 Document（文档）"></a>2.5 Document（文档）</h3><p>Document是es数据可被索引化的基本的存储单元，需要存储在Type中，相当于传统数据库的行记录。</p><p>Index 里面单条的记录称为 Document（文档）。许多条 Document 构成了一个 Index。</p><p>Document 使用 JSON 格式表示，下面是一个例子。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">{  "name": "张三",  "title": "工程师",  "desc": "数据库管理"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-6-Shard（分片）"><a href="#2-6-Shard（分片）" class="headerlink" title="2.6 Shard（分片）"></a>2.6 Shard（分片）</h3><p>一个索引可能会存储大量的数据，进而会让单个节点超出硬件能承受范围。举例来说，存储了10亿文档的单个节点，会占用1TB磁盘空间，并且会导致查询的时候速度很慢。</p><p>为了解决这个问题，Elasticsearch 提供了分片，也就是将index细分为多个碎片的功能。当你创建index的时候，你可以简单地指定你想要的分片数量。每一个分片具有和 index 完全相同的功能。</p><p>碎片最主要的两个作用是：</p><ul><li>它允许你水平地切割你的容量体积</li><li>它允许你并行地分发作业，提高系统的性能</li></ul><p>默认在创建索引时会创建5个分片，这个数量可以修改。分片的数量只能在创建索引的时候指定，不能在后期修改。</p><h3 id="2-7-Replicas（副本）"><a href="#2-7-Replicas（副本）" class="headerlink" title="2.7 Replicas（副本）"></a>2.7 Replicas（副本）</h3><p>因为各种原因，所以数据丢失等问题会时有发生，碎片也可能会丢失，为了防止这个问题，所以你可以将一个或多个索引碎片复制到所谓的复制碎片，简称为副本。</p><p>副本最主要的两个作用是：</p><ul><li>它提供了高可用性，以防碎片/节点失败。基于这点，所以副本的永远不要和原始碎片分布在同一个节点上</li><li>它可以扩展系统的吞吐量，因为搜索可以在所有副本上执行</li></ul><p>默认情况下，Elasticsearch为每个索引分配了5个主碎片和1个副本，这意味着在你的集群中，如果至少有两个节点，那么每个索引将有5个主碎片和5个复制碎片，每个索引总共10个碎片。</p><p>将Elasticsearch和传统关系型数据库Mysql做一下类比：</p><table><thead><tr><th>MySQL</th><th>Elasticsearch</th></tr></thead><tbody><tr><td>Database（数据库）</td><td>Index（索引）</td></tr><tr><td>Table（表）</td><td>Type（类型）</td></tr><tr><td>Row（行）</td><td>Document（文档）</td></tr><tr><td>Column（列）</td><td>Field（字段）</td></tr><tr><td>Schema（方案）</td><td>Mapping（映射）</td></tr><tr><td>Index（索引）</td><td>Everything Indexed by default（默认情况下所有字段都被索引）</td></tr><tr><td>SQL（结构化查询语言）</td><td>Query DSL（查询专用语言）</td></tr></tbody></table><h2 id="3-Elasticsearch-安装和配置"><a href="#3-Elasticsearch-安装和配置" class="headerlink" title="3. Elasticsearch 安装和配置"></a>3. Elasticsearch 安装和配置</h2><h3 id="3-1-安装"><a href="#3-1-安装" class="headerlink" title="3.1 安装"></a>3.1 安装</h3><p>Elasticsearch 至少需要 Java 7  环境。如果你的机器还没安装 Java，可以参考<a href="https://www.liquidweb.com/kb/install-java-8-on-centos-7/">这篇文章</a>。</p><p>安装完 Java，就可以跟着<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/_installation.html#_installation">官方文档</a>安装 Elasticsearch。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># cd /usr/local/software/# curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.5.3.tar.gz# # tar -zxvf elasticsearch-5.5.3.tar.gz  -C /usr/local/# # cd /usr/local/elasticsearch-5.5.3/# ./bin/elasticsearch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果这时报错”Exception in thread “main” java.lang.RuntimeException: don’t run elasticsearch as root.”，表示不能以超级用户root启动es，我们新建一个用户：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># useradd es# passwd es# chown -R es:es /usr/local/elasticsearch-5.5.3/# su - es$ /usr/local/elasticsearch-5.5.3/bin/elasticsearch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果这时报错“max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]”，这表示文件描述符太少了，我们需要设置文件描述数量：</p><p>查看<code>es</code>用户硬限制：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ ulimit -Hn4096<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>打开<code>/etc/security/limits.conf</code>增加一行：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">es  - nofile  65536<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>退出<code>es</code>用户，再重新看硬限制：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ ulimit -Hn65536<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果一切正常，es 就会在默认的9200端口运行。开启另一个终端查看es进程和端口：</p><pre class="line-numbers language-none"><code class="language-none"># ps -ef | grep elastices        1753  1726  8 18:14 pts/1    00:00:02 /bin/java -Xms2g -Xmx2g -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+AlwaysPreTouch -server -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -Djdk.io.permissionsUseCanonicalPath=true -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -Dlog4j.skipJansi=true -XX:+HeapDumpOnOutOfMemoryError -Des.path.home=/usr/local/elasticsearch-5.5.3 -cp /usr/local/elasticsearch-5.5.3/lib/* org.elasticsearch.bootstrap.Elasticsearchroot      1793  1596  0 18:14 pts/0    00:00:00 grep --color=auto elastic# netstat -tlunp | grep 9200tcp6       0      0 127.0.0.1:9200          :::*                    LISTEN      1753/java<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到es已经正常启动，除了查看es进程和端口外，我们还可以执行：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># curl 'http://localhost:9200'{  "name" : "Onl1EgV",  "cluster_name" : "elasticsearch",  "cluster_uuid" : "P3CrVh_BTO-1EVzJlyWXKg",  "version" : {    "number" : "5.5.3",    "build_hash" : "9305a5e",    "build_date" : "2017-09-07T15:56:59.599Z",    "build_snapshot" : false,    "lucene_version" : "6.6.0"  },  "tagline" : "You Know, for Search"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码中，请求9200端口，es 返回一个 JSON 对象，包含当前节点、集群、版本等信息。</p><p>以上es的运行方式可以通过<code>CTRL+C</code>或关闭窗口来停止运行，平时我们可以通过守护进程的方式在后台启动es：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ ./bin/elasticsearch -d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果是后台启动后想要停止es，可以通过<code>ps -ef | grep elastic</code>找到es进程PID，然后<code>kill</code>掉就行</p><h3 id="3-2-配置"><a href="#3-2-配置" class="headerlink" title="3.2 配置"></a>3.2 配置</h3><p>认情况下，es 只允许本机访问，如果需要远程访问，可以修改 es 安装目录的<em>ES_HOME/config/elasticsearch.yml</em>文件，去掉<strong>network.host</strong>的注释，将它的值改成<code>0.0.0.0</code>，然后重新启动 es。</p><p>如果远程还不能访问可能需要检查下<strong>防火墙</strong>和<strong>SELinux</strong>的设置。</p><p>其它配置项的解释可以参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/settings.html">官方页面</a></p><h2 id="4-Elasticsearch-插件"><a href="#4-Elasticsearch-插件" class="headerlink" title="4. Elasticsearch 插件"></a>4. Elasticsearch 插件</h2><h3 id="4-1-IK-中文分词插件"><a href="#4-1-IK-中文分词插件" class="headerlink" title="4.1 IK 中文分词插件"></a>4.1 IK 中文分词插件</h3><p>es 内置的分词器对中文不友好，会把中文分成单个字来进行全文检索，不能达到想要的结果，ik 可以进行友好的分词及自定义分词。</p><p>内置的分词器对中文会一个一个拆分，如下面是内置分词器的效果：</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">$ curl -H 'Content-Type: application/json'  -X GET 'localhost:9200/_analyze?pretty' -d '&gt; {&gt; "analyzer": "default",&gt; "text":"今天天气真好"&gt; }&gt; '{  "tokens" : [    {      "token" : "今",      "start_offset" : 0,      "end_offset" : 1,      "type" : "&lt;IDEOGRAPHIC&gt;",      "position" : 0    },    {      "token" : "天",      "start_offset" : 1,      "end_offset" : 2,      "type" : "&lt;IDEOGRAPHIC&gt;",      "position" : 1    },    {      "token" : "天",      "start_offset" : 2,      "end_offset" : 3,      "type" : "&lt;IDEOGRAPHIC&gt;",      "position" : 2    },    {      "token" : "气",      "start_offset" : 3,      "end_offset" : 4,      "type" : "&lt;IDEOGRAPHIC&gt;",      "position" : 3    },    {      "token" : "真",      "start_offset" : 4,      "end_offset" : 5,      "type" : "&lt;IDEOGRAPHIC&gt;",      "position" : 4    },    {      "token" : "好",      "start_offset" : 5,      "end_offset" : 6,      "type" : "&lt;IDEOGRAPHIC&gt;",      "position" : 5    }  ]}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先，安装中文分词插件。这里使用的是<a href="https://github.com/medcl/elasticsearch-analysis-ik/">ik</a></p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">[es@localhost elasticsearch-5.5.3]$ ./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.5.3/elasticsearch-analysis-ik-5.5.3.zip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接着，重新启动 Elastic，就会自动加载这个新安装的插件。</p><p>IK支持两种分词模式：</p><ul><li>ik_max_word: 会将文本做最细粒度的拆分，会穷尽各种可能的组合</li><li>ik_smart: 会做最粗粒度的拆分</li></ul><p>接下来，我们看看 IK 分词效果和自带的有什么不同。</p><p>先试一下<code>ik_smart</code>的效果：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"> curl -H 'Content-Type: application/json'  -X GET 'localhost:9200/_analyze?pretty' -d '&gt; {&gt; "analyzer": "ik_smart",&gt; "text":"今天天气真好"&gt; }&gt; '{  "tokens" : [    {      "token" : "今天天气",      "start_offset" : 0,      "end_offset" : 4,      "type" : "CN_WORD",      "position" : 0    },    {      "token" : "真好",      "start_offset" : 4,      "end_offset" : 6,      "type" : "CN_WORD",      "position" : 1    }  ]}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再试一下<code>ik_max_word</code>的效果：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">{  "tokens" : [    {      "token" : "今天天气",      "start_offset" : 0,      "end_offset" : 4,      "type" : "CN_WORD",      "position" : 0    },    {      "token" : "今天",      "start_offset" : 0,      "end_offset" : 2,      "type" : "CN_WORD",      "position" : 1    },    {      "token" : "天天",      "start_offset" : 1,      "end_offset" : 3,      "type" : "CN_WORD",      "position" : 2    },    {      "token" : "天气",      "start_offset" : 2,      "end_offset" : 4,      "type" : "CN_WORD",      "position" : 3    },    {      "token" : "真好",      "start_offset" : 4,      "end_offset" : 6,      "type" : "CN_WORD",      "position" : 4    }  ]}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>设置mapping默认分词器：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">curl -X PUT 'localhost:9200/userdoors' -d '{  "mappings": {    "person": {      "properties": {        "name": {          "type": "text",          "analyzer": "ik_max_word",          "search_analyzer": "ik_max_word"        },        "title": {          "type": "text",          "analyzer": "ik_max_word",          "search_analyzer": "ik_max_word"        },        "desc": {          "type": "text",          "analyzer": "ik_max_word",          "search_analyzer": "ik_max_word"        }      }    }  }}'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>面代码中，首先新建一个名称为<code>userdoor</code>的Index，里面有一个名称为<code>person</code>的 Type。person有三个字段<code>name</code>、<code>title</code>、<code>desc</code>。</p><p><strong>注意：</strong> 这里设置<code>search_analyzer</code>与<code>analyzer</code> 相同是为了确保搜索时和索引时使用相同的分词器，以确保查询中的术语与反向索引中的术语具有相同的格式。如果不设置<code>search_analyzer</code>，则 <code>search_analyzer</code> 与 <code>analyzer</code> 相同。详细请查阅官网<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/search-analyzer.html">搜索分析器</a></p><h3 id="4-2-head-插件"><a href="#4-2-head-插件" class="headerlink" title="4.2 head 插件"></a>4.2 head 插件</h3><h2 id="5-Elasticsearch-REST-APIs-的使用"><a href="#5-Elasticsearch-REST-APIs-的使用" class="headerlink" title="5. Elasticsearch REST APIs 的使用"></a>5. Elasticsearch REST APIs 的使用</h2><h3 id="5-1-Indices-APIs（索引API）"><a href="#5-1-Indices-APIs（索引API）" class="headerlink" title="5.1 Indices APIs（索引API）"></a>5.1 Indices APIs（索引API）</h3><p>索引API用于对索引进行各种管理，如：创建索引、删除索引、获取索引等，还包括，索引设置，别名管理，映射管理，状态管理等。</p><h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><p>新建 Index，可以直接向 es 服务器发出 PUT 请求。下面的例子是新建一个名叫orders的 Index。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl -X PUT 'http://localhost:9200/orders' -d ''{"acknowledged":true}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>服务器返回一个 JSON 对象，里面的<code>acknowledged</code>字段表示操作成功。</p><h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><p>我们发出 DELETE 请求，删除这个 Index。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl -X DELETE 'http://localhost:9200/orders'{"acknowledged":true}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="5-2-Document-APIs（文档API）"><a href="#5-2-Document-APIs（文档API）" class="headerlink" title="5.2 Document APIs（文档API）"></a>5.2 Document APIs（文档API）</h3><h4 id="新增文档"><a href="#新增文档" class="headerlink" title="新增文档"></a>新增文档</h4><p>向指定的 /Index/Type 发送 PUT 请求，就可以在 Index 里面新增一条记录。比如，向<code>/userdoor/person</code>发送请求，就可以新增一条人员记录。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl -X PUT 'localhost:9200/userdoor/person/1?pretty=true' -d '&gt; {&gt;   "name": "张三",&gt;   "title": "工程师",&gt;   "desc": "数据库管理"&gt; }'{  "_index" : "userdoor",  "_type" : "person",  "_id" : "1",  "_version" : 4,  "result" : "created",  "_shards" : {    "total" : 2,    "successful" : 1,    "failed" : 0  },  "created" : true}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后的1是该条记录的 <code>Id</code>。它不一定是数字，任意字符串（比如abc）都可以。<strong>URL</strong> 的参数<code>pretty=true</code>表示以易读的格式返回。</p><p>新增记录的时候，也可以不指定 <code>Id</code>，让<code>es</code>自动生成唯一的<code>Id</code>这时要改成 <strong>POST</strong> 请求。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl -X POST 'localhost:9200/userdoor/person?pretty' -d '&gt; {&gt;   "name": "李四",&gt;   "title": "工程师",&gt;   "desc": "运维管理"&gt; }'{  "_index" : "userdoor",  "_type" : "person",  "_id" : "AW8ETT-SDmqcpvuz_i-w",  "_version" : 1,  "result" : "created",  "_shards" : {    "total" : 2,    "successful" : 1,    "failed" : 0  },  "created" : true}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意，如果没有先创建 Index（这个例子是userdoor），直接执行上面的命令，es 也不会报错，而是直接生成指定的 Index。</p><h4 id="查看文档"><a href="#查看文档" class="headerlink" title="查看文档"></a>查看文档</h4><p>向/Index/Type/Id发出 GET 请求，就可以查看这条记录。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl -X GET 'localhost:9200/userdoor/person/1?pretty=true'{  "_index" : "userdoor",  "_type" : "person",  "_id" : "1",  "_version" : 4,  "found" : true,  "_source" : {    "name" : "张三",    "title" : "工程师",    "desc" : "数据库管理"  }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h4><p>更新记录就是使用 PUT 请求，重新发送一次数据。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl -X PUT 'localhost:9200/userdoor/person/1?pretty' -d '&gt; {&gt;   "name": "张三",&gt;   "title": "工程师",&gt;   "desc": "数据库管理，软件开发"&gt; }'{  "_index" : "userdoor",  "_type" : "person",  "_id" : "1",  "_version" : 5,  "result" : "updated",  "_shards" : {    "total" : 2,    "successful" : 1,    "failed" : 0  },  "created" : false}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl -X DELETE 'localhost:9200/userdoor/person/1?pretty' -d ''<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="5-3-Search-APIs（搜索API）"><a href="#5-3-Search-APIs（搜索API）" class="headerlink" title="5.3 Search APIs（搜索API）"></a>5.3 Search APIs（搜索API）</h3><h4 id="查询所有文档"><a href="#查询所有文档" class="headerlink" title="查询所有文档"></a>查询所有文档</h4><p>使用 GET 方法，直接请求/Index/Type/_search，就会返回所有记录。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl 'localhost:9200/userdoor/person/_search?pretty'{  "took" : 185,  "timed_out" : false,  "_shards" : {    "total" : 5,    "successful" : 5,    "failed" : 0  },  "hits" : {    "total" : 2,    "max_score" : 1.0,    "hits" : [      {        "_index" : "userdoor",        "_type" : "person",        "_id" : "AW8ETT-SDmqcpvuz_i-w",        "_score" : 1.0,        "_source" : {          "name" : "李四",          "title" : "工程师",          "desc" : "运维管理"        }      },      {        "_index" : "userdoor",        "_type" : "person",        "_id" : "1",        "_score" : 1.0,        "_source" : {          "name" : "张三",          "title" : "工程师",          "desc" : "数据库管理，软件开发"        }      }    ]  }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码中，返回结果的 <code>took</code>字段表示该操作的耗时（单位为毫秒），<code>timed_out</code>字段表示是否超时，<code>hits</code>字段表示命中的记录，里面子字段的含义如下。</p><ul><li>total：返回记录数，本例是2条。</li><li>max_score：最高的匹配程度，本例是1.0。</li><li>hits：返回的记录组成的数组。</li></ul><p>返回的记录中，每条记录都有一个<code>_score</code>字段，表示匹配的程序，默认是按照这个字段降序排列。</p><h3 id="5-4-Query-DSL"><a href="#5-4-Query-DSL" class="headerlink" title="5.4 Query DSL"></a>5.4 Query DSL</h3><p>Elastic 的查询非常特别，使用自己的<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/query-dsl.html">查询语法</a>，要求 GET 请求带有数据体。</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ curl 'localhost:9200/userdoor/person/_search?pretty'  -d '&gt; {&gt;   "query" : { "match" : { "desc" : "软件" }}&gt; }'{  "took" : 27,  "timed_out" : false,  "_shards" : {    "total" : 5,    "successful" : 5,    "failed" : 0  },  "hits" : {    "total" : 1,    "max_score" : 0.28582606,    "hits" : [      {        "_index" : "userdoor",        "_type" : "person",        "_id" : "1",        "_score" : 0.28582606,        "_source" : {          "name" : "张三",          "title" : "工程师",          "desc" : "数据库管理，软件开发"        }      }    ]  }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码使用 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/query-dsl-match-query.html">Match 查询</a> ，指定的匹配条件是<code>desc</code>字段里面包含”软件”这个词</p><h2 id="6-参考资料"><a href="#6-参考资料" class="headerlink" title="6. 参考资料"></a>6. 参考资料</h2><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch 官方手册</a></li><li><a href="https://github.com/mobz/elasticsearch-head">elasticsearch-head</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 中间件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用openssl自建CA和颁发多域名通配符证书</title>
      <link href="/2021/06/29/shi-yong-openssl-zi-jian-ca-he-ban-fa-duo-yu-ming-tong-pei-fu-zheng-shu/"/>
      <url>/2021/06/29/shi-yong-openssl-zi-jian-ca-he-ban-fa-duo-yu-ming-tong-pei-fu-zheng-shu/</url>
      
        <content type="html"><![CDATA[<h1 id="使用openssl自建CA和颁发多域名通配符证书"><a href="#使用openssl自建CA和颁发多域名通配符证书" class="headerlink" title="使用openssl自建CA和颁发多域名通配符证书"></a>使用openssl自建CA和颁发多域名通配符证书</h1><hr><h2 id="常见的证书分类"><a href="#常见的证书分类" class="headerlink" title="常见的证书分类"></a>常见的证书分类</h2><ol><li><p>单域名ssl证书</p><p> 只保护一个域名，例如如果想要保护<a href="http://www.test.com,a.demo.com,b.example.com;每个域名分别需要一个证书./">www.test.com，a.demo.com，b.example.com；每个域名分别需要一个证书。</a></p></li><li><p>多域名ssl证书</p><p> 可以同时保护多个域名，例如同时保护<a href="http://www.test.com,a.demo.com,b.example.com等,但每一个品牌的多域名证书保护的域名数量不一样./">www.test.com，a.demo.com，b.example.com等，但每一个品牌的多域名证书保护的域名数量不一样。</a></p></li><li><p>通配符ssl证书</p><p> <strong>可以保护主域名本身及下一级的所有子域名，但不支持无限级子域名。</strong>例如*.test.com证书可以保护a.test.com，b.test.com，c.test.com但无法保护x.y.test.com。</p></li><li><p>多域名通配符ssl证书</p><p> 可以保护多个域名以及每个域名的所有二级域名，相当于将多个通配符证书合并为一个证书，例如一个多域名通配符证书可以保护test.com和demo.com，同时也能保护test.com及demo.com的所有二级域名。</p></li></ol><h2 id="制作多域名通配符ssl证书"><a href="#制作多域名通配符ssl证书" class="headerlink" title="制作多域名通配符ssl证书"></a>制作多域名通配符ssl证书</h2><h3 id="1-CA服务器配置"><a href="#1-CA服务器配置" class="headerlink" title="1. CA服务器配置"></a>1. CA服务器配置</h3><p>1.1. 在CA目录下创建两个初始文件：</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ~]# cd /etc/pki/CA/[root@localhost CA]# touch index.txt serial[root@localhost CA]# echo 01 &gt; serial<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>1.2.  生成CA证书的RSA私钥</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost CA]# openssl genrsa -out private/ca.key 2048<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><code>-out private/ca.key</code>是私钥存放的目录和文件名，2048指密钥长度</li><li>这里注意，公钥是按某种格式从私钥中提取出来的、公钥和私钥是成对的、生成私钥也就有了公钥</li></ul><p>1.3. 通过私钥提取公钥(这不是必要的步骤)</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost CA]# openssl rsa -in private/ca.key -pubout -out private/pub.key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>1.4. 利用CA的RSA密钥生成CA证书请求并对CA证书请求进行自签名，得到CA证书(X.509结构)</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">openssl req -new -sha256 -x509 -days 3650 -key private/ca.key -out cacert.crt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>签发机构名示例如下</li></ul><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">Country Name (2 letter code) [XX]:CNState or Province Name (full name) []:ShangHaiLocality Name (eg, city) [Default City]:ShangHaiOrganization Name (eg, company) [Default Company Ltd]:GuanaitongOrganizational Unit Name (eg, section) []:PHPCommon Name (eg, your name or your server's hostname) []:Test Root CAEmail Address []:quan.zhang@guanaitong.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>可以使用<code>-subj</code>在非交互式下来代替请求字段信息</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">openssl req -new \            -sha256 \            -x509 \            -days 3650 \            -key private/ca.key \            -subj "/C=CN/ST=ShangHai/L=ShangHai/O=Guanaitong/OU=PHP/CN=Test Root CA/emailAddress=quan.zhang@guanaitong.com" \            -out cacert.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>cacert.crt</code>就是得到的CA证书</p></li></ul><hr><h3 id="2-Web服务器配置-以nginx为例"><a href="#2-Web服务器配置-以nginx为例" class="headerlink" title="2. Web服务器配置(以nginx为例)"></a>2. Web服务器配置(以nginx为例)</h3><p>2.1 建立存放服务器私钥和证书的目录</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost CA]# cd /usr/local/nginx/conf/[root@localhost conf]# mkdir ssl &amp;&amp; cd ssl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>2.2 生成服务器证书用的RSA私钥</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ssl]# openssl genrsa -out nginx.key 2048<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2.3 利用生成好的私钥生成服务器证书签名请求文件</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ssl]# openssl req -new -sha256 -key nginx.key -out nginx.csr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>签名请求内容示例如下：</li></ul><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">Country Name (2 letter code) [XX]:CNState or Province Name (full name) []:ShangHaiLocality Name (eg, city) [Default City]:ShangHaiOrganization Name (eg, company) [Default Company Ltd]:GuanaitongOrganizational Unit Name (eg, section) []:PHPCommon Name (eg, your name or your server's hostname) []:Test InternalEmail Address []:Please enter the following 'extra' attributesto be sent with your certificate requestA challenge password []:An optional company name []:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>可以使用<code>-subj</code>在非交互式下来代替请求字段信息<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">openssl req -new \            -sha256 \            -key nginx.key \            -subj "/C=CN/ST=ShangHai/L=ShangHai/O=Guanaitong/OU=PHP/CN=Test Internal" \            -out nginx.csr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>2.4 使用CA根证书对“服务器证书签名请求文件”进行签名，生成带SAN扩展证书</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">openssl x509 -req -sha256 \             -in nginx.csr \             -CA /etc/pki/CA/cacert.crt \             -CAkey /etc/pki/CA/private/ca.key \             -CAcreateserial \             -days 3650 \             -extfile v3.ext \             -out nginx.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>-extfile：指定当前创建的证书的扩展文件<br>-extensions section：指定当前创建的证书使用配置文件中的哪个section作为扩展属性。</p></blockquote><ul><li>v3.ext内容示例如下</li></ul><pre class="line-numbers language-none"><code class="language-none">subjectAltName = @alt_names[alt_names]DNS.1 = www.testvm.devDNS.2 = *.demo.dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>这里使用<code>openssl</code>的<code>SubjectAlternativeName(SAN)</code>实现一个CA证书对多个通配符域名进行签名保护。</p></li><li><p>ssl目录内容</p></li></ul><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">ssl├── nginx.crt   #服务器证书├── nginx.csr   #证书签名请求文件├── nginx.key   #服务器私钥└── v3.ext<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>查看CSR和CRT文件细节<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ssl]# openssl req -noout -text -in nginx.csr[root@localhost ssl]# openssl x509 -noout -text -in nginx.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="3-nginx配置ssl加密"><a href="#3-nginx配置ssl加密" class="headerlink" title="3. nginx配置ssl加密"></a>3. nginx配置ssl加密</h3><p>3.1 默认nginx是没有安装ssl模块的，需要编译安装nginx时加入<code>--with-http_ssl_module</code>选项</p><p>3.2 nginx配置文件的server指令添加如下配置</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">server { listen       80; listen       443 ssl; server_name www.testvm.dev; ssl_certificate   /usr/local/nginx/conf/ssl/nginx.crt; ssl_certificate_key /usr/local/nginx/conf/ssl/nginx.key; root   /data1/www/test; index  index.php index.html index.htm; location ~ \.php$ {     fastcgi_pass   127.0.0.1:9000;     fastcgi_index  index.php;     fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;     include        fastcgi_params;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3.3 重新加载nginx配置</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost ssl]# /usr/local/nginx/sbin/nginx -t[root@localhost ssl]# /usr/local/nginx/sbin/nginx -s reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="4-浏览器导入自己制做的CA证书"><a href="#4-浏览器导入自己制做的CA证书" class="headerlink" title="4. 浏览器导入自己制做的CA证书"></a>4. 浏览器导入自己制做的CA证书</h3><h3 id="5-为linux系统添加根证书"><a href="#5-为linux系统添加根证书" class="headerlink" title="5. 为linux系统添加根证书"></a>5. 为linux系统添加根证书</h3><ul><li>我们来看下这种情况假设<code>/data1/www/test/index.php</code>文件内容如下：</li></ul><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">echo</span> <span class="token string single-quoted-string">'success'</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost test]# curl https://www.testvm.dev/index.phpcurl: (60) Peer certificate cannot be authenticated with known CA certificatesMore details here: http://curl.haxx.se/docs/sslcerts.htmlcurl performs SSL certificate verification by default, using a "bundle" of Certificate Authority (CA) public keys (CA certs). If the default bundle file isn't adequate, you can specify an alternate file using the --cacert option.If this HTTPS server uses a certificate signed by a CA represented in the bundle, the certificate verification probably failed due to a problem with the certificate (it might be expired, or the name might not match the domain name in the URL).If you'd like to turn off curl's verification of the certificate, use the -k (or --insecure) option.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost test]# curl https://www.baidu.com&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt; &lt;head&gt;&lt;meta http-equiv=content-type content=text/html;charset=utf-8&gt;&lt;meta http-equiv=X-UA-Compatible content=IE=Edge&gt;&lt;meta content=always name=referrer&gt;&lt;link rel=stylesheet type=text/css href=https://ss1.bdstatic.com/5eN1bjq8AAUYm2zgoY3K/r/www/cache/bdorz/baidu.min.css&gt;&lt;title&gt;百度一下，你就知道&lt;/title&gt; (剩余内容省略)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><p>当我们访问我们自己站点时（<code>curl https://www.testvm.dev</code>）提示我们curl在linux的证书信任集里没有找到根证书，你可以使用<code>curl --insecure</code>来不验证证书的可靠性，这只能保证数据是加密传输的但无法保证对方是我们要访问的服务。使用<code>curl --cacert cacert.pem</code>可以手动指定根证书路径。为什么访问百度的<code>https</code>站点时就能正确返回内容？</p><ul><li>因为为百度站点签署的CA证书已经内置在操作系统中了，curl 访问https站点时会自动去获取操作系统内置的证书，而我们自已签名的CA证书没有导入到操作系统中，所以会获取不到内容。</li></ul></li></ul><ul><li>把自己制作的CA证书导入到操作系统中</li></ul><blockquote><p>Ubuntu, Debian系列</p></blockquote><p>0.内置的证书集在这个文件里<code>/etc/ssl/certs/ca-certificates.crt</code></p><p>1.将自己制作的CA证书复制到<code>/usr/local/share/ca-certificates/</code>目录下</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost test]# cp /etc/pki/CA/cacert.crt  /usr/local/share/ca-certificates/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2.更新操作系统CA证书库</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost test]# update-ca-certificates<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>3.更多的命令行参数及说明， 请查看: <code>man update-ca-certificates</code></p><blockquote><p>Centos系列</p></blockquote><p>0.内置的证书集在这个文件里<code>/etc/pki/tls/cert.pem</code></p><p>1.安装根证书管理包软件</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost test]# yum install ca-certificates<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2.打开根证书动态配置开关</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost test]# update-ca-trust force-enable<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>3.将自己制作的CA证书复制到<code>/etc/pki/ca-trust/source/anchors/</code>目录下</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost test]# cp /etc/pki/CA/cacert.crt /etc/pki/ca-trust/source/anchors/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>4.更新操作系统CA证书库</p><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost test]# update-ca-trust extract<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>5.更多的命令行参数及说明， 请查看: <code>man update-ca-trust</code></p><ul><li>最后验证下是否成功<pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">[root@localhost logs]# curl https://www.testvm.dev/index.phpsuccess<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="一点扩展知识"><a href="#一点扩展知识" class="headerlink" title="一点扩展知识"></a>一点扩展知识</h3><ul><li><p>我们在使用PHP开发程序时会使用到<code>file_get_contents</code>函数、<code>curl</code>库来获取https站点数据时，如果需要对证书做信任，那么就可以把自己制作的CA证书导入到操作系统中，然后就不需要手动指定证书参数或者修改 php.ini <code> openssl.cafile或openssl.capath</code>选项，就能很爽的直接<code>file_get_contents('https://www.testvm.dev/index.php')</code>来使用了。</p></li><li><p>注意导入证书后那些在导入证书前就已经运行的服务需要将相应服务重启后才能使用系统新的证书，例如重启<code>php-fpm</code></p></li></ul><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>如果是自己做的CA，浏览器要导入CA证书(导入CA证书，意味着将信任这个CA签署的所有证书)。而商业的ssl证书颁发机构如VeriSign、Wosign、StartSSL签发的证书，浏览器已经内置并信任了这些根证书。</li><li>如果对于一般的应用，管理员只需生成“证书请求”（后缀大多为.csr），它包含你的服务器名称(域名)和公钥，然后把这份请求交给诸如verisign等有CA服务公司，你的证书请求经验证后，CA用它的私钥签名，形成正式的证书发还给你。管理员再在web server上导入这个证书就行了。</li></ul><h2 id="一些坑"><a href="#一些坑" class="headerlink" title="一些坑"></a>一些坑</h2><ul><li>Chrome 58及以上版本要使用OpenSSL创建带有SAN(subjectAlternativeName，主题备用名称)的证书，不然chrome会报 <strong>NET::ERR_CERT_COMMON_NAME_INVALID</strong></li><li>生成证书时要使用<strong>sha256</strong>加密不然chrome会报弱的签名</li><li>注意浏览器缓存，<strong>cookie</strong></li></ul><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html">http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html</a></li><li><a href="http://apetec.com/support/generatesan-csr.htm">http://apetec.com/support/generatesan-csr.htm</a></li><li><a href="http://liaoph.com/openssl-san/">http://liaoph.com/openssl-san/</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>进程的守护神-daemontools</title>
      <link href="/2021/06/29/jin-cheng-de-shou-hu-shen-daemontools/"/>
      <url>/2021/06/29/jin-cheng-de-shou-hu-shen-daemontools/</url>
      
        <content type="html"><![CDATA[<h1 id="进程的守护神-daemontools"><a href="#进程的守护神-daemontools" class="headerlink" title="进程的守护神 - daemontools"></a>进程的守护神 - daemontools</h1><hr><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们在日常的开发中可能需要写一些<code>常驻内存的程序</code>，<code>常驻内存的程序</code>和<code>守护进程</code>程序是不一样的，<code>守护进程</code>的实现步骤稍微麻烦点，感兴趣的读者可以参考我用<code>C</code>实现的一个守护进程<a href="https://github.com/dendi875/APUE/blob/master/Chapter-13-Daemon%20Processes/daemonize.c">daemonize.c</a>，我们重点关注下<code>常驻内存的程序</code>，<br>以<code>PHP</code>为例来说<code>常驻内存的程序</code>实现一般是这样的：</p><p>首先使用<code>while (1) {}</code>结构使程序无限循环，并且在程序内部对各种可能出现的异常进行捕捉处理，目的是防止程序意外退出。</p><p>hello.php</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment">// dostuff();</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"hello, %d\n"</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// exception handling</span>    <span class="token punctuation">}</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接着，通过命令行把它放到后台执行，例如：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ nohup php hello.php &amp;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但这种实现方式是有一定的缺陷的，那就是当<code>PHP</code>执行过程中遇到错误的时候，就会退出程序，不官你程序中使用多少层<code>while (1) {}</code>，也不管你使用<code>try...catch</code>多少<code>Exception</code>，你还是阻止不了程序的意外退出（比如程序产生奇怪的<code>coredump</code>或者<code>kill</code>时手误杀错了程序）。如果这个常驻内存的程序是一个队列消费者程序，那么这种缺陷是很致命的，因为在流量高峰时如果程序一旦意外退出没有即时恢复，那么将导致队列中的消息一直堆积无法被消费掉，从而影响正常业务流程。再严重点，如果队列没有最大内存限制的策略，那么消息的堆积将会导致内存使用暴涨从而拖垮机器。怎么办？你可以用<code>crontab</code>脚本每分钟监视你的程序，看到没有在执行就启动起来。当然，还有更好的办法就是使用成熟的进程管理工具，它会监控你的程序，一旦发现进程退出了，立刻启动起来。<code>Linux</code>下对常驻内存的进程的管理通常使用<code>Daemontools</code>和<code>Supervisor</code> 这两个工具。今天我们就来研究学习下<code>Daemontools</code></p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><code>daemontools</code>是用于管理<code>UNIX</code>服务的工具的集合，它分为三类工具：</p><ul><li>常驻进程管理工具</li></ul><p><a href="http://cr.yp.to/daemontools/svscanboot.html">The svscanboot program</a></p><p><a href="http://cr.yp.to/daemontools/svscan.html">The svscan program</a></p><p><a href="http://cr.yp.to/daemontools/supervise.html">The supervise program</a></p><p><a href="http://cr.yp.to/daemontools/svc.html">The svc program</a></p><p><a href="http://cr.yp.to/daemontools/svok.html">The svok program</a></p><p><a href="http://cr.yp.to/daemontools/svstat.html">The svstat program</a></p><p><a href="http://cr.yp.to/daemontools/fghack.html">The fghack program</a></p><p><a href="http://cr.yp.to/daemontools/pgrphack.html">The pgrphack program</a></p><ul><li>日志管理工具</li></ul><p><a href="http://cr.yp.to/daemontools/readproctitle.html">The readproctitle program</a></p><p><a href="http://cr.yp.to/daemontools/multilog.html">The multilog program</a></p><p><a href="http://cr.yp.to/daemontools/tai64n.html">The tai64n program</a></p><p><a href="http://cr.yp.to/daemontools/tai64nlocal.html">The tai64nlocal program</a></p><ul><li>环境管理工具</li></ul><p><a href="http://cr.yp.to/daemontools/setuidgid.html">The setuidgid program</a></p><p><a href="http://cr.yp.to/daemontools/envuidgid.html">The envuidgid program</a></p><p><a href="http://cr.yp.to/daemontools/envdir.html">The envdir program</a></p><p><a href="http://cr.yp.to/daemontools/softlimit.html">The softlimit program</a></p><p><a href="http://cr.yp.to/daemontools/setlock.html">The setlock program</a></p><p>我们重点关注对常驻进程管理工具的使用，日志管理工具和环境管理工具主要是辅助进程管理做一些额外的功能，进程管理工具主要是通过<code>svscanboot</code>、<code>svscan</code>、<code>supervise</code>、<code>svc</code>、<code>svok</code>、<code>svstat</code>命令来管理常驻进程的</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ cd /usr/local/software/$ wget http://cr.yp.to/daemontools/daemontools-0.76.tar.gz$ tar -zxvf daemontools-0.76.tar.gz -C /usr/local/$ cd /usr/local/admin/daemontools-0.76/$ package/install<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果在<code>Linux</code>下安装出现如下错误：　</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">/usr/bin/ld: errno: TLS definition in /lib/libc.so.6 section .tbss mismatches non-TLS reference in envdir.o<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修复很简单将<em>admin/daemontools-0.76/src/error.h</em>中的<code>extern int errno;</code>替换为<code>include &lt;errno.h&gt;</code>之后再重新执行<code>package/install</code></p><p>安装完成之后，会创建<code>/service</code>和<code>/command</code>两个目录</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">/command/├── envdir -&gt; /usr/local/admin/daemontools/command/envdir├── envuidgid -&gt; /usr/local/admin/daemontools/command/envuidgid├── fghack -&gt; /usr/local/admin/daemontools/command/fghack├── multilog -&gt; /usr/local/admin/daemontools/command/multilog├── pgrphack -&gt; /usr/local/admin/daemontools/command/pgrphack├── readproctitle -&gt; /usr/local/admin/daemontools/command/readproctitle├── setlock -&gt; /usr/local/admin/daemontools/command/setlock├── setuidgid -&gt; /usr/local/admin/daemontools/command/setuidgid├── softlimit -&gt; /usr/local/admin/daemontools/command/softlimit├── supervise -&gt; /usr/local/admin/daemontools/command/supervise├── svc -&gt; /usr/local/admin/daemontools/command/svc├── svok -&gt; /usr/local/admin/daemontools/command/svok├── svscan -&gt; /usr/local/admin/daemontools/command/svscan├── svscanboot -&gt; /usr/local/admin/daemontools/command/svscanboot├── svstat -&gt; /usr/local/admin/daemontools/command/svstat├── tai64n -&gt; /usr/local/admin/daemontools/command/tai64n└── tai64nlocal -&gt; /usr/local/admin/daemontools/command/tai64nlocal<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动daemontools"><a href="#启动daemontools" class="headerlink" title="启动daemontools"></a>启动daemontools</h3><p>启动<code>svscanboot</code></p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># /command/svscanboot &amp;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>也可以设置开机启动，具体参考：</p><p><a href="http://cr.yp.to/daemontools/start.html">How to start daemontools</a></p><p>启动之后，查看进程，可以发现<code>svscan</code>做为<code>svscanboot</code>的子进程在运行</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># ps -ef | grep svroot      7547  5172  0 20:44 pts/0    00:00:00 /bin/sh /command/svscanbootroot      7549  7547  0 20:44 pts/0    00:00:00 svscan /service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="制作并测试你的脚本"><a href="#制作并测试你的脚本" class="headerlink" title="制作并测试你的脚本"></a>制作并测试你的脚本</h3><p>这步的主要目的就是在尝试把程序变为常驻内存进程之前，先确保它可以作为前台程序正常工作。如果脚本有误在前台都不能正常运行，那变为常驻程序后观察结果肯定是达不到预期的。比如我们制作了一个下面这样的<code>PHP</code>脚本</p><pre class="line-numbers language-php" data-language="php"><code class="language-php">cat /data1/www/test/php/process/hello.php#!/usr/bin/env php<span class="token php language-php"><span class="token delimiter important">&lt;?php</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"hello, %d\n"</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="构建-daemontools-Service"><a href="#构建-daemontools-Service" class="headerlink" title="构建 daemontools Service"></a>构建 daemontools Service</h3><p>我们把所有的服务统一放到<code>/scratch/service</code>（临时服务）目录下，服务的名称是任意的，比如我们称为<strong>hello</strong></p><p>创建 <code>/scratch/service</code> 目录</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># mkdir -p /scratch/service# cd /scratch/service/# mkdir hello# cd hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>创建一个<code>run</code>文件，其中包含：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">#!/bin/shexec 2&gt;&amp;1exec su - root -c "php /data1/www/test/php/process/hello.php" 1&gt;&gt; /data1/www/test/php/process/hello.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>赋予执行权限</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># chmod u+x run<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装<strong>hello</strong>服务并实际开始运行它</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># ln -s /scratch/service/hello/ /service/hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>注意：</strong> 上面的命令执行后正常情况下服务就已经开始运行了</p><p>打开另一个终端，验证程序是否正在运行</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">$ tail -f /data1/www/test/php/process/hello.loghello, 67hello, 68hello, 69hello, 70<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果<code>tail</code>命令未产生输出，请执行<code>svc -u hello</code>，虽然前面的命令如<code>/command/svscanboot &amp;</code>已经打开了服务，以防万一由于某种原因关闭了服务，而这本不应该被关闭。</p><pre class="line-numbers language-none"><code class="language-none"># pstree -a -p 7547svscanboot,7547 /command/svscanboot  ├─readproctitle,7550 service errors:...  └─svscan,7549 /service      └─supervise,7578 hello          └─su,7579 - root -c php\040/data1/www/test/php/process/hello.php              └─php,7580 /data1/www/test/php/process/hello.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们使用<code>pstree</code>命令查看进程树，可以看到<code>supervise</code>作为<code>svscan</code>的子进程在运行，<code>su</code>作为<code>supervise</code>的子进程在运行，最终执行的<code>php /data1/www/test/php/process/hello.php</code>又作为<code>su</code>的子进程在运行。</p><h3 id="操作和监视你的服务"><a href="#操作和监视你的服务" class="headerlink" title="操作和监视你的服务"></a>操作和监视你的服务</h3><ul><li>操作服务</li></ul><p>你可以使用<code>svc</code>命令来操作你的服务，可以使用<code>svstat</code>命令来监视你的服务。</p><p><code>svc</code>命令通过向守护进程发送信号来对其进行操作。该命令以<code>root</code>身份在<code>/service</code>目录中执行。例如：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># svc -d hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面的命令意思是关闭（<code>down</code>）或停止守护程序。下表是<code>svc</code>参数，它们的含义和信号的表：</p><table><thead><tr><th>Arg</th><th>Action</th><th>Signal</th></tr></thead><tbody><tr><td>-u</td><td>Start (up)</td><td>-</td></tr><tr><td>-d</td><td>Stop (down)</td><td>TERM, then CONT</td></tr><tr><td>-t</td><td>Restart if running</td><td>TERM</td></tr></tbody></table><p>有关该命令的其它参数，请参见： <a href="http://cr.yp.to/daemontools/svc.html">http://cr.yp.to/daemontools/svc.html</a></p><ul><li>监控服务</li></ul><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># svstat hellohello: up (pid 7917) 5 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>svstat</code>可以告诉我们以下信息</p><ol><li>服务目录的名称（hello）</li><li>当前状态（up or down）</li><li>进程<code>PID</code></li><li>处于当前状态的秒数</li></ol><h2 id="Daemontools-架构模型"><a href="#Daemontools-架构模型" class="headerlink" title="Daemontools 架构模型"></a>Daemontools 架构模型</h2><p><img src="https://cdn.jsdelivr.net/gh/dendi875/images/PicGo/daemontools.png" alt="daemontools"></p><p>上图的“Connector A: Service”实际上是服务的<code>run</code>脚本，或者是任何二进制可执行文件，<code>shell</code>脚本或<code>PHP/Python/Perl/Ruby/ Lua</code>脚本，它们都是通过<code>exec</code>命令为其分配了一个<code>PID</code>的运行脚本。</p><p>通过上图可以知道<code>daemontools</code>的工作方式，计算机首先初始化，然后系统引导运行<code>/command/svscanboot</code>，接着<code>/command/svscanboot</code>依次引导运行<code>/command/readproctitle</code>和<code>/command/svscan</code>。<code>/command/readproctitle </code>只是一个可以运行的调试工具。</p><p><code>svscan /service </code>是daemontools的一个最重要的机制，每五秒钟它会扫描<code>/service</code>目录（假设<code>/ service</code>是传递给<code>svscan</code>的命令行参数）以查找符号链接目录，并运行该符号连接目录中的<code>run</code>命令（如果尚未运行）</p><p><code>svscan</code>程序会永远一直循环，每次循环做两件事：</p><p>1）扫描<code>/service</code>查找所有符号链接目录</p><p>2）对于查找到的每个符号链接目录，如果该目录还未运行<code>supervise</code>程序，则在该目录上运行<code>supervise</code>程序</p><p><code>supervise</code>程序它基于我们监控的服务目录（如/service/hello）中的 supervise 目录树中的内容来运行和停止运行<code>run</code>脚本</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">tree /service/hello/supervise//service/hello/supervise/├── control├── lock├── ok└── status<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="基本故障排查"><a href="#基本故障排查" class="headerlink" title="基本故障排查"></a>基本故障排查</h2><p>对daemontools问题进行故障排除的第一步就是找出正在运行的东西和没有运行的东西，可以参照架构模型将范围一步步缩小。</p><p>下面几个<code>ps</code>命令，用于查看正在运行的和未运行的进程：</p><ul><li><p><code>ps -ef | grep sv</code>，查看<code>svscanboot</code>和<code>svscan</code>是否正常在运行</p></li><li><p><code># ps -ef | grep supervise</code>，查看<code>supervise </code>是否在正常运行</p></li><li><p><code>ps ax | grep myprogram</code>，查看你<code>run</code>命令中执行的程序是否在运行，例如，在前面的救命中，它是 <code>hello.php</code></p></li></ul><h2 id="正确的卸载服务"><a href="#正确的卸载服务" class="headerlink" title="正确的卸载服务"></a>正确的卸载服务</h2><p>卸载服务指的不仅仅是停止它，而是停止使用服务。正确的执行步骤如下：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># cd /service/hello/# rm -rf /service/hello# svc -dx .<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>注意：</strong> 是首先<code>cd</code>到服务目录下，再使用<strong>绝对路径</strong>删除软链接，最后在执行<code>svc -dx .</code></p><p>验证是否卸载成功：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># ps -ef | grep hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>还有一种终极大招来卸载服务，那就是关闭服务并杀死正在运行所有的守护进程和其子进程。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><p><a href="http://cr.yp.to/daemontools.html">Daemontools</a></p></li><li><p><a href="http://cr.yp.to/daemontools/faq/create.html">FAQ of daemontools</a></p></li><li><p><a href="http://www.troubleshooters.com/linux/djbdns/daemontools_intro.htm">daemontools_intro</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 四种事务隔离级别说明</title>
      <link href="/2021/06/29/mysql-si-chong-shi-wu-ge-chi-ji-bie-shuo-ming/"/>
      <url>/2021/06/29/mysql-si-chong-shi-wu-ge-chi-ji-bie-shuo-ming/</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL-四种事务隔离级别说明"><a href="#MySQL-四种事务隔离级别说明" class="headerlink" title="MySQL 四种事务隔离级别说明"></a>MySQL 四种事务隔离级别说明</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在 <code>MySQL</code> 中，为了保证并发读取数据的正确性，提出了四种事务隔离级别，下面我们就说明如何设置隔离级别，以及用示例来说明每种隔离级别的使用情况</p><h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><h3 id="设置隔离级别"><a href="#设置隔离级别" class="headerlink" title="设置隔离级别"></a>设置隔离级别</h3><p>你可以在 <code>MySQL</code> 配置文件 <code>my.cnf</code> 的 <code>[mysqld]</code>节中设置如下选项来为所有连接设置默认的隔离级别</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[mysqld]transaction-isolation = {READ-UNCOMMITTED | READ-COMMITTED | REPEATABLE-READ | SERIALIZABLE}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果未设置此选项，则 <code>InnoDB</code>默认是可重复读（<code>REPEATABLE-READ</code>）。</p><p>你也可以用 <code>set session</code>语句来改变单个会话或所有新进来连接的隔离级别。</p><p>语法如下：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">set [session | global] transaction isolation level {read uncommitted | read committed | repeatable read | serializable}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>如果使用 <code>global</code> 关键字，则表示在全局（多个 session中）对从那点开始创建的所有连接设置默认事务级别</li><li>如果使用 <code>session</code>关键字，则表示为将来在当前连接上执行的所有事务设置默认事务级别</li><li>不带<code>global</code>和<code>session</code>是为下一个（未开始）事务设置隔离级别</li></ul><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">set session transaction isolation level read uncommitted;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>上面的命令表示：为接下来在当前会话连接上执行的所有事务设置读未提交隔离级别</p><p>注意：使用<code>set</code> 命令来设置隔离级别的方式在 <code>MySQL</code> 重启后会恢复到配置文件中设置的隔离级别</p><h3 id="查询隔离级别"><a href="#查询隔离级别" class="headerlink" title="查询隔离级别"></a>查询隔离级别</h3><ul><li>查询全局的隔离级别</li></ul><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">select @@global.tx_isolation;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查询一个会话的隔离级别</li></ul><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">select @@session.tx_isolation;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查询一个事务的隔离级别</li></ul><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">select @@tx_isolation;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="四种隔离级别的示例"><a href="#四种隔离级别的示例" class="headerlink" title="四种隔离级别的示例"></a>四种隔离级别的示例</h3><ol><li>各隔离级别会再现的问题</li></ol><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th></tr></thead><tbody><tr><td>读未提交</td><td>可能</td><td>可能</td><td>可能</td></tr><tr><td>读已提交</td><td>不可能</td><td>可能</td><td>可能</td></tr><tr><td>可重复读</td><td>不可能</td><td>不可能</td><td>可能</td></tr><tr><td>可串行化</td><td>不可能</td><td>不可能</td><td>不可能</td></tr></tbody></table><ul><li>读未提交：该隔离级别下可能会出现 <strong>脏读</strong>，也就是可能会读取到其它会话中修改了但还未提交的数据</li><li>读已提交：该隔离级别解决了脏读问题，但可能会出现<strong>不可重复读</strong></li><li>可重复读： 该隔离级别解决了不可重复读问题，但可能会出现<strong>幻读</strong></li><li>可串行化：该隔离级别解决了幻读问题，它是完全串行化的读，每次读都需要获得表级共享锁，读写相互都会阻塞</li></ul><ol start="2"><li>示例来说明每种隔离级别的使用情况</li></ol><p>准备一张测试表，插入一些测试数据，然后开启两个<code>MySQL</code>终端，在此命令为<code>session1</code>和<code>session2</code></p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">CREATE TABLE `goods` (  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,  `name` varchar(45) NOT NULL DEFAULT '' COMMENT '商品名称',  `stock` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '库存',  PRIMARY KEY (`id`),  UNIQUE KEY `uk_name` (`name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品';insert into `goods` (`name`, `stock`) values ('p1', '1000'),('p2', '1000'),('p3', '1000'),('p4', '1000'),('p5', '1000'),('p6', '1000'),('p7', '1000'),('p8', '1000'),('p9', '1000');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a>脏读</h4><p>脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。</p><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">// 关闭自动提交，设置隔离级别为读未提交mysql&gt; set autocommit=0;mysql&gt; set session transaction isolation level read uncommitted;// 确认mysql&gt; show variables like '%autocommit%';+---------------+-------+| Variable_name | Value |+---------------+-------+| autocommit    | OFF   |+---------------+-------+mysql&gt; select @@session.tx_isolation;+------------------------+| @@session.tx_isolation |+------------------------+| READ-UNCOMMITTED       |+------------------------+// 开启事务，查询 id = 1 的记录mysql&gt; start transaction;mysql&gt; select * from goods where id=1;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |  1000 |+----+------+-------+1 row in set (0.01 sec)mysql&gt; select * from goods where id=1;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |  1000 |+----+------+-------+1 row in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>session2：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; set autocommit=0;mysql&gt; set session transaction isolation level read uncommitted;// 确认// 开启事务，把 id = 1记录的库存更新至 1mysql&gt; start transaction;Query OK, 0 rows affected (0.00 sec)mysql&gt; select * from goods where id=1;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |  1000 |+----+------+-------+1 row in set (0.00 sec)mysql&gt; update goods set stock=1 where id=1;Query OK, 1 row affected (0.00 sec)Rows matched: 1  Changed: 1  Warnings: 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; select * from goods where id=1; +----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |     1 |+----+------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意：</strong> 这时 session1 读取到了 session2 未提交的内容，如果 session2 回滚刚才更新的数据，session1 读取到的数据就是错误的</p><h4 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h4><p>事务一一直读，事务二修改数据并提交，有可能就会出现事务一内两次读取到的数据不一样</p><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">// 取消自动提交，并设置隔离级别为读已提交mysql&gt; set autocommit=0;mysql&gt; set session transaction isolation level read committed;// 确认mysql&gt; select @@session.tx_isolation;+------------------------+| @@session.tx_isolation |+------------------------+| READ-COMMITTED         |+------------------------+// 开启事务，查询 id=1 的记录mysql&gt; start transaction;Query OK, 0 rows affected (0.00 sec)mysql&gt; select * from goods where id=1;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |  1000 |+----+------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>session2：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">// 取消自动提交，并设置隔离级别为读已提交mysql&gt; set autocommit=0;mysql&gt; set session transaction isolation level read committed;// 确认mysql&gt; select @@session.tx_isolation;+------------------------+| @@session.tx_isolation |+------------------------+| READ-COMMITTED         |+------------------------+mysql&gt; start transaction;mysql&gt; select * from goods where id=1;mysql&gt; update goods set stock=1 where id=1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这时返回到 session1</p><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; select * from goods where id=1;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |  1000 |+----+------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以观察到在读已提交的隔离级别下，session1 没出现<strong>脏读</strong>。</p><p>继续返回到 session2 执行手动提交</p><p>session2：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; commit;Query OK, 0 rows affected (0.01 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>再返回到 session1 查看 id = 1的记录</p><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; select * from goods where id=1;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |     1 |+----+------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意：</strong> 在 session2 提交后，session1 连接两次读取到的数据不一致了，这就是<strong>读已提交隔离级别可能会出现不可重复读的情况</strong></p><p>在演示幻读之前，我们先演示下<strong>可重复读</strong></p><h4 id="可重复读"><a href="#可重复读" class="headerlink" title="可重复读"></a>可重复读</h4><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; set autocommit=0;mysql&gt; set session transaction isolation level repeatable read;mysql&gt; select @@session.tx_isolation;+------------------------+| @@session.tx_isolation |+------------------------+| REPEATABLE-READ        |+------------------------+mysql&gt; select * from goods where id=1;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |  1000 |+----+------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>session2：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; set autocommit=0;mysql&gt; set session transaction isolation level repeatable read;mysql&gt; select @@session.tx_isolation;+------------------------+| @@session.tx_isolation |+------------------------+| REPEATABLE-READ        |+------------------------+mysql&gt; start transaction;Query OK, 0 rows affected (0.00 sec)mysql&gt; select * from goods where id=1;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |  1000 |+----+------+-------+1 row in set (0.00 sec)mysql&gt; update goods set stock=1 where id=1;Query OK, 1 row affected (0.00 sec)Rows matched: 1  Changed: 1  Warnings: 0mysql&gt;  commit;Query OK, 0 rows affected (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再返回到 session1 查询 id=1 的记录</p><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; select * from goods where id=1;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |  1000 |+----+------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以观察到<strong>在可重复读隔离级别下</strong>，session1 连续多次读取的数据是一致的，也就是它是可重复读的</p><h4 id="幻读"><a href="#幻读" class="headerlink" title="幻读"></a>幻读</h4><p>两个事务彼此隔离，互相并不知道对方操作了什么，当第一个事务插入了一条数据并提交后，因为隔离级别是可重复读，在第二个事务里并不知道第一个事务已经插入了数据，所以第二个事务查询出来的数据还是没插入之前的，这时第二个事务再次插入数据时就可能会报数据已存在，以为自己出现了幻觉</p><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; set autocommit=0;mysql&gt; set session transaction isolation level repeatable read;// 开启事务，插入数据并提交mysql&gt; start transaction;Query OK, 0 rows affected (0.00 sec)mysql&gt; select * from goods;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |     1 ||  2 | p2   |  1000 ||  3 | p3   |  1000 ||  4 | p4   |  1000 ||  5 | p5   |  1000 ||  6 | p6   |  1000 ||  7 | p7   |  1000 ||  8 | p8   |  1000 ||  9 | p9   |  1000 |+----+------+-------+9 rows in set (0.00 sec)mysql&gt; insert into goods(`name`,`stock`) values('p10', 1000);      Query OK, 1 row affected (0.00 sec)mysql&gt; commit;Query OK, 0 rows affected (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>切换到 session2 </p><p>session2：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; set autocommit=0;mysql&gt; set session transaction isolation level repeatable read;// 开启事务，查询后再插入mysql&gt; start transaction;mysql&gt; select * from goods;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |     1 ||  2 | p2   |  1000 ||  3 | p3   |  1000 ||  4 | p4   |  1000 ||  5 | p5   |  1000 ||  6 | p6   |  1000 ||  7 | p7   |  1000 ||  8 | p8   |  1000 ||  9 | p9   |  1000 |+----+------+-------+9 rows in set (0.00 sec)mysql&gt; insert into goods(`name`, `stock`) values('p10', 1000);     ERROR 1062 (23000): Duplicate entry 'p10' for key 'uk_name'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="SERIALIZABLE（可串行化）"><a href="#SERIALIZABLE（可串行化）" class="headerlink" title="SERIALIZABLE（可串行化）"></a>SERIALIZABLE（可串行化）</h4><p>在该隔离级别下事务都是串行顺序执行的，<code>MySQL</code> 数据库的 <code>InnoDB</code> 引擎会给读操作隐式加一把读共享锁，从而避免了脏读、不可重读复读和幻读问题。</p><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; set autocommit=0;Query OK, 0 rows affected (0.00 sec)mysql&gt; set session transaction isolation level serializable;Query OK, 0 rows affected (0.00 sec)mysql&gt; select @@session.tx_isolation;+------------------------+| @@session.tx_isolation |+------------------------+| SERIALIZABLE           |+------------------------+1 row in set (0.00 sec)// 开启一个事务，插入一条数据但不提交mysql&gt; start transaction;Query OK, 0 rows affected (0.00 sec)mysql&gt; insert into goods(`name`, `stock`) values('p10', 1000); Query OK, 1 row affected (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>切换到 session2 ，开启一个事务然后查询数据</p><p>session2：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; set autocommit=0;Query OK, 0 rows affected (0.00 sec)mysql&gt; set session transaction isolation level serializable;Query OK, 0 rows affected (0.00 sec)mysql&gt; select @@session.tx_isolation;+------------------------+| @@session.tx_isolation |+------------------------+| SERIALIZABLE           |+------------------------+1 row in set (0.00 sec)mysql&gt; select * from goods; // 些时会一直卡住<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>立马切换到 session1，提交事务</p><p>session1：</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; commit;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>再切换到 session2</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; select * from goods;+----+------+-------+| id | name | stock |+----+------+-------+|  1 | p1   |  1000 ||  2 | p2   |  1000 ||  3 | p3   |  1000 ||  4 | p4   |  1000 ||  5 | p5   |  1000 ||  6 | p6   |  1000 ||  7 | p7   |  1000 ||  8 | p8   |  1000 ||  9 | p9   |  1000 || 10 | p10  |  1000 |+----+------+-------+10 rows in set (1.12 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>session2 也有可能获取锁超时</p><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">mysql&gt; select * from goods;ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>注意：</strong>　一旦事务提交，session2 会立马返回插入的记录，否则会一直卡住，直到超时，其中超时参数是由 <code>innodb_lock_wait_timeout</code> 控制。由于每条 <code>select</code>语句都会加锁，所以该隔离级别的数据库并发能力最弱</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>四个级别逐渐增强，每个级别解决一个问题。事务级别越高，性能越差。<code>InnoDB</code>默认级别是可重复读。 </p>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
